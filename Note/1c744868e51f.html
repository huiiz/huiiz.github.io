<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>æ“ä½œç³»ç»Ÿ from è’‹ç‚å²©nju2023 | HUII's Blog</title><meta name="author" content="HUII"><meta name="copyright" content="HUII"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="æ³¨æ„ï¼šæœ¬é¡µé¢åœæ­¢æ›´æ–°ï¼Œåç»­å†…å®¹æ›´æ–°åœ¨æˆ‘çš„notionç¬”è®°ï¼šæ“ä½œç³»ç»Ÿ (notion.site)  2023å¹´6æœˆ29æ—¥ï¼Œby:HUII æ¦‚è¿° æœ¬è¯¾ç¨‹æ¥æºäºå—äº¬å¤§å­¦è®¡ç®—æœºè½¯ä»¶ç ”ç©¶æ‰€çš„jyyè€å¸ˆã€‚ç»¿å¯¼å¸ˆåŸè°…ä½ äº†çš„ä¸ªäººç©ºé—´_å“”å“©å“”å“©_bilibili è¯¾ç¨‹èµ„æ–™å®˜ç½‘ï¼šæ“ä½œç³»ç»Ÿï¼šè®¾è®¡ä¸å®ç° (2023 æ˜¥å­£å­¦æœŸ) (jyywiki.cn) æ“ä½œç³»ç»Ÿè¯¾ç¨‹ å»å¹´ï¼ˆ2022ï¼‰å°±å°è¯•çœ‹å®Œjyyè€å¸ˆçš„è¯¾ç¨‹ï¼Œä½†æœ€ç»ˆæ²¡èƒ½">
<meta property="og:type" content="article">
<meta property="og:title" content="æ“ä½œç³»ç»Ÿ from è’‹ç‚å²©nju2023">
<meta property="og:url" content="https://blog.huii.top/Note/1c744868e51f.html">
<meta property="og:site_name" content="HUII&#39;s Blog">
<meta property="og:description" content="æ³¨æ„ï¼šæœ¬é¡µé¢åœæ­¢æ›´æ–°ï¼Œåç»­å†…å®¹æ›´æ–°åœ¨æˆ‘çš„notionç¬”è®°ï¼šæ“ä½œç³»ç»Ÿ (notion.site)  2023å¹´6æœˆ29æ—¥ï¼Œby:HUII æ¦‚è¿° æœ¬è¯¾ç¨‹æ¥æºäºå—äº¬å¤§å­¦è®¡ç®—æœºè½¯ä»¶ç ”ç©¶æ‰€çš„jyyè€å¸ˆã€‚ç»¿å¯¼å¸ˆåŸè°…ä½ äº†çš„ä¸ªäººç©ºé—´_å“”å“©å“”å“©_bilibili è¯¾ç¨‹èµ„æ–™å®˜ç½‘ï¼šæ“ä½œç³»ç»Ÿï¼šè®¾è®¡ä¸å®ç° (2023 æ˜¥å­£å­¦æœŸ) (jyywiki.cn) æ“ä½œç³»ç»Ÿè¯¾ç¨‹ å»å¹´ï¼ˆ2022ï¼‰å°±å°è¯•çœ‹å®Œjyyè€å¸ˆçš„è¯¾ç¨‹ï¼Œä½†æœ€ç»ˆæ²¡èƒ½">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.huii.top/img/image-8.png">
<meta property="article:published_time" content="2023-02-14T13:58:00.000Z">
<meta property="article:modified_time" content="2023-10-06T02:24:16.516Z">
<meta property="article:author" content="HUII">
<meta property="article:tag" content="æ“ä½œç³»ç»Ÿ">
<meta property="article:tag" content="OS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.huii.top/img/image-8.png"><link rel="shortcut icon" href="/img/logo.png"><link rel="canonical" href="https://blog.huii.top/Note/1c744868e51f.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: {"limitDay":128,"position":"top","messagePrev":"æœ¬æ–‡æœ€åæ›´æ–°äº","messageNext":"å¤©å‰ï¼Œå…¶ä¸­çš„ä¿¡æ¯å¯èƒ½å·²ç»æœ‰æ‰€å‘å±•æˆ–æ˜¯å‘ç”Ÿæ”¹å˜ã€‚"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'å¤©',
  dateSuffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: {"limitCount":50,"languages":{"author":"ä½œè€…: HUII","link":"é“¾æ¥: ","source":"æ¥æº: HUII's Blog","info":"è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'æ“ä½œç³»ç»Ÿ from è’‹ç‚å²©nju2023',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-10-06 10:24:16'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">36</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">41</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">4</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ–‡ç« å½’æ¡£</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾äº‘</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/image-8.png')"><nav id="nav"><span id="blog-info"><a href="/" title="HUII's Blog"><img class="site-icon" src="/img/logo.png"/><span class="site-name">HUII's Blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ–‡ç« å½’æ¡£</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾äº‘</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">æ“ä½œç³»ç»Ÿ from è’‹ç‚å²©nju2023</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2023-02-14T13:58:00.000Z" title="å‘è¡¨äº 2023-02-14 21:58:00">2023-02-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2023-10-06T02:24:16.516Z" title="æ›´æ–°äº 2023-10-06 10:24:16">2023-10-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Note/">Note</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="æ“ä½œç³»ç»Ÿ from è’‹ç‚å²©nju2023"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>æ³¨æ„ï¼šæœ¬é¡µé¢åœæ­¢æ›´æ–°ï¼Œåç»­å†…å®¹æ›´æ–°åœ¨æˆ‘çš„notionç¬”è®°ï¼š<a target="_blank" rel="noopener" href="https://zhuii.notion.site/zhuii/9e6aec0d43eb417eb695779716d8bda6">æ“ä½œç³»ç»Ÿ (notion.site)</a> </p>
<p>2023å¹´6æœˆ29æ—¥ï¼Œby:HUII</p>
<p><strong>æ¦‚è¿°</strong></p>
<p>æœ¬è¯¾ç¨‹æ¥æºäºå—äº¬å¤§å­¦<a target="_blank" rel="noopener" href="http://ics.nju.edu.cn/">è®¡ç®—æœºè½¯ä»¶ç ”ç©¶æ‰€</a>çš„jyyè€å¸ˆã€‚<a target="_blank" rel="noopener" href="https://space.bilibili.com/202224425">ç»¿å¯¼å¸ˆåŸè°…ä½ äº†çš„ä¸ªäººç©ºé—´_å“”å“©å“”å“©_bilibili</a></p>
<p>è¯¾ç¨‹èµ„æ–™å®˜ç½‘ï¼š<a target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2023/">æ“ä½œç³»ç»Ÿï¼šè®¾è®¡ä¸å®ç° (2023 æ˜¥å­£å­¦æœŸ) (jyywiki.cn)</a></p>
<p><img src="../img/image-8.png" alt="img">æ“ä½œç³»ç»Ÿè¯¾ç¨‹</p>
<p>å»å¹´ï¼ˆ2022ï¼‰å°±å°è¯•çœ‹å®Œjyyè€å¸ˆçš„è¯¾ç¨‹ï¼Œä½†æœ€ç»ˆæ²¡èƒ½æˆåŠŸğŸ˜…ï¼Œå¸Œæœ›ä»Šå¹´èƒ½å¤Ÿå°½é‡è·Ÿä¸Šjyyè€å¸ˆçš„è¿›åº¦ã€‚</p>
<hr>
<p>å¤±è´¥äº†</p>
<h1 id="ç»ªè®º1-æ“ä½œç³»ç»Ÿæ¦‚è¿°-2023-2-14"><a href="#ç»ªè®º1-æ“ä½œç³»ç»Ÿæ¦‚è¿°-2023-2-14" class="headerlink" title="ç»ªè®º1_æ“ä½œç³»ç»Ÿæ¦‚è¿°_2023.2.14"></a>ç»ªè®º1_æ“ä½œç³»ç»Ÿæ¦‚è¿°_2023.2.14</h1><iframe src="https://jyywiki.cn/OS/2023/build/lect1.ipynb.html" width="100%" height="600"></iframe>

<h2 id="Whyä¸ºä»€ä¹ˆå­¦æ“ä½œç³»ç»Ÿ"><a href="#Whyä¸ºä»€ä¹ˆå­¦æ“ä½œç³»ç»Ÿ" class="headerlink" title="Whyä¸ºä»€ä¹ˆå­¦æ“ä½œç³»ç»Ÿ"></a>Whyä¸ºä»€ä¹ˆå­¦æ“ä½œç³»ç»Ÿ</h2><ul>
<li>è§‰é†’ä½“å†…â€œç¼–ç¨‹èƒ½åŠ›â€</li>
<li>è¡¥å®Œç¼–ç¨‹æŠ€èƒ½ä½“ç³»</li>
</ul>
<h2 id="Whatä»€ä¹ˆæ˜¯æ“ä½œç³»ç»Ÿ"><a href="#Whatä»€ä¹ˆæ˜¯æ“ä½œç³»ç»Ÿ" class="headerlink" title="Whatä»€ä¹ˆæ˜¯æ“ä½œç³»ç»Ÿ"></a>Whatä»€ä¹ˆæ˜¯æ“ä½œç³»ç»Ÿ</h2><blockquote>
<p>Operating System: A body of software, in fact, that is responsible for <em>making it easy to run programs</em> (even allowing you to seemingly run many at the same time), allowing programs to share memory, enabling programs to interact with devices, and other fun stuff like that. (OSTEP)</p>
</blockquote>
<p>è®©ç¨‹åºå¯ä»¥ä¸å…¶å®ƒç¨‹åºä»¥åŠç¡¬ä»¶äº¤äº’</p>
<p><img src="../img/image-10-16965174394544.png" alt="img">ä»€ä¹ˆæ˜¯æ“ä½œç³»ç»Ÿ</p>
<p>æ“ä½œç³»ç»Ÿï¼šç¡¬ä»¶å’Œè½¯ä»¶çš„ä¸­é—´å±‚</p>
<p><img src="../img/image-11-1024x491.png" alt="img">Fortranå¡ç‰‡</p>
<p>å†å²ï¼š</p>
<ul>
<li><p>ENIAC: 1946.2.14</p>
</li>
<li><p>1940s</p>
<ul>
<li>ç¡¬ä»¶<ul>
<li>é€»è¾‘é—¨ï¼š<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/av59005720">çœŸç©ºç”µå­ç®¡</a></li>
<li>å­˜å‚¨å™¨ï¼šå»¶è¿Ÿçº¿ (delay lines)</li>
<li>è¾“å…¥/è¾“å‡ºï¼šæ‰“å­”çº¸å¸¦/æŒ‡ç¤ºç¯</li>
</ul>
</li>
<li><p>è½¯ä»¶ï¼šæ‰“å°å¹³æ–¹æ•°ã€ç´ æ•°è¡¨ã€è®¡ç®—å¼¹é“â€¦â€¦</p>
</li>
<li><p>æ“ä½œç³»ç»Ÿï¼šæ²¡æœ‰</p>
<ul>
<li>ç¨‹åºç›´æ¥ç”¨æŒ‡ä»¤æ“ä½œç¡¬ä»¶</li>
<li>ä¸éœ€è¦ç”»è›‡æ·»è¶³çš„ç¨‹åºæ¥ç®¡ç†å®ƒ</li>
</ul>
</li>
</ul>
</li>
<li><p>1950s</p>
<ul>
<li>ç¡¬ä»¶ï¼šæ›´å¿«æ›´å°çš„é€»è¾‘é—¨ (æ™¶ä½“ç®¡)ã€æ›´å¤§çš„å†…å­˜ (ç£èŠ¯)ã€ä¸°å¯Œçš„ I/O è®¾å¤‡<ul>
<li>I/O è®¾å¤‡çš„é€Ÿåº¦å·²ç»ä¸¥é‡ä½äºå¤„ç†å™¨çš„é€Ÿåº¦ï¼Œä¸­æ–­æœºåˆ¶å‡ºç° (1953)</li>
</ul>
</li>
<li>è½¯ä»¶ï¼šæ›´å¤æ‚çš„é€šç”¨çš„æ•°å€¼è®¡ç®—ã€‚è‡ªç„¶ç§‘å­¦ã€å·¥ç¨‹æœºæ¢°ã€å†›äº‹â€¦â€¦å¯¹è®¡ç®—æœºçš„éœ€æ±‚æš´æ¶¨<ul>
<li>é«˜çº§è¯­è¨€å’Œ API è¯ç”Ÿ (Fortran, 1957)ï¼šä¸€è¡Œä»£ç ï¼Œä¸€å¼ å¡ç‰‡</li>
<li>80 è¡Œçš„è§„èŒƒæ²¿ç”¨è‡³ä»Š (ç»†èŠ‚ï¼šæ‰“å°æœºä¼šå°åˆ·æœ¬è¡Œä»£ç )</li>
</ul>
</li>
<li>æ“ä½œç³»ç»Ÿï¼šåº“å‡½æ•° + ç®¡ç†ç¨‹åºæ’é˜Ÿè¿è¡Œçš„è°ƒåº¦ä»£ç ã€‚<ul>
<li>å†™ç¨‹åº (æˆ³çº¸å¸¦)ã€è·‘ç¨‹åºéƒ½æ˜¯éå¸¸è´¹äº‹çš„<ul>
<li>è®¡ç®—æœºéå¸¸è´µ ($50,000âˆ’$1,000,000$50,000âˆ’$1,000,000)ï¼Œä¸€ä¸ªå­¦æ ¡åªæœ‰ä¸€å°</li>
<li>ç®—åŠ›æˆä¸ºä¸€ç§æœåŠ¡ï¼šå¤šç”¨æˆ·è½®æµå…±äº«è®¡ç®—æœºï¼Œoperator è´Ÿè´£è°ƒåº¦</li>
</ul>
</li>
<li>æ“ä½œ (operate) ä»»åŠ¡ (jobs) çš„ç³»ç»Ÿ (system)<ul>
<li>â€œæ‰¹å¤„ç†ç³»ç»Ÿâ€ = ç¨‹åºçš„è‡ªåŠ¨åˆ‡æ¢ (æ¢å¡) + åº“å‡½æ•° API</li>
<li>Disk Operating Systems (DOS)<ul>
<li>æ“ä½œç³»ç»Ÿä¸­å¼€å§‹å‡ºç° â€œè®¾å¤‡â€ã€â€œæ–‡ä»¶â€ã€â€œä»»åŠ¡â€ ç­‰å¯¹è±¡å’Œ API</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>1960s</p>
<ul>
<li>ç¡¬ä»¶ï¼šé›†æˆç”µè·¯ã€æ€»çº¿å‡ºç°<ul>
<li>æ›´å¿«çš„å¤„ç†å™¨</li>
<li>æ›´å¿«ã€æ›´å¤§çš„å†…å­˜ï¼›è™šæ‹Ÿå­˜å‚¨å‡ºç°<ul>
<li>å¯ä»¥åŒæ—¶è½½å…¥å¤šä¸ªç¨‹åºè€Œä¸ç”¨ â€œæ¢å¡â€ äº†</li>
</ul>
</li>
<li>æ›´ä¸°å¯Œçš„ I/O è®¾å¤‡ï¼›å®Œå–„çš„ä¸­æ–­/å¼‚å¸¸æœºåˆ¶</li>
</ul>
</li>
<li>è½¯ä»¶ï¼šæ›´å¤šçš„é«˜çº§è¯­è¨€å’Œç¼–è¯‘å™¨å‡ºç°<ul>
<li>COBOL (1960), APL (1962), BASIC (1965)<ul>
<li>Bill Gates å’Œ Paul Allen åœ¨ 1975 å¹´å®ç°äº† Altair 8800 ä¸Šçš„ BASIC è§£é‡Šå™¨</li>
</ul>
</li>
</ul>
</li>
<li>æ“ä½œç³»ç»Ÿï¼šèƒ½è½½å…¥å¤šä¸ªç¨‹åºåˆ°å†…å­˜ä¸”è°ƒåº¦å®ƒä»¬çš„ç®¡ç†ç¨‹åºã€‚<ul>
<li>ä¸ºé˜²æ­¢ç¨‹åºä¹‹é—´å½¢æˆå¹²æ‰°ï¼Œæ“ä½œç³»ç»Ÿè‡ªç„¶åœ°å°†å…±äº«èµ„æº (å¦‚è®¾å¤‡) ä»¥ API å½¢å¼ç®¡ç†èµ·æ¥<ul>
<li>æœ‰äº†è¿›ç¨‹ (process) çš„æ¦‚å¿µ</li>
<li>è¿›ç¨‹åœ¨æ‰§è¡Œ I/O æ—¶ï¼Œå¯ä»¥å°† CPU è®©ç»™å¦ä¸€ä¸ªè¿›ç¨‹<ul>
<li>åœ¨å¤šä¸ªåœ°å€ç©ºé—´éš”ç¦»çš„ç¨‹åºä¹‹é—´åˆ‡æ¢</li>
<li>è™šæ‹Ÿå­˜å‚¨ä½¿ä¸€ä¸ªç¨‹åºå‡º bug ä¸ä¼š crash æ•´ä¸ªç³»ç»Ÿ</li>
</ul>
</li>
</ul>
</li>
<li>æ“ä½œç³»ç»Ÿä¸­è‡ªç„¶åœ°å¢åŠ è¿›ç¨‹ç®¡ç† API<ul>
<li>æ—¢ç„¶å¯ä»¥åœ¨ç¨‹åºä¹‹é—´åˆ‡æ¢ï¼Œä¸ºä»€ä¹ˆä¸è®©å®ƒä»¬å®šæ—¶åˆ‡æ¢å‘¢ï¼Ÿ</li>
<li>Multics (MIT, 1965)ï¼šç°ä»£åˆ†æ—¶æ“ä½œç³»ç»Ÿè¯ç”Ÿ</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>1970s+</p>
<ul>
<li>ç¡¬ä»¶ï¼šé›†æˆç”µè·¯ç©ºå‰å‘å±•ï¼Œä¸ªäººç”µè„‘å…´èµ·ï¼Œâ€œè®¡ç®—æœºâ€ å·²ä¸ä»Šæ—¥æ— å¤§å¼‚<ul>
<li>CISC æŒ‡ä»¤é›†ï¼›ä¸­æ–­ã€I/Oã€å¼‚å¸¸ã€MMUã€ç½‘ç»œ</li>
<li>ä¸ªäººè®¡ç®—æœº (PC æœº)ã€è¶…çº§è®¡ç®—æœºâ€¦â€¦</li>
</ul>
</li>
<li>è½¯ä»¶<ul>
<li>PASCAL (1970), C (1972), â€¦</li>
<li>ä»Šå¤©èƒ½åŠåˆ°çš„ï¼Œé‚£ä¸ªæ—¶ä»£å·²ç»éƒ½èƒ½åŠåˆ°äº†â€”â€”ä¸Šå¤©å…¥åœ°ã€å›¾åƒå£°éŸ³è§†é¢‘ã€äººå·¥æ™ºèƒ½â€¦â€¦</li>
<li>ä¸ªäººå¼€å‘è€… (Geek Network) èµ°ä¸Šèˆå°</li>
</ul>
</li>
<li>æ“ä½œç³»ç»Ÿï¼šåˆ†æ—¶ç³»ç»Ÿèµ°å‘æˆç†Ÿï¼ŒUNIX è¯ç”Ÿå¹¶èµ°å‘å®Œå–„ï¼Œå¥ å®šäº†ç°ä»£æ“ä½œç³»ç»Ÿçš„å½¢æ€ã€‚<ul>
<li>1973: ä¿¡å· APIã€ç®¡é“ (å¯¹è±¡)ã€grep (åº”ç”¨ç¨‹åº)</li>
<li>1983: BSD socket (å¯¹è±¡)</li>
<li>1984: procfs (å¯¹è±¡)â€¦â€¦</li>
<li>UNIX è¡ç”Ÿå‡ºçš„å¤§å®¶æ—<ul>
<li>1BSD (1977), GNU (1983), MacOS (1984), AIX (1986), Minix (1987), Windows (1985), Linux 0.01 (1991), Windows NT (1993), Debian (1996), Windows XP (2002), Ubuntu (2004), iOS (2007), Android (2008), Windows 10 (2015), â€¦â€¦</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>ä»Šå¤©çš„æ“ä½œç³»ç»Ÿ</p>
<ul>
<li>é€šè¿‡ â€œè™šæ‹ŸåŒ–â€ ç¡¬ä»¶èµ„æºä¸ºç¨‹åºè¿è¡Œæä¾›æœåŠ¡çš„è½¯ä»¶ã€‚</li>
</ul>
</li>
</ul>
<h2 id="Howæ€æ ·å­¦æ“ä½œç³»ç»Ÿ"><a href="#Howæ€æ ·å­¦æ“ä½œç³»ç»Ÿ" class="headerlink" title="Howæ€æ ·å­¦æ“ä½œç³»ç»Ÿ"></a>Howæ€æ ·å­¦æ“ä½œç³»ç»Ÿ</h2><h2 id="è¯¾ç¨‹ä»£ç "><a href="#è¯¾ç¨‹ä»£ç " class="headerlink" title="è¯¾ç¨‹ä»£ç "></a>è¯¾ç¨‹ä»£ç </h2><h3 id="æ¨¡æ‹Ÿæ•°å­—ç³»ç»Ÿ"><a href="#æ¨¡æ‹Ÿæ•°å­—ç³»ç»Ÿ" class="headerlink" title="æ¨¡æ‹Ÿæ•°å­—ç³»ç»Ÿ"></a>æ¨¡æ‹Ÿæ•°å­—ç³»ç»Ÿ</h3><ul>
<li>seven-seg.py</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">import fileinput</span><br><span class="line"> </span><br><span class="line">DISPLAY = &#x27;&#x27;&#x27;</span><br><span class="line">     AAAAAAAAA</span><br><span class="line">    FF       BB</span><br><span class="line">    FF       BB</span><br><span class="line">    FF       BB</span><br><span class="line">    FF       BB</span><br><span class="line">     GGGGGGGG</span><br><span class="line">   EE       CC</span><br><span class="line">   EE       CC</span><br><span class="line">   EE       CC</span><br><span class="line">   EE       CC</span><br><span class="line">    DDDDDDDDD</span><br><span class="line">&#x27;&#x27;&#x27; </span><br><span class="line"></span><br><span class="line"># STFW: ANSI Escape Code</span><br><span class="line">CLEAR = &#x27;\033[2J\033[1;1f&#x27;</span><br><span class="line">BLOCK = &#123;</span><br><span class="line">    0: &#x27;\033[37mâ–‘\033[0m&#x27;,</span><br><span class="line">    1: &#x27;\033[31mâ–ˆ\033[0m&#x27;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">for line in fileinput.input():</span><br><span class="line">    # Load &quot;A=0; B=1; ...&quot; to current context</span><br><span class="line">    exec(line)</span><br><span class="line"></span><br><span class="line">    # Render the seven-segment display</span><br><span class="line">    pic = DISPLAY</span><br><span class="line">    for seg in set(DISPLAY):</span><br><span class="line">        if seg.isalpha():</span><br><span class="line">            val = globals()[seg]  # 0 or 1</span><br><span class="line">            pic = pic.replace(seg, BLOCK[val])</span><br><span class="line"></span><br><span class="line">    # Clear screen and display</span><br><span class="line">    print(CLEAR + pic)</span><br></pre></td></tr></table></figure>
<ul>
<li>logisim.c</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdbool.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line"></span><br><span class="line">typedef bool wire; // Wires</span><br><span class="line">typedef struct &#123;</span><br><span class="line">  bool value;</span><br><span class="line">  wire *in, *out;</span><br><span class="line">&#125; reg; // Flip-flops</span><br><span class="line"></span><br><span class="line">// Circuit constructs</span><br><span class="line">#define CLOCK       for (; ; END_CYCLE)</span><br><span class="line">#define NAND(X, Y)  (!((X) &amp;&amp; (Y)))</span><br><span class="line">#define NOT(X)      (NAND(X, 1))</span><br><span class="line">#define AND(X, Y)   (NOT(NAND(X, Y)))</span><br><span class="line">#define OR(X, Y)    (NAND(NOT(X), NOT(Y)))</span><br><span class="line"></span><br><span class="line">// Circuit emulation helpers</span><br><span class="line">#define END_CYCLE (&#123; end_cycle(); putchar(&#x27;\n&#x27;); fflush(stdout); sleep(1); &#125;)</span><br><span class="line">#define PRINT(X) printf(#X &quot; = %d; &quot;, X)</span><br><span class="line"></span><br><span class="line">// Wire and register specification</span><br><span class="line">wire X, Y, X1, Y1, A, B, C, D, E, F, G;</span><br><span class="line">reg b1 = &#123;.in = &amp;X1, .out = &amp;X&#125;;</span><br><span class="line">reg b0 = &#123;.in = &amp;Y1, .out = &amp;Y&#125;;</span><br><span class="line"></span><br><span class="line">// Dump wire values at the end of each cycle</span><br><span class="line">void end_cycle() &#123;</span><br><span class="line">  PRINT(A); PRINT(B); PRINT(C); PRINT(D);</span><br><span class="line">  PRINT(E); PRINT(F); PRINT(G);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">  CLOCK &#123;</span><br><span class="line">    // 1. Wire network specification (logic gates)</span><br><span class="line">    X1 = AND(NOT(X), Y);</span><br><span class="line">    Y1 = NOT(OR(X, Y));</span><br><span class="line">    A = D = E = NOT(Y);</span><br><span class="line">    B = 1;</span><br><span class="line">    C = NOT(X);</span><br><span class="line">    F = Y1;</span><br><span class="line">    G = X;</span><br><span class="line"></span><br><span class="line">    // 2. Lock data in flip-flops and propagate output to wires</span><br><span class="line">    b0.value = *b0.in;</span><br><span class="line">    b1.value = *b1.in;</span><br><span class="line">    *b0.out = b0.value;</span><br><span class="line">    *b1.out = b1.value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Makefile</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">a.out: logisim.c</span><br><span class="line">	gcc $(CFLAGS) logisim.c</span><br><span class="line"></span><br><span class="line">run: a.out</span><br><span class="line">	./a.out | python3 seven-seg.py  # The UNIX Philosophy</span><br><span class="line"></span><br><span class="line">clean:</span><br><span class="line">	rm -f a.out</span><br></pre></td></tr></table></figure>
<ul>
<li>ç¼–è¯‘</li>
</ul>
<p>åœ¨å½“å‰ç›®å½•ä¸‹æ‰§è¡Œ<code>make</code></p>
<ul>
<li>è¿è¡Œ</li>
</ul>
<p>åœ¨å½“å‰ç›®å½•ä¸‹æ‰§è¡Œ<code>make run</code>æˆ–.<code>/a.out | python3 seven-seg.py</code>ã€‚</p>
<p><img src="../img/image-12-16965174394557.png" alt="img">æ¨¡æ‹Ÿæ•°å­—ç³»ç»Ÿè¿è¡Œç»“æœ</p>
<h3 id="æ¨¡æ‹Ÿ-RISC-V-æŒ‡ä»¤æ‰§è¡Œ"><a href="#æ¨¡æ‹Ÿ-RISC-V-æŒ‡ä»¤æ‰§è¡Œ" class="headerlink" title="æ¨¡æ‹Ÿ RISC-V æŒ‡ä»¤æ‰§è¡Œ"></a>æ¨¡æ‹Ÿ RISC-V æŒ‡ä»¤æ‰§è¡Œ</h3><p>è¿™é‡Œè§£å†³äº†ä¸€ä¸ªé¸¡å…”åŒç¬¼é—®é¢˜</p>
<ul>
<li>jitu.txt</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">00050713</span><br><span class="line">00151793</span><br><span class="line">40f587b3</span><br><span class="line">0017d793</span><br><span class="line">00200513</span><br><span class="line">40f705b3</span><br><span class="line">00100073</span><br><span class="line">00100513</span><br><span class="line">02000593</span><br><span class="line">00100073</span><br><span class="line">00200513</span><br><span class="line">00078593</span><br><span class="line">00100073</span><br><span class="line">00100513</span><br><span class="line">00a00593</span><br><span class="line">00100073</span><br><span class="line">00300513</span><br><span class="line">00100073</span><br><span class="line">0000006f</span><br></pre></td></tr></table></figure>
<ul>
<li>uncore.c</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">static inline bool inst_fetch(inst_t *in) &#123;</span><br><span class="line">  union &#123;</span><br><span class="line">    inst_t i;</span><br><span class="line">    u32 u;</span><br><span class="line">  &#125; u;</span><br><span class="line">  int r = scanf(&quot;%x&quot;, &amp;u.u);</span><br><span class="line">  *in = u.i;</span><br><span class="line">  return r &gt; 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static inline void ebreak(CPUState *cpu) &#123;</span><br><span class="line">  switch (cpu-&gt;x[10]) &#123;</span><br><span class="line">    case 1: &#123; putchar(cpu-&gt;x[11]); break; &#125;</span><br><span class="line">    case 2: &#123; printf(&quot;%d&quot;, cpu-&gt;x[11]); break; &#125;</span><br><span class="line">    case 3: &#123; cpu-&gt;on = false; break; &#125;</span><br><span class="line">    default: assert(0);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>rvemu.c</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdint.h&gt;</span><br><span class="line">#include &lt;assert.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;stdbool.h&gt;</span><br><span class="line">typedef uint32_t u32;</span><br><span class="line"></span><br><span class="line">typedef struct &#123; u32 op:7, rd:5, f3:3, rs1:5, rs2:5, f7:7; &#125; inst_t;</span><br><span class="line">typedef struct &#123;</span><br><span class="line">  u32 on, x[32];</span><br><span class="line">&#125; CPUState;</span><br><span class="line"></span><br><span class="line">// Uncore:</span><br><span class="line">//   inst_fetch - read an instruction from stdin</span><br><span class="line">//   ebreak - hyper call: putchar/putd/exit</span><br><span class="line">#include &quot;uncore.c&quot;</span><br><span class="line"></span><br><span class="line">static inline u32 sext(u32 val, u32 n) &#123;</span><br><span class="line">  // Sign extend n-bit integer val to 32-bit</span><br><span class="line">  u32 mask = ~((1 &lt;&lt; n) - 1);</span><br><span class="line">  u32 set = (val &gt;&gt; n) &amp; 1;</span><br><span class="line">  u32 ret = set ? (val | mask) : val;</span><br><span class="line">  return ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc, char *argv[]) &#123;</span><br><span class="line">  CPUState cpu = &#123;.on = 1, .x = &#123; 0 &#125;&#125;; // The RESET state</span><br><span class="line">  for (int i = 0; argv[i + 1] &amp;&amp; i &lt; 8; i++) &#123;</span><br><span class="line">    cpu.x[10 + i] = atoi(argv[i + 1]); // Set a0-a7 to arguments</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  inst_t in;</span><br><span class="line">  while (cpu.on &amp;&amp; inst_fetch(&amp;in)) &#123;</span><br><span class="line">    // For each fetched instruction, execute it following the RV32I spec</span><br><span class="line">    u32 op = in.op, f3 = in.f3, f7 = in.f7;</span><br><span class="line">    u32 imm = sext((f7 &lt;&lt; 5) | in.rs2, 12), shamt = in.rs2;</span><br><span class="line">    u32 rd = in.rd, rs1_u = cpu.x[in.rs1], rs2_u = cpu.x[in.rs2], res = 0;</span><br><span class="line"></span><br><span class="line">    #define __ else if // Bad syntactic sugar!</span><br><span class="line">    if (op == 0b0110011 &amp;&amp; f3 == 0b000 &amp;&amp; f7 == 0b0000000) res = rs1_u + rs2_u;</span><br><span class="line">    __ (op == 0b0110011 &amp;&amp; f3 == 0b000 &amp;&amp; f7 == 0b0100000) res = rs1_u - rs2_u;</span><br><span class="line">    __ (op == 0b0010011 &amp;&amp; f3 == 0b000)                    res = rs1_u + imm;</span><br><span class="line">    __ (op == 0b0010011 &amp;&amp; f3 == 0b001 &amp;&amp; f7 == 0b0000000) res = rs1_u &lt;&lt; shamt;</span><br><span class="line">    __ (op == 0b0010011 &amp;&amp; f3 == 0b101 &amp;&amp; f7 == 0b0000000) res = rs1_u &gt;&gt; shamt;</span><br><span class="line">    __ (op == 0b1110011 &amp;&amp; f3 == 0b000 &amp;&amp; rd == 0 &amp;&amp; imm == 1) ebreak(&amp;cpu);</span><br><span class="line">    else assert(0);</span><br><span class="line">    if (rd) cpu.x[rd] = res;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Makefile</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">a.out: rvemu.c uncore.c</span><br><span class="line"># RTFM: Automatic variables</span><br><span class="line">	gcc $(CFLAGS) $&lt;</span><br><span class="line"></span><br><span class="line">run: a.out</span><br><span class="line">	@echo 2 Head, 4 Feet:</span><br><span class="line">	@cat ji-tu.txt | ./a.out 2 4</span><br><span class="line">	@echo 2 Head, 6 Feet:</span><br><span class="line">	@cat ji-tu.txt | ./a.out 2 6</span><br><span class="line">	@echo 2 Head, 8 Feet:</span><br><span class="line">	@cat ji-tu.txt | ./a.out 2 8</span><br><span class="line">	@echo 35 Head, 94 Feet:</span><br><span class="line">	@cat ji-tu.txt | ./a.out 35 94</span><br><span class="line"></span><br><span class="line">clean:</span><br><span class="line">	rm -f a.out</span><br></pre></td></tr></table></figure>
<ul>
<li>ç¼–è¯‘</li>
</ul>
<p>åœ¨å½“å‰ç›®å½•ä¸‹æ‰§è¡Œ<code>make</code></p>
<ul>
<li>è¿è¡Œ</li>
</ul>
<p>åœ¨å½“å‰ç›®å½•ä¸‹æ‰§è¡Œ<code>make run</code>ã€‚</p>
<p><img src="../img/image-13-16965174394559.png" alt="img">æ¨¡æ‹Ÿ RISC-V æŒ‡ä»¤æ‰§è¡Œ</p>
<h1 id="ç»ªè®º2-åº”ç”¨è§†è§’çš„æ“ä½œç³»ç»Ÿ-2023-2-16"><a href="#ç»ªè®º2-åº”ç”¨è§†è§’çš„æ“ä½œç³»ç»Ÿ-2023-2-16" class="headerlink" title="ç»ªè®º2_åº”ç”¨è§†è§’çš„æ“ä½œç³»ç»Ÿ_2023.2.16"></a>ç»ªè®º2_åº”ç”¨è§†è§’çš„æ“ä½œç³»ç»Ÿ_2023.2.16</h1><h2 id="æ±‡ç¼–ä»£ç å’Œæœ€å°å¯æ‰§è¡Œæ–‡ä»¶"><a href="#æ±‡ç¼–ä»£ç å’Œæœ€å°å¯æ‰§è¡Œæ–‡ä»¶" class="headerlink" title="æ±‡ç¼–ä»£ç å’Œæœ€å°å¯æ‰§è¡Œæ–‡ä»¶"></a>æ±‡ç¼–ä»£ç å’Œæœ€å°å¯æ‰§è¡Œæ–‡ä»¶</h2><h3 id="æ„é€ æœ€å°çš„-Hello-World-â€œåº”ç”¨ç¨‹åºâ€"><a href="#æ„é€ æœ€å°çš„-Hello-World-â€œåº”ç”¨ç¨‹åºâ€" class="headerlink" title="æ„é€ æœ€å°çš„ Hello, World â€œåº”ç”¨ç¨‹åºâ€"></a>æ„é€ æœ€å°çš„ Hello, World â€œåº”ç”¨ç¨‹åºâ€</h3><p>ç¼–è¯‘å®Œæˆåæ–‡ä»¶å¤§å°ä¸º16KBã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">  printf(&quot;Hello World\n&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨objdumpå·¥å…·æŸ¥çœ‹æ±‡ç¼–ä»£ç <code>objdump -d a.out | less</code>ã€‚</p>
<p>ä½¿ç”¨é™æ€æ–‡ä»¶è¿›è¡Œç¼–è¯‘ï¼Œ<code>gcc hello.c -static</code>ï¼Œç¼–è¯‘å®Œæˆåå¤§å°ä¸º880kbï¼ŒæŸ¥çœ‹è¡Œæ•°ï¼Œ<code>objdump -d a.out | wc -l</code>ï¼Œå…±154193è¡Œã€‚</p>
<p>æ‰“å¼€gccçš„æ—¥å¿—åŠŸèƒ½<code>gcc hello.c -static --verbose</code>ï¼Œå¯ä»¥æ‰“å°å‡ºç¼–è¯‘æ—¶çš„è¿è¡Œæ—¥å¿—ã€‚</p>
<p><img src="../img/image-14-169651743945511.png" alt="img">gccè¿è¡Œæ—¥å¿—</p>
<p>ç¼–è¯‘è¿‡ç¨‹ï¼š.c(æºä»£ç )-&gt;.i(é¢„ç¼–è¯‘æºä»£ç )-gcc-&gt;.S(æ±‡ç¼–ä»£ç )-as-&gt;.o-ld-&gt;a.out</p>
<p>æ‰“å°é“¾æ¥é€‰é¡¹<code>gcc hello.c -static -Wl,--verbose</code>ã€‚å¯ä»¥çœ‹åˆ°å®ƒé“¾æ¥äº†å¾ˆå¤šä¸œè¥¿ã€‚</p>
<h3 id="å¼ºè¡Œæ„é€ æœ€å°çš„-Hello-Worldï¼Ÿ"><a href="#å¼ºè¡Œæ„é€ æœ€å°çš„-Hello-Worldï¼Ÿ" class="headerlink" title="å¼ºè¡Œæ„é€ æœ€å°çš„ Hello, Worldï¼Ÿ"></a>å¼ºè¡Œæ„é€ æœ€å°çš„ Hello, Worldï¼Ÿ</h3><p>ä½¿ç”¨<code>gcc -E hello.c</code>å¯ä»¥çœ‹åˆ°é¢„ç¼–è¯‘ç»“æœã€‚</p>
<p><img src="../img/image-15-169651743945513.png" alt="img">é¢„ç¼–è¯‘ç»“æœï¼ˆéƒ¨åˆ†ï¼‰</p>
<p>ä½¿ç”¨<code>gcc -c hello.c</code>ç”Ÿæˆhello.o,ä½¿ç”¨<code>objdump -d hello.o</code>æŸ¥çœ‹å†…å®¹ã€‚</p>
<p><img src="../img/image-19-169651743945515.png" alt="img">æŸ¥çœ‹å†…å®¹</p>
<p>ä½¿ç”¨ldå‘½ä»¤å¼ºè¡Œé“¾æ¥ï¼Œ<code>ld hello.o</code>ï¼Œä¼šå‡ºç°ä¸€ä¸ªwarningå’Œä¸€ä¸ªerrorã€‚</p>
<p><img src="../img/image-16.png" alt="img">å¼ºè¡Œé“¾æ¥ç»“æœ</p>
<p>å»é™¤å¤–éƒ¨ä¾èµ–ï¼Œé‡æ–°ç¼–è¯‘ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="../img/image-17.png" alt="img">æŸ¥çœ‹å†…å®¹</p>
<p>é“¾æ¥ååªå­˜åœ¨ä¸€ä¸ªwarningï¼Œå¯ä»¥ä½¿ç”¨<code>ld hello.o -e main</code>å¼ºè¡Œæ¶ˆé™¤è­¦å‘Šã€‚</p>
<p><img src="../img/image-20-169651743945519.png" alt="img">é“¾æ¥è­¦å‘Š</p>
<p>ä½¿ç”¨objdumpæŸ¥çœ‹ã€‚</p>
<p><img src="../img/image-21-169651743945521.png" alt="img">æœ€å°a.out</p>
<p>ä¸è¿‡è¿è¡Œå­˜åœ¨é”™è¯¯ã€‚</p>
<p><img src="../img/image-22-169651743945523.png" alt="img">è¿è¡Œæç¤ºSegmentation fault</p>
<p>å°†ä»£ç æ”¹ä¸ºæ­»å¾ªç¯ï¼Œç¨‹åºå¯æ­£å¸¸è¿è¡Œã€‚</p>
<p><img src="../img/image-23.png" alt="img">æ”¹ä¸ºæ­»å¾ªç¯</p>
<h4 id="ä¸ºä»€ä¹ˆä¼š-Segmentation-Faultï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆä¼š-Segmentation-Faultï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆä¼š Segmentation Faultï¼Ÿ"></a>ä¸ºä»€ä¹ˆä¼š Segmentation Faultï¼Ÿ</h4><p>ä½¿ç”¨è°ƒè¯•å™¨gbdå·¥å…·è¿›è¡Œè°ƒè¯•ï¼Œ<code>gdb a.out</code>ã€‚</p>
<p><img src="../img/image-24.png" alt="img">å¯åŠ¨gdb</p>
<p>ï¼ˆåœ¨gdbä¸­ï¼‰æ‰§è¡Œ<code>starti</code>ç¨‹åºå°†ä»æŒ‡ä»¤ç¬¬ä¸€æ¡å¼€å§‹æ‰§è¡Œã€‚ä½¿ç”¨<code>layout asm</code>å¯ä»¥å°†æ±‡ç¼–æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Šæ–¹ï¼ˆtext uiï¼‰ã€‚</p>
<p><img src="../img/image-25.png" alt="img">text ui</p>
<p>ä½¿ç”¨info registersæŸ¥çœ‹å¯„å­˜å™¨çŠ¶æ€ã€‚</p>
<p><img src="../img/image-26.png" alt="img">å¯„å­˜å™¨çŠ¶æ€</p>
<p>é€šè¿‡ è°ƒè¯•å¯ä»¥çœ‹åˆ°ï¼Œæ˜¯åœ¨è¿”å›æ—¶å‡ºç°é”™è¯¯ï¼Œæœ€åæŒ‡åˆ°äº†0x00000001åœ°å€ã€‚</p>
<p><img src="../img/image-27.png" alt="img">è¿”å›æ—¶çš„å‡ºé”™</p>
<h3 id="è§£å†³å¼‚å¸¸é€€å‡º"><a href="#è§£å†³å¼‚å¸¸é€€å‡º" class="headerlink" title="è§£å†³å¼‚å¸¸é€€å‡º"></a>è§£å†³å¼‚å¸¸é€€å‡º</h3><p>çº¯è®¡ç®—æŒ‡ä»¤ä¸èƒ½â€œåœä¸‹æ¥â€ï¼Œå› æ­¤ç³»ç»Ÿæä¾›äº†ä¸€ä¸ªæŒ‡ä»¤syscallï¼Œç³»ç»Ÿè°ƒç”¨ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">movq $SYS_exit,  %rax   # exit(</span><br><span class="line">movq $1,         %rdi   #   status=1</span><br><span class="line">syscall                 # );</span><br></pre></td></tr></table></figure>
<ul>
<li>æŠŠ â€œç³»ç»Ÿè°ƒç”¨â€ çš„å‚æ•°æ”¾åˆ°å¯„å­˜å™¨ä¸­</li>
<li>æ‰§è¡Œ syscallï¼Œæ“ä½œç³»ç»Ÿæ¥ç®¡ç¨‹åº<ul>
<li>ç¨‹åºæŠŠæ§åˆ¶æƒå®Œå…¨äº¤ç»™æ“ä½œç³»ç»Ÿ</li>
<li>æ“ä½œç³»ç»Ÿå¯ä»¥æ”¹å˜ç¨‹åºçŠ¶æ€ç”šè‡³ç»ˆæ­¢ç¨‹åº</li>
</ul>
</li>
</ul>
<p>å®ç°çœŸæ­£çš„æœ€å°çš„Hello Worldï¼Œ<strong>minimal.S</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;sys/syscall.h&gt;</span><br><span class="line"></span><br><span class="line">.globl _start</span><br><span class="line">_start:</span><br><span class="line">  movq $SYS_write, %rax   // write(</span><br><span class="line">  movq $1,         %rdi   //   fd=1,</span><br><span class="line">  movq $st,        %rsi   //   buf=st,</span><br><span class="line">  movq $(ed - st), %rdx   //   count=ed-st</span><br><span class="line">  syscall                 // );</span><br><span class="line"></span><br><span class="line">  movq $SYS_exit,  %rax   // exit(</span><br><span class="line">  movq $1,         %rdi   //   status=1</span><br><span class="line">  syscall                 // );</span><br><span class="line"></span><br><span class="line">st:</span><br><span class="line">  .ascii &quot;\033[01;31mHello, OS World\033[0m\n&quot;</span><br><span class="line">ed:</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨<code>gcc -c minimal.S</code>è¿›è¡Œç¼–è¯‘ï¼Œ<code>ld minimal.o</code>è¿›è¡Œé“¾æ¥ï¼ŒHello Worldå°±å¯ä»¥æ­£å¸¸å·¥ä½œäº†ï¼Œè¿™ä¸ªå¤§å°ä¸º4.65KB,ä½¿ç”¨<code>objdump -d a.out | wc -l</code>æŸ¥çœ‹ã€‚ä»…32è¡Œã€‚</p>
<p><img src="../img/image-28-169651743945630.png" alt="img">è¿è¡Œç»“æœ</p>
<p><img src="../img/image-29-169651743945632.png" alt="img">æŸ¥çœ‹è¡Œæ•°</p>
<p><img src="../img/image-30.png" alt="img">è°ƒè¯•æŸ¥çœ‹å†…å®¹</p>
<h3 id="å¯¹ä¸€äº›ç»†èŠ‚çš„è¡¥å……è§£é‡Š"><a href="#å¯¹ä¸€äº›ç»†èŠ‚çš„è¡¥å……è§£é‡Š" class="headerlink" title="å¯¹ä¸€äº›ç»†èŠ‚çš„è¡¥å……è§£é‡Š"></a>å¯¹ä¸€äº›ç»†èŠ‚çš„è¡¥å……è§£é‡Š</h3><p>ä¸ºä»€ä¹ˆç”¨ gcc ç¼–è¯‘ï¼Ÿ</p>
<ul>
<li>gcc ä¼šè¿›è¡Œé¢„ç¼–è¯‘ (å¯ä»¥ä½¿ç”¨ <code>__ASSEMBLER__</code> å®åŒºåˆ†æ±‡ç¼–/C ä»£ç )</li>
</ul>
<p>ANSI Escape Code çš„æ›´å¤šåº”ç”¨</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://git.busybox.net/busybox/tree/editors/vi.c">vi.c</a> from busybox</li>
<li><code>dialog --msgbox &#39;Hello, OS World!&#39; 8 32</code></li>
<li><code>ssh -o &#39;HostKeyAlgorithms +ssh-rsa&#39; sshtron.zachlatta.com</code></li>
</ul>
<h3 id="æ±‡ç¼–ä»£ç çš„çŠ¶æ€æœºæ¨¡å‹"><a href="#æ±‡ç¼–ä»£ç çš„çŠ¶æ€æœºæ¨¡å‹" class="headerlink" title="æ±‡ç¼–ä»£ç çš„çŠ¶æ€æœºæ¨¡å‹"></a>æ±‡ç¼–ä»£ç çš„çŠ¶æ€æœºæ¨¡å‹</h3><p>Everything is a state machine: è®¡ç®—æœº = æ•°å­—ç”µè·¯ = çŠ¶æ€æœº</p>
<p>æ‰€æœ‰çš„æŒ‡ä»¤éƒ½åªèƒ½è®¡ç®—</p>
<h2 id="ç†è§£é«˜çº§è¯­è¨€ç¨‹åº"><a href="#ç†è§£é«˜çº§è¯­è¨€ç¨‹åº" class="headerlink" title="ç†è§£é«˜çº§è¯­è¨€ç¨‹åº"></a>ç†è§£é«˜çº§è¯­è¨€ç¨‹åº</h2><h4 id="éé€’å½’æ±‰è¯ºå¡”å®ç°"><a href="#éé€’å½’æ±‰è¯ºå¡”å®ç°" class="headerlink" title="éé€’å½’æ±‰è¯ºå¡”å®ç°"></a>éé€’å½’æ±‰è¯ºå¡”å®ç°</h4><ul>
<li>hanoi-main.c</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;assert.h&gt;</span><br><span class="line"></span><br><span class="line">#include &quot;hanoi-nr.c&quot;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">  hanoi(3, &#x27;A&#x27;, &#x27;B&#x27;, &#x27;C&#x27;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ä¸€èˆ¬ä½¿ç”¨é€’å½’è§£å†³hanoi-r.c</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">void hanoi(int n, char from, char to, char via) &#123;</span><br><span class="line">  if (n == 1) &#123;</span><br><span class="line">    printf(&quot;%c -&gt; %c\n&quot;, from, to);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    hanoi(n - 1, from, via, to);</span><br><span class="line">    hanoi(1,     from, to,  via);</span><br><span class="line">    hanoi(n - 1, via,  to,  from);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ä½†æ˜¯å¯ä»¥ä½¿ç”¨éé€’å½’è¿›è¡Œå®ç°</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">  int pc, n;</span><br><span class="line">  char from, to, via;</span><br><span class="line">&#125; Frame;</span><br><span class="line"></span><br><span class="line">#define call(...) (&#123; *(++top) = (Frame) &#123; .pc = 0, __VA_ARGS__ &#125;; &#125;)</span><br><span class="line">#define ret()     (&#123; top--; &#125;)</span><br><span class="line">#define goto(loc) (&#123; f-&gt;pc = (loc) - 1; &#125;)</span><br><span class="line"></span><br><span class="line">void hanoi(int n, char from, char to, char via) &#123;</span><br><span class="line">  Frame stk[64], *top = stk - 1;</span><br><span class="line">  call(n, from, to, via);</span><br><span class="line">  for (Frame *f; (f = top) &gt;= stk; f-&gt;pc++) &#123;</span><br><span class="line">    n = f-&gt;n; from = f-&gt;from; to = f-&gt;to; via = f-&gt;via;</span><br><span class="line">    switch (f-&gt;pc) &#123;</span><br><span class="line">      case 0: if (n == 1) &#123; printf(&quot;%c -&gt; %c\n&quot;, from, to); goto(4); &#125; break;</span><br><span class="line">      case 1: call(n - 1, from, via, to);   break;</span><br><span class="line">      case 2: call(    1, from, to,  via);  break;</span><br><span class="line">      case 3: call(n - 1, via,  to,  from); break;</span><br><span class="line">      case 4: ret();                        break;</span><br><span class="line">      default: assert(0);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ä¸chatGPTçš„äº¤æµï¼Œå¯ä»¥äº†è§£è¯¥ç¨‹åºçš„å®ç°åŸç†ã€‚</p>
<p><img src="../img/image-31-169651743945635.png" alt="img">chatGPTç†è§£çš„ç¨‹åºå®ç°åŸç†</p>
<p>å¯¹ C ç¨‹åºåšå‡ºç®€åŒ–</p>
<ul>
<li>ç®€åŒ–ï¼šæ”¹å†™æˆæ¯æ¡è¯­å¥è‡³å¤šä¸€æ¬¡è¿ç®—/å‡½æ•°è°ƒç”¨çš„å½¢å¼<ul>
<li><a target="_blank" rel="noopener" href="https://cil-project.github.io/cil/">çœŸçš„æœ‰è¿™ç§å·¥å…·</a> (C Intermediate Language) å’Œ<a target="_blank" rel="noopener" href="https://gitlab.com/zsaleeba/picoc">è§£é‡Šå™¨</a></li>
</ul>
</li>
</ul>
<p>çŠ¶æ€æœºå®šä¹‰</p>
<ul>
<li>çŠ¶æ€ = å † + æ ˆ</li>
<li>åˆå§‹çŠ¶æ€ = <code>main</code> çš„ç¬¬ä¸€æ¡è¯­å¥</li>
<li>çŠ¶æ€è¿ç§» = æ‰§è¡Œä¸€æ¡è¯­å¥ä¸­çš„ä¸€å°æ­¥</li>
</ul>
<h2 id="ç†è§£ç¼–è¯‘å™¨"><a href="#ç†è§£ç¼–è¯‘å™¨" class="headerlink" title="ç†è§£ç¼–è¯‘å™¨"></a>ç†è§£ç¼–è¯‘å™¨</h2><p>æˆ‘ä»¬æœ‰ä¸¤ç§çŠ¶æ€æœº</p>
<ul>
<li><p>é«˜çº§è¯­è¨€ä»£ç .</p>
<p>c</p>
<ul>
<li>çŠ¶æ€ï¼šæ ˆã€å…¨å±€å˜é‡ï¼›çŠ¶æ€è¿ç§»ï¼šè¯­å¥æ‰§è¡Œ</li>
</ul>
</li>
<li><p>æ±‡ç¼–æŒ‡ä»¤åºåˆ—.</p>
<p>s</p>
<ul>
<li>çŠ¶æ€ï¼š(<em>M</em>,<em>R</em>)ï¼›çŠ¶æ€è¿ç§»ï¼šæŒ‡ä»¤æ‰§è¡Œ</li>
</ul>
</li>
<li><p>ç¼–è¯‘å™¨æ˜¯äºŒè€…ä¹‹é—´çš„æ¡¥æ¢ï¼š.<em>s</em>=compile(.<em>c</em>)</p>
</li>
</ul>
<p>.<em>s</em>=compile(.<em>c</em>)ï¼šç¼–è¯‘æ­£ç¡®æ€§</p>
<p>.<em>c</em> æ‰§è¡Œä¸­æ‰€æœ‰å¤–éƒ¨è§‚æµ‹è€…å¯è§çš„è¡Œä¸ºï¼Œå¿…é¡»åœ¨ .<em>s</em> ä¸­ä¿æŒä¸€è‡´</p>
<p>åœ¨æ­¤å‰æä¸‹ï¼Œä»»ä½•ç¿»è¯‘éƒ½æ˜¯åˆæ³•çš„ (ä¾‹å¦‚æˆ‘ä»¬æœŸæœ›æ›´å¿«æˆ–æ›´çŸ­çš„ä»£ç )</p>
<h2 id="æ“ä½œç³»ç»Ÿä¸Šçš„è½¯ä»¶-åº”ç”¨ç¨‹åº"><a href="#æ“ä½œç³»ç»Ÿä¸Šçš„è½¯ä»¶-åº”ç”¨ç¨‹åº" class="headerlink" title="æ“ä½œç³»ç»Ÿä¸Šçš„è½¯ä»¶ (åº”ç”¨ç¨‹åº)"></a>æ“ä½œç³»ç»Ÿä¸Šçš„è½¯ä»¶ (åº”ç”¨ç¨‹åº)</h2><h3 id="æ“ä½œç³»ç»Ÿä¸­çš„ä»»ä½•ç¨‹åº"><a href="#æ“ä½œç³»ç»Ÿä¸­çš„ä»»ä½•ç¨‹åº" class="headerlink" title="æ“ä½œç³»ç»Ÿä¸­çš„ä»»ä½•ç¨‹åº"></a>æ“ä½œç³»ç»Ÿä¸­çš„ä»»ä½•ç¨‹åº</h3><blockquote>
<p>ä»»ä½•ç¨‹åº = minimal.S = è°ƒç”¨ syscall çš„çŠ¶æ€æœº</p>
</blockquote>
<p>å¯æ‰§è¡Œæ–‡ä»¶æ˜¯æ“ä½œç³»ç»Ÿä¸­çš„å¯¹è±¡</p>
<ul>
<li>ä¸å¤§å®¶æ—¥å¸¸ä½¿ç”¨çš„æ–‡ä»¶ (a.c, README.txt) æ²¡æœ‰æœ¬è´¨åŒºåˆ«</li>
<li>æ“ä½œç³»ç»Ÿæä¾› API æ‰“å¼€ã€è¯»å–ã€æ”¹å†™ (éƒ½éœ€è¦ç›¸åº”çš„æƒé™)</li>
</ul>
<p>æŸ¥çœ‹å¯æ‰§è¡Œæ–‡ä»¶</p>
<ul>
<li><pre><code>vim
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">, </span><br><span class="line"></span><br></pre></td></tr></table></figure>
cat
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">, </span><br><span class="line"></span><br></pre></td></tr></table></figure>
xxd
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   éƒ½å¯ä»¥ç›´æ¥ â€œæŸ¥çœ‹â€ å¯æ‰§è¡Œæ–‡ä»¶</span><br><span class="line"></span><br><span class="line">  - `vim` ä¸­äºŒè¿›åˆ¶çš„éƒ¨åˆ†æ— æ³• â€œé˜…è¯»â€ï¼Œä½†å¯ä»¥çœ‹åˆ°å­—ç¬¦ä¸²å¸¸é‡</span><br><span class="line">  - ä½¿ç”¨ `xxd` å¯ä»¥çœ‹åˆ°æ–‡ä»¶ä»¥ `&quot;\x7f&quot; &quot;ELF&quot;` å¼€å¤´</span><br><span class="line">  - Vscode æœ‰ binary editor æ’ä»¶</span><br><span class="line"></span><br><span class="line">å°è¯•ä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€ä¹‹å‰çš„æœ€å°Hello Worldç¨‹åºï¼Œå¯ä»¥åœ¨é‡Œé¢æ‰¾åˆ°å¯¹åº”çš„å­—æ ·ã€‚</span><br><span class="line"></span><br><span class="line">![img](../img/image-32-1024x593.png)ä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æŸ¥çœ‹a.out</span><br><span class="line"></span><br><span class="line">åœ¨vimä¸­ä½¿ç”¨å‘½ä»¤`:%!xxd`ï¼Œå®ç°ç¼–è¾‘åŒºåŸŸä¸­æ–‡æœ¬ä¼ é€’ä¸­åˆ°xxdã€‚</span><br><span class="line"></span><br><span class="line">![img](../img/image-33-169651743945638.png)å¤„ç†å</span><br><span class="line"></span><br><span class="line">### ç³»ç»Ÿä¸­å¸¸è§çš„åº”ç”¨ç¨‹åº</span><br><span class="line"></span><br><span class="line">Core Utilities (coreutils)</span><br><span class="line"></span><br><span class="line">- *Standard* programs for text and file manipulation</span><br><span class="line"></span><br><span class="line">- ç³»ç»Ÿä¸­å®‰è£…çš„æ˜¯ </span><br><span class="line"></span><br><span class="line">  GNU Coreutils</span><br><span class="line"></span><br><span class="line">  - æœ‰è¾ƒå°çš„æ›¿ä»£å“ [busybox](https://www.busybox.net/)</span><br><span class="line"></span><br><span class="line">ç³»ç»Ÿ/å·¥å…·ç¨‹åº</span><br><span class="line"></span><br><span class="line">- bash, </span><br><span class="line"></span><br><span class="line">  binutils</span><br><span class="line"></span><br><span class="line">  , apt, ip, ssh, vim, tmux, jdk, python, ...</span><br><span class="line"></span><br><span class="line">  - è¿™äº›å·¥å…·çš„åŸç†ä¸å¤æ‚ (ä¾‹å¦‚ apt æ˜¯ dpkg çš„å¥—å£³)ï¼Œä½†çç¢</span><br><span class="line">  - [Ubuntu Packages](https://packages.ubuntu.com/) (å’Œ apt-file å·¥å…·) æ”¯æŒæ–‡ä»¶åæ£€ç´¢</span><br><span class="line"></span><br><span class="line">å…¶ä»–å„ç§åº”ç”¨ç¨‹åº</span><br><span class="line"></span><br><span class="line">- Vscode, æµè§ˆå™¨ã€éŸ³ä¹æ’­æ”¾å™¨â€¦â€¦</span><br><span class="line"></span><br><span class="line">### æ‰“å¼€ç¨‹åºçš„æ‰§è¡Œï¼šTrace (è¿½è¸ª)</span><br><span class="line"></span><br><span class="line">ä½¿ç”¨strace ./a.outè¿›è¡Œè¿½è¸ªç¨‹åºçš„ç³»ç»Ÿè°ƒç”¨ã€‚</span><br><span class="line"></span><br><span class="line">![img](../img/image-34.png)strace</span><br><span class="line"></span><br><span class="line">### æ“ä½œç³»ç»Ÿä¸­ â€œä»»ä½•ç¨‹åºâ€ çš„ä¸€ç”Ÿ</span><br><span class="line"></span><br><span class="line">&gt; ä»»ä½•ç¨‹åº = minimal.S = è°ƒç”¨ syscall çš„çŠ¶æ€æœº</span><br><span class="line"></span><br><span class="line">## æ€»ç»“</span><br><span class="line"></span><br><span class="line">æ— è®ºæ˜¯æ±‡ç¼–ä»£ç è¿˜æ˜¯é«˜çº§è¯­è¨€ç¨‹åºï¼Œå®ƒä»¬éƒ½å¯ä»¥è¡¨ç¤ºæˆçŠ¶æ€æœºï¼š</span><br><span class="line"></span><br><span class="line">- é«˜çº§è¯­è¨€ä»£ç  .c</span><br><span class="line">  - çŠ¶æ€ï¼šæ ˆã€å…¨å±€å˜é‡ï¼›çŠ¶æ€è¿ç§»ï¼šè¯­å¥æ‰§è¡Œ</span><br><span class="line">- æ±‡ç¼–æŒ‡ä»¤åºåˆ— .s</span><br><span class="line">  - çŠ¶æ€ï¼š(M,R)ï¼›çŠ¶æ€è¿ç§»ï¼šæŒ‡ä»¤æ‰§è¡Œ</span><br><span class="line">- ç¼–è¯‘å™¨å®ç°äº†ä¸¤ç§çŠ¶æ€æœºä¹‹é—´çš„ç¿»è¯‘</span><br><span class="line"></span><br><span class="line">åº”ç”¨ç¨‹åºä¸æ“ä½œç³»ç»Ÿæ²Ÿé€šçš„å”¯ä¸€æ¡¥æ¢æ˜¯ç³»ç»Ÿè°ƒç”¨æŒ‡ä»¤ (ä¾‹å¦‚ x86-64 çš„ syscall)ã€‚è®¡ç®—æœºç³»ç»Ÿä¸å­˜åœ¨ç„å­¦ï¼›ä¸€åˆ‡éƒ½å»ºç«‹åœ¨ç¡®å®šçš„æœºåˆ¶ä¸Šã€‚</span><br><span class="line"></span><br><span class="line">- ç†è§£æ“ä½œç³»ç»Ÿçš„é‡è¦å·¥å…·ï¼šgcc, binutils, gdb, straceã€‚</span><br><span class="line"></span><br><span class="line"># ç»ªè®º3_ç¡¬ä»¶è§†è§’çš„æ“ä½œç³»ç»Ÿ_2023.2.28</span><br><span class="line"></span><br><span class="line">## å›é¡¾ï¼šè®¡ç®—æœºç¡¬ä»¶</span><br><span class="line"></span><br><span class="line">### è®¡ç®—æœºç¡¬ä»¶ = æ•°å­—ç”µè·¯</span><br><span class="line"></span><br><span class="line">åŸºæœ¬æ„ä»¶ï¼šwire, reg, NAND</span><br><span class="line"></span><br><span class="line">ç¨‹åºæ˜¯ â€œä¸¥æ ¼çš„æ•°å­¦å¯¹è±¡â€</span><br><span class="line"></span><br><span class="line">ä¸ä»…æ˜¯ç¨‹åºï¼Œæ•´ä¸ªè®¡ç®—æœºç³»ç»Ÿä¹Ÿæ˜¯ä¸€ä¸ªçŠ¶æ€æœº</span><br><span class="line"></span><br><span class="line">- çŠ¶æ€ï¼šå†…å­˜å’Œå¯„å­˜å™¨æ•°å€¼</span><br><span class="line">- **åˆå§‹çŠ¶æ€**ï¼šæ‰‹å†Œè§„å®š (CPU Reset)</span><br><span class="line">- çŠ¶æ€è¿ç§»</span><br><span class="line">  - ä»»æ„é€‰æ‹©ä¸€ä¸ªå¤„ç†å™¨ cpu</span><br><span class="line">  - å“åº”å¤„ç†å™¨å¤–éƒ¨ä¸­æ–­</span><br><span class="line">  - ä» cpu.PC å–æŒ‡ä»¤æ‰§è¡Œ</span><br><span class="line"></span><br><span class="line">## ç¡¬ä»¶ä¸ç¨‹åºå‘˜çš„çº¦å®š</span><br><span class="line"></span><br><span class="line">Bare-metal ä¸å‚å•†çš„çº¦å®š</span><br><span class="line"></span><br><span class="line">- CPU Reset åçš„çŠ¶æ€</span><br><span class="line"></span><br><span class="line">   (å¯„å­˜å™¨å€¼)</span><br><span class="line"></span><br><span class="line">  - å‚å•†è‡ªç”±å¤„ç†è¿™ä¸ªåœ°å€ä¸Šçš„å€¼</span><br><span class="line">  - Memory-mapped I/O</span><br><span class="line"></span><br><span class="line">å‚å•†ä¸ºæ“ä½œç³»ç»Ÿå¼€å‘è€…æä¾› Firmware</span><br><span class="line"></span><br><span class="line">- ç®¡ç†ç¡¬ä»¶å’Œç³»ç»Ÿé…ç½®</span><br><span class="line">- æŠŠå­˜å‚¨è®¾å¤‡ä¸Šçš„ä»£ç åŠ è½½åˆ°å†…å­˜</span><br><span class="line">  - ä¾‹å¦‚å­˜å‚¨ä»‹è´¨ä¸Šçš„ç¬¬äºŒçº§ loader (åŠ è½½å™¨)</span><br><span class="line">  - æˆ–è€…ç›´æ¥åŠ è½½æ“ä½œç³»ç»Ÿ (åµŒå…¥å¼ç³»ç»Ÿ)</span><br><span class="line"></span><br><span class="line">### x86 Family: CPU Reset</span><br><span class="line"></span><br><span class="line">![img](../img/image-102-797x1024.png)intel-cpu-reset</span><br><span class="line"></span><br><span class="line">- å¯„å­˜å™¨ä¼šæœ‰ç¡®å®šçš„åˆå§‹çŠ¶æ€</span><br><span class="line"></span><br><span class="line">  - `EIP = 0x0000fff0`</span><br><span class="line"></span><br><span class="line">  - ```</span><br><span class="line">    CR0 = 0x60000010</span><br></pre></td></tr></table></figure>

  - å¤„ç†å™¨å¤„äº 16-bit æ¨¡å¼

-
</code></pre><p>  EFLAGS = 0x00000002</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    - Interrupt disabled</span><br><span class="line"></span><br><span class="line">- TFM (5,000 é¡µ+)</span><br><span class="line"></span><br><span class="line">  - æœ€éœ€è¦çš„ Volume 3A åªæœ‰ ~400 é¡µ (æˆ‘ä»¬æ›´éœ€è¦ AI)</span><br><span class="line"></span><br><span class="line">### å…¶ä»–å¹³å°ä¸Šçš„ CPU Reset</span><br><span class="line"></span><br><span class="line">Reset åå¤„ç†å™¨éƒ½ä»å›ºå®šåœ°å€ (Reset Vector) å¯åŠ¨</span><br><span class="line"></span><br><span class="line">- MIPS: 0xbfc00000</span><br><span class="line">  - Specification è§„å®š</span><br><span class="line">- ARM: 0x00000000</span><br><span class="line">  - Specification è§„å®š</span><br><span class="line">  - å…è®¸é…ç½® Reset Vector Base Address Register</span><br><span class="line">- RISC-V: Implementation defined</span><br><span class="line">  - ç»™å‚å•†æœ€å¤§ç¨‹åº¦çš„è‡ªç”±</span><br><span class="line"></span><br><span class="line">Firmware è´Ÿè´£åŠ è½½æ“ä½œç³»ç»Ÿ</span><br><span class="line"></span><br><span class="line">- å¼€å‘æ¿ï¼šç›´æ¥æŠŠåŠ è½½å™¨å†™å…¥ ROM</span><br><span class="line">- QEMUï¼š`-kernel` å¯ä»¥ç»•è¿‡ Firmware ç›´æ¥åŠ è½½å†…æ ¸ ([RTFM](https://www.qemu.org/docs/master/system/invocation.html#hxtool-8))</span><br><span class="line"></span><br><span class="line">### x86 CPU Reset ä¹‹åï¼šåˆ°åº•æ‰§è¡Œäº†ä»€ä¹ˆï¼Ÿ</span><br><span class="line"></span><br><span class="line">![img](../img/image-103.png)bios-firmware</span><br><span class="line"></span><br><span class="line">çŠ¶æ€æœº (åˆå§‹çŠ¶æ€) å¼€å§‹æ‰§è¡Œ</span><br><span class="line"></span><br><span class="line">- ä» PC å–æŒ‡ä»¤ã€è¯‘ç ã€æ‰§è¡Œâ€¦â€¦</span><br><span class="line">- å¼€å§‹æ‰§è¡Œå‚å•† â€œå®‰æ’å¥½â€ çš„ Firmware ä»£ç </span><br><span class="line">  - x86 Reset Vector æ˜¯ä¸€æ¡å‘ Firmware è·³è½¬çš„ jmp æŒ‡ä»¤</span><br><span class="line"></span><br><span class="line">Firmware: [BIOS vs. UEFI](https://www.zhihu.com/question/21672895)</span><br><span class="line"></span><br><span class="line">- ä¸€ä¸ªå° â€œæ“ä½œç³»ç»Ÿâ€</span><br><span class="line">  - ç®¡ç†ã€é…ç½®ç¡¬ä»¶ï¼›åŠ è½½æ“ä½œç³»ç»Ÿ</span><br><span class="line">- Legacy BIOS (Basic I/O System)</span><br><span class="line">  - IBM PC æ‰€æœ‰è®¾å¤‡/BIOS ä¸­æ–­æ˜¯æœ‰ specification çš„ (æˆå°±äº† â€œå…¼å®¹æœºâ€)</span><br><span class="line">- UEFI (Unified Extensible Firmware Interface)</span><br><span class="line"></span><br><span class="line">### ä¸ºä»€ä¹ˆéœ€è¦ UEFIï¼Ÿ</span><br><span class="line"></span><br><span class="line">ä»Šå¤©çš„ Firmware é¢ä¸´éº»çƒ¦å¾—å¤šçš„ç¡¬ä»¶ï¼š</span><br><span class="line"></span><br><span class="line">- æŒ‡çº¹é”ã€USB è½¬æ¥å™¨ä¸Šçš„ Linux-to-Go ä¼˜ç›˜ã€å±±å¯¨ç½‘å¡ä¸Šçš„ PXE ç½‘ç»œå¯åŠ¨ã€USB è“ç‰™è½¬æ¥å™¨è¿æ¥çš„è“ç‰™é”®ç›˜ã€â€¦â€¦</span><br><span class="line">  - è¿™äº›è®¾å¤‡éƒ½éœ€è¦ â€œé©±åŠ¨ç¨‹åºâ€ æ‰èƒ½è®¿é—®</span><br><span class="line">  - è§£å†³ BIOS é€æ¸ç¢ç‰‡åŒ–çš„é—®é¢˜</span><br><span class="line"></span><br><span class="line">![img](../img/image-104-1024x695.png)UEFI-booting-seq</span><br><span class="line"></span><br><span class="line">### å›åˆ° Legacy BIOS: çº¦å®š</span><br><span class="line"></span><br><span class="line">BIOS æä¾›æœºåˆ¶ï¼Œå°†**ç¨‹åºå‘˜çš„ä»£ç **è½½å…¥å†…å­˜</span><br><span class="line"></span><br><span class="line">- Legacy BIOS æŠŠç¬¬ä¸€ä¸ªå¯å¼•å¯¼è®¾å¤‡çš„ç¬¬ä¸€ä¸ª </span><br><span class="line"></span><br><span class="line">  512 </span><br><span class="line"></span><br><span class="line">  å­—èŠ‚åŠ è½½åˆ°ç‰©ç†å†…å­˜çš„ </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>7c00</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> ä½ç½®</span><br><span class="line"></span><br><span class="line">- æ­¤æ—¶å¤„ç†å™¨å¤„äº 16-bit æ¨¡å¼</span><br><span class="line"></span><br><span class="line">- è§„å®š </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>  CS:IP = 0x7c00</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">, </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>  (R[CS] &lt;&lt; 4) | R[IP] == 0x7c00</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    - å¯èƒ½æ€§1ï¼š`CS = 0x07c0, IP = 0`</span><br><span class="line">    - å¯èƒ½æ€§2ï¼š`CS = 0, IP = 0x7c00`</span><br><span class="line"></span><br><span class="line">  - å…¶ä»–æ²¡æœ‰ä»»ä½•çº¦æŸ</span><br><span class="line"></span><br><span class="line">è™½ç„¶æœ€å¤šåªæœ‰ 446 å­—èŠ‚ä»£ç  (64B åˆ†åŒºè¡¨ + 2B æ ‡è¯†)</span><br><span class="line"></span><br><span class="line">- ä½†æ§åˆ¶æƒå·²ç»å›åˆ°ç¨‹åºå‘˜æ‰‹ä¸­äº†ï¼</span><br><span class="line">- ä½ ç”šè‡³å¯ä»¥è®© ChatGPT ç»™ä½ å†™ä¸€ä¸ª Hello World</span><br><span class="line">  - å½“ç„¶ï¼Œä»–æ˜¯æŠ„ä½œä¸šçš„ (è€Œä¸”æ˜¯æœ‰äº›å°é—®é¢˜çš„)</span><br><span class="line"></span><br><span class="line">è®¡ç®—æœºç³»ç»Ÿå…¬ç†ï¼šä½ æƒ³åˆ°çš„å°±ä¸€å®šæœ‰äººåšåˆ°</span><br><span class="line"></span><br><span class="line">- æ¨¡æ‹Ÿæ–¹æ¡ˆï¼šQEMU</span><br><span class="line"></span><br><span class="line">  - ä¼ å¥‡é»‘å®¢ã€å¤©æ‰ç¨‹åºå‘˜ </span><br><span class="line"></span><br><span class="line">    Fabrice Bellard</span><br><span class="line"></span><br><span class="line">     çš„æ°ä½œ</span><br><span class="line"></span><br><span class="line">    - [QEMU, A fast and portable dynamic translator](https://www.usenix.org/legacy/publications/library/proceedings/usenix05/tech/freenix/full_papers/bellard/bellard.pdf) (USENIX ATC&#x27;05)</span><br><span class="line">    - Android Virtual Device, VirtualBox, ... èƒŒåéƒ½æ˜¯ QEMU</span><br><span class="line"></span><br><span class="line">- çœŸæœºæ–¹æ¡ˆï¼šJTAG (Joint Test Action Group) debugger</span><br><span class="line"></span><br><span class="line">  - ä¸€ç³»åˆ— (ç‰©ç†) è°ƒè¯•å¯„å­˜å™¨ï¼Œå¯ä»¥å®ç° gdb æ¥å£ (!!!) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- Makefile</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>mbr.img: mbr.S<br>  gcc -ggdb -c $&lt;<br>  ld mbr.o -Ttext 0x7c00<br>  objcopy -S -O binary -j .text a.out $@</p>
</li>
</ul>
<p>run: mbr.img<br>    qemu-system-x86_64 $&lt;</p>
<p>debug: mbr.img<br>    qemu-system-x86_64 -s -S $&lt; &amp;  # Run QEMU in background<br>    gdb -x init.gdb  # RTFM: gdb (1)</p>
<p>clean:<br>    rm -f <em>.img </em>.o a.out<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- mbr.S</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h1 id="define-SECT-SIZE-512"><a href="#define-SECT-SIZE-512" class="headerlink" title="define SECT_SIZE  512"></a>define SECT_SIZE  512</h1><p>.code16  // 16-bit assembly</p>
<p>// Entry of the code<br>.globl _start<br>_start:<br>  lea   (msg), %si   // R[si] = &msg;</p>
<p>again:<br>  movb  (%si), %al   // R[al] = *R[si]; &lt;â€”+<br>  incw  %si          // R[si]++;           |<br>  orb   %al, %al     // if (!R[al])        |<br>  jz    done         //   goto done; â€”+   |<br>  movb  $0x0e, %ah   // R[ah] = 0x0e;  |   |<br>  movb  $0x00, %bh   // R[bh] = 0x00;  |   |<br>  int   $0x10        // bios_call();   |   |<br>  jmp   again        // goto again; â€”-+â€”-+<br>                     //                |<br>done:                //                |<br>  jmp   .            // goto done; &lt;â€”-+</p>
<p>// Data: const char msg[] = â€œâ€¦â€;<br>msg:<br>  .asciz â€œThis is a baby step towards operating systems!\r\nâ€</p>
<p>// Magic number for bootable device<br>.org SECT_SIZE - 2<br>.byte 0x55, 0xAA<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- init.gdb</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h1 id="Kill-process-QEMU-on-gdb-exits"><a href="#Kill-process-QEMU-on-gdb-exits" class="headerlink" title="Kill process (QEMU) on gdb exits"></a>Kill process (QEMU) on gdb exits</h1><p>define hook-quit<br>  kill<br>end</p>
<h1 id="Connect-to-remote"><a href="#Connect-to-remote" class="headerlink" title="Connect to remote"></a>Connect to remote</h1><p>target remote localhost:1234<br>file a.out<br>break *0x7c00<br>layout src<br>continue<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">è¿è¡Œmake runå¯ä»¥çœ‹åˆ°ç»“æœï¼Œç¼–è¯‘ç”Ÿæˆçš„mbr.imgå¤§å°ä¸º512å­—èŠ‚ã€‚</span><br><span class="line"></span><br><span class="line">![img](../img/image.png)è¿è¡Œ</span><br><span class="line"></span><br><span class="line">æ³¨æ„å¾—è¦å…ˆå®‰è£…ä¸€ä¸ªqemuï¼Œå‘½ä»¤`sudo apt-get install qemu-system-x86`ã€‚</span><br><span class="line"></span><br><span class="line">ç”±äºå·²ç»å†™å¥½è„šæœ¬ï¼Œå¯ä»¥ä½¿ç”¨`make debug`ä¾¿æ·å¯åŠ¨debugã€‚</span><br><span class="line"></span><br><span class="line">![img](../img/image-1-1024x401.png)debug</span><br><span class="line"></span><br><span class="line">### UEFI ä¸Šçš„æ“ä½œç³»ç»ŸåŠ è½½</span><br><span class="line"></span><br><span class="line">æ ‡å‡†åŒ–çš„åŠ è½½æµç¨‹</span><br><span class="line"></span><br><span class="line">- ç£ç›˜å¿…é¡»æŒ‰ GPT (GUID Partition Table) æ–¹å¼æ ¼å¼åŒ–</span><br><span class="line"></span><br><span class="line">- é¢„ç•™ä¸€ä¸ª FAT32 åˆ†åŒº (lsblk/fdisk å¯ä»¥çœ‹åˆ°)</span><br><span class="line"></span><br><span class="line">- Firmware èƒ½å¤ŸåŠ è½½ä»»æ„å¤§å°çš„ PE å¯æ‰§è¡Œæ–‡ä»¶ </span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  .efi<br>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  - æ²¡æœ‰ legacy boot 512 å­—èŠ‚é™åˆ¶</span><br><span class="line">  - EFI åº”ç”¨å¯ä»¥è¿”å› firmware</span><br><span class="line"></span><br><span class="line">æ›´å¥½çš„ç¨‹åºæ”¯æŒ</span><br><span class="line"></span><br><span class="line">- è®¾å¤‡é©±åŠ¨æ¡†æ¶</span><br><span class="line">- æ›´å¤šçš„åŠŸèƒ½ï¼Œä¾‹å¦‚ Secure Bootï¼Œåªèƒ½å¯åŠ¨ â€œä¿¡ä»»â€ çš„æ“ä½œç³»ç»Ÿ</span><br><span class="line"></span><br><span class="line">## å®ç°æœ€å° â€œæ“ä½œç³»ç»Ÿâ€</span><br><span class="line"></span><br><span class="line">### æˆ‘ä»¬å·²ç»è·å¾—çš„èƒ½åŠ›</span><br><span class="line"></span><br><span class="line">ä¸ºç¡¬ä»¶ç›´æ¥ç¼–ç¨‹</span><br><span class="line"></span><br><span class="line">- å¯ä»¥è®©æœºå™¨è¿è¡Œä»»æ„ä¸è¶…è¿‡ 510 å­—èŠ‚çš„æŒ‡ä»¤åºåˆ—</span><br><span class="line">- ç¼–å†™ä»»ä½•æŒ‡ä»¤åºåˆ— (çŠ¶æ€æœº)</span><br><span class="line">  - åªè¦èƒ½é—®å‡ºé—®é¢˜ï¼Œå°±å¯ä»¥ RTFM/STFW/ChatGPT æ‰¾åˆ°ç­”æ¡ˆ</span><br><span class="line">    - â€œå¦‚ä½•åœ¨æ±‡ç¼–é‡Œç”Ÿæˆ *n* ä¸ªå­—èŠ‚çš„ 0â€</span><br><span class="line">    - â€œå¦‚ä½•åœ¨ x86 16-bit mode æ‰“å°å­—ç¬¦â€</span><br><span class="line"></span><br><span class="line">æ“ä½œç³»ç»Ÿï¼šå°±ä¸€ä¸ª C ç¨‹åº</span><br><span class="line"></span><br><span class="line">- ç”¨ 510 å­—èŠ‚çš„æŒ‡ä»¤å®Œæˆç£ç›˜ â†’ å†…å­˜çš„åŠ è½½</span><br><span class="line">- åˆå§‹åŒ– C ç¨‹åºçš„æ‰§è¡Œç¯å¢ƒ</span><br><span class="line">- æ“ä½œç³»ç»Ÿå°±å¼€å§‹è¿è¡Œäº†ï¼</span><br><span class="line"></span><br><span class="line">### Bare-metal ä¸Šçš„ C ä»£ç </span><br><span class="line"></span><br><span class="line">ä¸ºäº†è®©ä¸‹åˆ—ç¨‹åºèƒ½å¤Ÿ â€œè¿è¡Œèµ·æ¥â€ï¼š</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>int main() {<br>  printf(â€œHello, World\nâ€);<br>}<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">æˆ‘ä»¬éœ€è¦å‡†å¤‡ä»€ä¹ˆï¼Ÿ</span><br><span class="line"></span><br><span class="line">- MBR ä¸Šçš„ â€œå¯åŠ¨åŠ è½½å™¨â€ (Boot Loader)</span><br><span class="line">- æˆ‘ä»¬å¯ä»¥é€šè¿‡ç¼–è¯‘å™¨æ§åˆ¶ C ç¨‹åºçš„è¡Œä¸º</span><br><span class="line">  - é™æ€é“¾æ¥/PIC (ä½ç½®æ— å…³ä»£ç )</span><br><span class="line">  - Freestanding (ä¸ä½¿ç”¨ä»»ä½•æ ‡å‡†åº“)</span><br><span class="line">  - è‡ªå·±æ‰‹å·¥å®ç°åº“å‡½æ•° (putch, printf, ...)</span><br><span class="line">    - æœ‰äº¿ç‚¹ç‚¹ç»†èŠ‚ï¼šRTFSC!</span><br><span class="line"></span><br><span class="line">- hello.c</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h1 id="include"><a href="#include" class="headerlink" title="include "></a>include <am.h></h1><h1 id="define-ESC-â€œ-033-â€œ"><a href="#define-ESC-â€œ-033-â€œ" class="headerlink" title="define ESC â€œ\033[â€œ"></a>define ESC â€œ\033[â€œ</h1><h1 id="define-RED-ESC-â€œ01-31mâ€"><a href="#define-RED-ESC-â€œ01-31mâ€" class="headerlink" title="define RED ESC â€œ01;31mâ€"></a>define RED ESC â€œ01;31mâ€</h1><h1 id="define-CLR-ESC-â€œ0mâ€"><a href="#define-CLR-ESC-â€œ0mâ€" class="headerlink" title="define CLR ESC â€œ0mâ€"></a>define CLR ESC â€œ0mâ€</h1><p>const char *MESSAGE = RED â€œHello, OS World\nâ€ CLR;</p>
<p>int main() {<br>  for (const char <em>s = MESSAGE; </em>s; s++) {<br>    putch(*s);  // Prints to platform-dependent debug console<br>  }<br>}<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- kernel.c</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h1 id="include-1"><a href="#include-1" class="headerlink" title="include "></a>include <am.h></h1><h1 id="include-2"><a href="#include-2" class="headerlink" title="include "></a>include <klib.h></h1><h1 id="include-3"><a href="#include-3" class="headerlink" title="include "></a>include <klib-macros.h></h1><p>typedef union task {<br>  struct {<br>    const char <em>name;<br>    union task </em>next;<br>    void      (<em>entry)(void </em>);<br>    Context    *context;<br>  };<br>  uint8_t stack[8192];<br>} Task;</p>
<p>Task *current;</p>
<p>void func(void <em>arg) {<br>  while (1) {<br>    putch(</em>(char *)arg);<br>    for (int volatile i = 0; i &lt; 100000; i++) ;<br>  }<br>}</p>
<p>Task tasks[] = {<br>  { .name = â€œaâ€, .entry = func },<br>  { .name = â€œbâ€, .entry = func },<br>};</p>
<p>Context <em>on_interrupt(Event ev, Context </em>ctx) {<br>  if (!current) {<br>    current = &amp;tasks[0];<br>  } else {<br>    current-&gt;context = ctx;<br>  }<br>  return (current = current-&gt;next)-&gt;context;<br>}</p>
<p>int main() {<br>  cte_init(on_interrupt);  // call on_interrupt() on traps/interrupts</p>
<p>  for (int i = 0; i &lt; LENGTH(tasks); i++) {<br>    Task <em>task    = &amp;tasks[i];<br>    Area stack    = (Area) { &amp;task-&gt;context + 1, task + 1 };<br>    task-&gt;context = kcontext(stack, task-&gt;entry, (void </em>)task-&gt;name);<br>    task-&gt;next    = &amp;tasks[(i + 1) % LENGTH(tasks)];<br>  }<br>  iset(true);  // Enable external interrupts (timer, I/O, â€¦)<br>  yield();  // Trap<br>}<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- Makefile</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>NAME := hello<br>SRCS := hello.c<br>export ARCH := x86_64-qemu</p>
<p>include $(AM_HOME)/Makefile<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](../img/image-2-169651743945646.png)è¿è¡Œç»“æœ</span><br><span class="line"></span><br><span class="line">è¿è¡Œè¿™æ®µä»£ç ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½® `AM_HOME` ç¯å¢ƒå˜é‡ä¸ºå®éªŒæ¡†æ¶ä»£ç ä¸­çš„ AbstractMachine æ‰€åœ¨ç›®å½• (ç»å¯¹è·¯å¾„)</span><br><span class="line"></span><br><span class="line">æ¡†æ¶åœ°å€ï¼š[NJU-ProjectN/abstract-machine: A minimal, modularized, and machine-independent hardware abstraction layer (github.com)](https://github.com/NJU-ProjectN/abstract-machine)</span><br><span class="line"></span><br><span class="line">è®¾ç½®æ–¹æ³•ï¼š`vim ~/.bashrc ` ï¼Œç„¶åæ·»åŠ `export AM_HOME=ç»å¯¹è·¯å¾„`  ï¼Œç„¶åæŒ‰Esc, :wq, å›è½¦ï¼Œç„¶å`source ~/.bashrc`å³å¯ç”Ÿæ•ˆã€‚</span><br><span class="line"></span><br><span class="line">å‘ï¼šå¯èƒ½å‡ºç°æŠ¥é”™ï¼š</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>/usr/include/stdint.h:26:10: fatal error: bits/libc-header-start.h: No such file or directory<br>   26 | #include <bits/libc-header-start.h><br>      |<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">åŸå› ï¼šç¼–è¯‘çš„é¡¹ç›®æ˜¯åœ¨64ä½æœºå™¨ä¸Šç”Ÿæˆ32ä½çš„é¡¹ç›®ï¼Œä½ éœ€è¦å®‰è£…å¯¹åº”çš„gcc 32ä½çš„åº“</span><br><span class="line"></span><br><span class="line">è§£å†³ï¼š`sudo apt install gcc-multilib`</span><br><span class="line"></span><br><span class="line">å¯¹äºvscodeçš„&lt;am.h&gt;å¤´æ–‡ä»¶æŠ¥çº¢ï¼Œå¯ä»¥ä½¿ç”¨å¿«é€Ÿä¿®å¤è§£å†³ã€‚ï¼ˆå› æ­¤å»ºè®®å°†å…¶æ”¾åœ¨åŒä¸€é¡¹ç›®æ–‡ä»¶å¤¹ä¸‹ï¼‰</span><br><span class="line"></span><br><span class="line">![img](../img/image-3-169651743945648.png)å¿«é€Ÿä¿®å¤</span><br><span class="line"></span><br><span class="line">![img](../img/image-4-1024x435.png)è‡ªåŠ¨æ·»åŠ </span><br><span class="line"></span><br><span class="line"># ç»ªè®º4_Pythonå®ç°æ“ä½œç³»ç»Ÿæ¨¡å‹_2023.3.2</span><br><span class="line"></span><br><span class="line">## ç†è§£æ“ä½œç³»ç»Ÿçš„æ–°é€”å¾„</span><br><span class="line"></span><br><span class="line">### å›é¡¾ï¼šç¨‹åº/ç¡¬ä»¶çš„çŠ¶æ€æœºæ¨¡å‹</span><br><span class="line"></span><br><span class="line">è®¡ç®—æœºè½¯ä»¶</span><br><span class="line"></span><br><span class="line">- çŠ¶æ€æœº (C/æ±‡ç¼–)</span><br><span class="line">  - å…è®¸æ‰§è¡Œç‰¹æ®ŠæŒ‡ä»¤ (syscall) è¯·æ±‚æ“ä½œç³»ç»Ÿ</span><br><span class="line">  - æ“ä½œç³»ç»Ÿ = API + å¯¹è±¡</span><br><span class="line"></span><br><span class="line">è®¡ç®—æœºç¡¬ä»¶</span><br><span class="line"></span><br><span class="line">- â€œæ— æƒ…æ‰§è¡ŒæŒ‡ä»¤çš„æœºå™¨â€</span><br><span class="line">  - ä» CPU Reset çŠ¶æ€å¼€å§‹æ‰§è¡Œ Firmware ä»£ç </span><br><span class="line">  - æ“ä½œç³»ç»Ÿ = C ç¨‹åº</span><br><span class="line"></span><br><span class="line">### ä¸€ä¸ªå¤§èƒ†çš„æƒ³æ³•</span><br><span class="line"></span><br><span class="line">æ— è®ºæ˜¯è½¯ä»¶è¿˜æ˜¯ç¡¬ä»¶ï¼Œéƒ½æ˜¯çŠ¶æ€æœº</span><br><span class="line"></span><br><span class="line">- è€ŒçŠ¶æ€å’ŒçŠ¶æ€çš„è¿ç§»æ˜¯å¯ä»¥ â€œç”»â€ å‡ºæ¥çš„ï¼</span><br><span class="line">- ç†è®ºä¸Šè¯´ï¼Œåªéœ€è¦ä¸¤ä¸ª API</span><br><span class="line">  - `dump_state()` - è·å–å½“å‰ç¨‹åºçŠ¶æ€</span><br><span class="line">  - `single_step()` - æ‰§è¡Œä¸€æ­¥</span><br><span class="line">  - gdb ä¸å°±æ˜¯åšè¿™ä¸ªçš„å—ï¼</span><br><span class="line"></span><br><span class="line">## æ“ä½œç³»ç»Ÿ â€œç©å…·â€ï¼šè®¾è®¡ä¸å®ç°</span><br><span class="line"></span><br><span class="line">### æ“ä½œç³»ç»Ÿç©å…·ï¼šAPI</span><br><span class="line"></span><br><span class="line">å››ä¸ª â€œç³»ç»Ÿè°ƒç”¨â€ API</span><br><span class="line"></span><br><span class="line">- choose(xs): è¿”å› `xs` ä¸­çš„ä¸€ä¸ªéšæœºé€‰é¡¹</span><br><span class="line">- write(s): è¾“å‡ºå­—ç¬¦ä¸² `s`</span><br><span class="line">- spawn(fn): åˆ›å»ºä¸€ä¸ªå¯è¿è¡Œçš„çŠ¶æ€æœº `fn`</span><br><span class="line">- sched(): éšæœºåˆ‡æ¢åˆ°ä»»æ„çŠ¶æ€æœºæ‰§è¡Œ</span><br><span class="line"></span><br><span class="line">é™¤æ­¤ä¹‹å¤–ï¼Œæ‰€æœ‰çš„ä»£ç éƒ½æ˜¯ç¡®å®š (deterministic) çš„çº¯ç²¹è®¡ç®—</span><br><span class="line"></span><br><span class="line">- å…è®¸ä½¿ç”¨ list, dict ç­‰æ•°æ®ç»“æ„</span><br><span class="line"></span><br><span class="line">è½¯ä»¶å°±æ˜¯çŠ¶æ€æœºï¼Œæ“ä½œç³»ç»Ÿæ˜¯çŠ¶æ€æœºçš„ç®¡ç†è€…ã€‚</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>count = 0</p>
<p>def Tprint(name):<br>    global count<br>    for i in range(3):<br>        count += 1<br>        sys_write(fâ€™#{count:02} Hello from {name}{i+1}\nâ€™)<br>        sys_sched()</p>
<p>def main():<br>    n = sys_choose([3, 4, 5])<br>    sys_write(fâ€™#Thread = {n}\nâ€™)<br>    for name in â€˜ABCDEâ€™[:n]:<br>        sys_spawn(Tprint, name)<br>    sys_sched()<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### å®ç°ç³»ç»Ÿè°ƒç”¨</span><br><span class="line"></span><br><span class="line">æœ‰äº› â€œç³»ç»Ÿè°ƒç”¨â€ çš„å®ç°æ˜¯æ˜¾è€Œæ˜“è§çš„</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>def sys_write(s): print(s)<br>def sys_choose(xs): return random.choice(xs)<br>def sys_spawn(t): runnables.append(t)<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">æœ‰äº›å°±å›°éš¾äº†</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>def sys_sched():<br>    raise NotImplementedError(â€˜No idea howâ€™)<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">æˆ‘ä»¬éœ€è¦</span><br><span class="line"></span><br><span class="line">- å°å­˜å½“å‰çŠ¶æ€æœºçš„çŠ¶æ€</span><br><span class="line">- æ¢å¤å¦ä¸€ä¸ª â€œè¢«å°å­˜â€ çŠ¶æ€æœºçš„æ‰§è¡Œ</span><br><span class="line">  - æ²¡é”™ï¼Œæˆ‘ä»¬ç¦»çœŸæ­£çš„ â€œåˆ†æ—¶æ“ä½œç³»ç»Ÿâ€ å°±åªå·®è¿™ä¸€æ­¥</span><br><span class="line"></span><br><span class="line">### å€Ÿç”¨ Python çš„è¯­è¨€æœºåˆ¶</span><br><span class="line"></span><br><span class="line">Generator objects (æ— æ ˆåç¨‹/è½»é‡çº§çº¿ç¨‹/...)</span><br><span class="line"></span><br><span class="line">åˆ©ç”¨äº†yield</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>def numbers():<br>    i = 0<br>    while True:<br>        ret = yield fâ€™{i:b}â€™  # â€œå°å­˜â€ çŠ¶æ€æœºçŠ¶æ€<br>        i += ret<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ä½¿ç”¨æ–¹æ³•ï¼š</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>n = numbers()  # å°å­˜çŠ¶æ€æœºåˆå§‹çŠ¶æ€<br>n.send(None)  # æ¢å¤å°å­˜çš„çŠ¶æ€<br>n.send(0)  # æ¢å¤å°å­˜çš„çŠ¶æ€ (å¹¶ä¼ å…¥è¿”å›å€¼)<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](../img/image-6-169651743945751.png)generator</span><br><span class="line"></span><br><span class="line">![img](../img/image-7.png)sendï¼Œä»¥äºŒè¿›åˆ¶ç»“æœè¾“å‡º</span><br><span class="line"></span><br><span class="line">![img](../img/image-8-16965174394401.png)å¦å¤–å¼€ä¸€ä¸ªçº¿ç¨‹mï¼Œåˆ‡æ¢</span><br><span class="line"></span><br><span class="line">- os-model.py</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h1 id="usr-bin-env-python3"><a href="#usr-bin-env-python3" class="headerlink" title="!/usr/bin/env python3"></a>!/usr/bin/env python3</h1><p>import sys<br>import random<br>from pathlib import Path</p>
<p>class OperatingSystem():<br>    â€œâ€â€A minimal executable operating system model.â€â€â€</p>
<pre><code>SYSCALLS = [&#39;choose&#39;, &#39;write&#39;, &#39;spawn&#39;, &#39;sched&#39;]

class Thread:
    &quot;&quot;&quot;A &quot;freezed&quot; thread state.&quot;&quot;&quot;

    def __init__(self, func, *args):
        self._func = func(*args)
        self.retval = None

    def step(self):
        &quot;&quot;&quot;Proceed with the thread until its next trap.&quot;&quot;&quot;
        syscall, args, *_ = self._func.send(self.retval)
        self.retval = None
        return syscall, args

def __init__(self, src):
    variables = &#123;&#125;
    exec(src, variables)
    self._main = variables[&#39;main&#39;]

def run(self):
    threads = [OperatingSystem.Thread(self._main)]
    while threads:  # Any thread lives
        try:
            match (t := threads[0]).step():
                case &#39;choose&#39;, xs:  # Return a random choice
                    t.retval = random.choice(xs)
                case &#39;write&#39;, xs:  # Write to debug console
                    print(xs, end=&#39;&#39;)
                case &#39;spawn&#39;, (fn, args):  # Spawn a new thread
                    threads += [OperatingSystem.Thread(fn, *args)]
                case &#39;sched&#39;, _:  # Non-deterministic schedule
                    random.shuffle(threads)
        except StopIteration:  # A thread terminates
            threads.remove(t)
            random.shuffle(threads)  # sys_sched()
</code></pre><p>if <strong>name</strong> == â€˜<strong>main</strong>â€˜:<br>    if len(sys.argv) &lt; 2:<br>        print(fâ€™Usage: {sys.argv[0]} fileâ€™)<br>        exit(1)</p>
<pre><code>src = Path(sys.argv[1]).read_text()
for syscall in OperatingSystem.SYSCALLS:
    src = src.replace(f&#39;sys_&#123;syscall&#125;&#39;,        # sys_write(...)
                      f&#39;yield &quot;&#123;syscall&#125;&quot;, &#39;)  #  -&gt; yield &#39;write&#39;, (...)

OperatingSystem(src).run()
</code></pre><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- hello.py</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>def main():<br>    sys_write(â€˜Hello, OS World\nâ€™)  # sys_write -&gt; print<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](../img/image-9-169651743945855.png)è°ƒç”¨ç»“æœ</span><br><span class="line"></span><br><span class="line">- threads.py</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>count = 0</p>
<p>def Tprint(name):<br>    global count<br>    for i in range(3):<br>        count += 1<br>        sys_write(fâ€™#{count:02} Hello from {name}{i+1}\nâ€™)<br>        sys_sched()</p>
<p>def main():<br>    n = sys_choose([3, 4, 5])<br>    sys_write(fâ€™#Thread = {n}\nâ€™)<br>    for name in â€˜ABCDEâ€™[:n]:<br>        sys_spawn(Tprint, name)<br>    sys_sched()<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](../img/image-10-16965174394402.png)threads</span><br><span class="line"></span><br><span class="line">## å»ºæ¨¡æ“ä½œç³»ç»Ÿ</span><br><span class="line"></span><br><span class="line">### ä¸€ä¸ªæ›´ â€œå…¨é¢â€ çš„æ“ä½œç³»ç»Ÿæ¨¡å‹</span><br><span class="line"></span><br><span class="line">è¿›ç¨‹ + çº¿ç¨‹ + ç»ˆç«¯ + å­˜å‚¨ (å´©æºƒä¸€è‡´æ€§)</span><br><span class="line"></span><br><span class="line">| ç³»ç»Ÿè°ƒç”¨/Linux å¯¹åº”          | è¡Œä¸º                           |</span><br><span class="line">| ---------------------------- | ------------------------------ |</span><br><span class="line">| sys_spawn(fn)/pthread_create | åˆ›å»ºä» fn å¼€å§‹æ‰§è¡Œçš„çº¿ç¨‹       |</span><br><span class="line">| sys_fork()/fork              | åˆ›å»ºå½“å‰çŠ¶æ€æœºçš„å®Œæ•´å¤åˆ¶       |</span><br><span class="line">| sys_sched()/å®šæ—¶è¢«åŠ¨è°ƒç”¨     | åˆ‡æ¢åˆ°éšæœºçš„çº¿ç¨‹/è¿›ç¨‹æ‰§è¡Œ      |</span><br><span class="line">| sys_choose(xs)/rand          | è¿”å›ä¸€ä¸ª xs ä¸­çš„éšæœºçš„é€‰æ‹©     |</span><br><span class="line">| sys_write(s)/printf          | å‘è°ƒè¯•ç»ˆç«¯è¾“å‡ºå­—ç¬¦ä¸² s         |</span><br><span class="line">| sys_bread(k)/read            | è¯»å–è™šæ‹Ÿè®¾ç£ç›˜å— *k* çš„æ•°æ®    |</span><br><span class="line">| sys_bwrite(k, v)/write       | å‘è™šæ‹Ÿç£ç›˜å— *k* å†™å…¥æ•°æ® *v*  |</span><br><span class="line">| sys_sync()/sync              | å°†æ‰€æœ‰å‘è™šæ‹Ÿç£ç›˜çš„æ•°æ®å†™å…¥è½ç›˜ |</span><br><span class="line">| sys_crash()/é•¿æŒ‰ç”µæºæŒ‰é”®     | æ¨¡æ‹Ÿç³»ç»Ÿå´©æºƒ                   |</span><br><span class="line"></span><br><span class="line">è¡Œä¸º</span><br><span class="line"></span><br><span class="line">### æ¨¡å‹åšå‡ºçš„ç®€åŒ–</span><br><span class="line"></span><br><span class="line">è¢«åŠ¨è¿›ç¨‹/çº¿ç¨‹åˆ‡æ¢</span><br><span class="line"></span><br><span class="line">- å®é™…ç¨‹åºéšæ—¶éƒ½å¯èƒ½è¢«åŠ¨è°ƒç”¨ `sys_sched()` åˆ‡æ¢</span><br><span class="line"></span><br><span class="line">åªæœ‰ä¸€ä¸ªç»ˆç«¯</span><br><span class="line"></span><br><span class="line">- æ²¡æœ‰ `read()` (ç”¨ choose æ›¿ä»£ â€œå…è®¸è¯»åˆ°ä»»æ„å€¼â€)</span><br><span class="line"></span><br><span class="line">ç£ç›˜æ˜¯ä¸€ä¸ª `dict`</span><br><span class="line"></span><br><span class="line">- æŠŠä»»æ„ key æ˜ å°„åˆ°ä»»æ„ value</span><br><span class="line">- å®é™…çš„ç£ç›˜</span><br><span class="line">  - key ä¸ºæ•´æ•°</span><br><span class="line">  - value æ˜¯å›ºå®šå¤§å° (ä¾‹å¦‚ 4KB) çš„æ•°æ®</span><br><span class="line">  - äºŒè€…åœ¨æŸç§ç¨‹åº¦ä¸Šæ˜¯å¯ä»¥ â€œäº’ç›¸è½¬æ¢â€ çš„</span><br><span class="line"></span><br><span class="line">### æ¨¡å‹å®ç°</span><br><span class="line"></span><br><span class="line">åŸç†ä¸åˆšæ‰çš„ â€œæœ€å°æ“ä½œç³»ç»Ÿç©å…·â€ ç±»ä¼¼</span><br><span class="line"></span><br><span class="line">- [mosaic.py](https://jyywiki.cn/pages/OS/2023/mosaic/mosaic.py) - 500 è¡Œå»ºæ¨¡æ“ä½œç³»ç»Ÿ</span><br><span class="line">- è¿›ç¨‹/çº¿ç¨‹éƒ½æ˜¯ Generator Object</span><br><span class="line">- å…±äº«å†…å­˜ç”¨ heap å˜é‡è®¿é—®</span><br><span class="line">  - çº¿ç¨‹ä¼šå¾—åˆ°å…±äº« heap çš„æŒ‡é’ˆ</span><br><span class="line">  - è¿›ç¨‹ä¼šå¾—åˆ°ä¸€ä¸ªç‹¬ç«‹çš„ heap clone</span><br><span class="line"></span><br><span class="line">è¾“å‡ºç¨‹åºè¿è¡Œçš„ â€œçŠ¶æ€å›¾â€</span><br><span class="line"></span><br><span class="line">- JSON Object</span><br><span class="line">- Vertices: çº¿ç¨‹/è¿›ç¨‹ã€å†…å­˜å¿«ç…§ã€è®¾å¤‡å†å²è¾“å‡º</span><br><span class="line">- Edges: ç³»ç»Ÿè°ƒç”¨</span><br><span class="line">  - æ“ä½œç³»ç»Ÿå°±æ˜¯ â€œçŠ¶æ€æœºçš„ç®¡ç†è€…â€</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- mosaic.py</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h1 id="usr-bin-env-python3-1"><a href="#usr-bin-env-python3-1" class="headerlink" title="!/usr/bin/env python3"></a>!/usr/bin/env python3</h1><h1 id="Mosaic-Emulator-and-Checker"><a href="#Mosaic-Emulator-and-Checker" class="headerlink" title="Mosaic Emulator and Checker"></a>Mosaic Emulator and Checker</h1><p>import argparse<br>import ast<br>import copy<br>import inspect<br>import json<br>import random<br>from dataclasses import dataclass<br>from itertools import compress, product<br>from pathlib import Path<br>from typing import Callable, Generator</p>
<h2 id="1-Mosaic-system-calls"><a href="#1-Mosaic-system-calls" class="headerlink" title="1. Mosaic system calls"></a>1. Mosaic system calls</h2><h3 id="1-1-Process-thread-and-context-switching"><a href="#1-1-Process-thread-and-context-switching" class="headerlink" title="1.1 Process, thread, and context switching"></a>1.1 Process, thread, and context switching</h3><p>sys_fork = lambda: os.sys_fork()<br>sys_spawn = lambda fn, <em>args: os.sys_spawn(fn, </em>args)<br>sys_sched = lambda: os.sys_sched()</p>
<h3 id="1-2-Virtual-character-device"><a href="#1-2-Virtual-character-device" class="headerlink" title="1.2 Virtual character device"></a>1.2 Virtual character device</h3><p>sys_choose = lambda choices: os.sys_choose(choices)<br>sys_write = lambda <em>args: os.sys_write(</em>args)</p>
<h3 id="1-3-Virtual-block-storage-device"><a href="#1-3-Virtual-block-storage-device" class="headerlink" title="1.3 Virtual block storage device"></a>1.3 Virtual block storage device</h3><p>sys_bread = lambda k: os.sys_bread(k)<br>sys_bwrite = lambda k, v: os.sys_bwrite(k, v)<br>sys_sync = lambda: os.sys_sync()<br>sys_crash = lambda: os.sys_crash()</p>
<h3 id="1-4-System-call-helpers"><a href="#1-4-System-call-helpers" class="headerlink" title="1.4 System call helpers"></a>1.4 System call helpers</h3><p>SYSCALLS = []</p>
<p>def syscall(func):  # @syscall decorator<br>    SYSCALLS.append(func.<strong>name</strong>)<br>    return func</p>
<h2 id="2-Mosaic-operating-system-emulator"><a href="#2-Mosaic-operating-system-emulator" class="headerlink" title="2. Mosaic operating system emulator"></a>2. Mosaic operating system emulator</h2><h3 id="2-1-Data-structures"><a href="#2-1-Data-structures" class="headerlink" title="2.1 Data structures"></a>2.1 Data structures</h3><p>class Heap:<br>    pass  # no member: self.<strong>dict</strong> is the heap</p>
<p>@dataclass<br>class Thread:<br>    context: Generator  # program counter, local variables, etc.<br>    heap: Heap  # a pointer to threadâ€™s â€œmemoryâ€</p>
<p>@dataclass<br>class Storage:<br>    persist: dict  # persisted storage state<br>    buf: dict  # outstanding operations yet to be persisted</p>
<h3 id="2-2-The-OperatingSystem-class"><a href="#2-2-The-OperatingSystem-class" class="headerlink" title="2.2 The OperatingSystem class"></a>2.2 The OperatingSystem class</h3><p>class OperatingSystem:<br>    â€œâ€â€An executable operating system model.</p>
<pre><code>The operating system model hosts a single Python application with a
main() function accessible to a shared heap and 9 system calls
(marked by the @syscall decorator). An example:

    def main():
        pid = sys_fork()
        sys_sched()  # non-deterministic context switch
        if pid == 0:
            sys_write(&#39;World&#39;)
        else:
            sys_write(&#39;Hello&#39;)

At any moment, this model keeps tracking a set of threads and a
&quot;currently running&quot; one. Each thread consists of a reference to a
heap object (may be shared with other threads) and a private context
(program counters, local variables, etc.). A thread context is a
Python generator object, i.e., a stack-less coroutine [1] that can
save the running context and yield itself.

For applications, the keyword &quot;yield&quot; is reserved for system calls.
For example, a &quot;choose&quot; system call [2]:

    sys_choose([&#39;A&#39;, &#39;B&#39;])

is transpiled as yielding the string &quot;sys_choose&quot; followed by its
parameters (choices):

    res = yield &#39;sys_choose&#39;, [&#39;A&#39;, &#39;B&#39;].

Yield will transfer the control to the OS for system call handling
and eventually returning a value (&#39;A&#39; or &#39;B&#39;) to the application.

Right after transferring control to the OS by &quot;yield&quot;, the function
state is &quot;frozen&quot;, where program counters and local variables are
accessible via the generator object. Therefore, OS can serialize its
internal state--all thread&#39;s contexts, heaps, and virtual device
states at this moment.

In this sense, operating system is a system-call driven state
transition system:

    (s0) --run first thread (main)-&gt; (s1)
         --sys_choose and application execution-&gt; (s2)
         --sys_sched and application execution-&gt; (s3) ...

Real operating systems can be preemptive--context switching can
happen non-deterministically at any program point, simply because
processor can non-deterministically interrupt its currently running
code and transfer the control to the operating system.

The OS internal implementation does NOT immediately process the
system call: it returns all possible choices available at the moment
and their corresponding processing logic as callbacks. For the
example above, the &quot;choose&quot; system call returns a non-deterministic
choice among given choices. The internal implementation thus returns

    choices = &#123;
        &#39;A&#39;: (lambda: &#39;A&#39;),
        &#39;B&#39;: (lambda: &#39;B&#39;),
    &#125;

for later processing. Another example is non-deterministic context
switching by yielding &#39;sys_sched&#39;. Suppose there are threads t1 and
t2 at the moment. The system call handler will return

    choices = &#123;
        &#39;t1&#39;: (lambda: switch_to(t1)),
        &#39;t2&#39;: (lambda: switch_to(t2)),
    &#125;

in which switch_to(th) replaces the OS&#39;s current running thread with
th (changes the global &quot;heap&quot; variable). Such deferred execution of
system calls separates the mechanism of non-deterministic choices
from the actual decision makers (e.g., an interpreter or a model
checker). Once the decision is made, the simply call step(choice)
and the OS will execute this choice by

    choices[choice]()

with the application code (generator) being resumed.

This model provides &quot;write&quot; system call to immediately push data to
a hypothetical character device like a tty associated with stdout.
We model a block device (key-value store) that may lose data upon
crash. The model assumes atomicity of each single block write (a
key-value update). However, writes are merely to a volatile buffer
which may non-deterministically lose data upon crash 3]. The &quot;sync&quot;
system call persists buffered writes.

References:

[1] N. Schemenauer, T. Peters, and M. L. Hetland. PEP 255 -
    Simple generators. https://peps.python.org/pep-0255/
[2] J. Yang, C. Sar, and D. Engler. eXplode: a lightweight, general
    system for finding serious storage system errors. OSDI&#39;06.
[3] T. S. Pillai, V. Chidambaram, R. Alagappan, A. Al-Kiswany, A. C.
    Arpaci-Dusseau, and R. H. Arpaci-Dusseau. All file systems are
    not created equal: On the complexity of crafting crash
    consistent applications. OSDI&#39;14.
&quot;&quot;&quot;

def __init__(self, init: Callable):
    &quot;&quot;&quot;Create a new OS instance with pending-to-execute init thread.&quot;&quot;&quot;
    # Operating system states
    self._threads = [Thread(context=init(), heap=Heap())]
    self._current = 0
    self._choices = &#123;init.__name__: lambda: None&#125;
    self._stdout = &#39;&#39;
    self._storage = Storage(persist=&#123;&#125;, buf=&#123;&#125;)

    # Internal states
    self._init = init
    self._trace = []
    self._newfork = set()
</code></pre><h3 id="2-3-System-call-implementation"><a href="#2-3-System-call-implementation" class="headerlink" title="2.3 System call implementation"></a>2.3 System call implementation</h3><h4 id="2-3-1-Process-thread-and-context-switching"><a href="#2-3-1-Process-thread-and-context-switching" class="headerlink" title="2.3.1 Process, thread, and context switching"></a>2.3.1 Process, thread, and context switching</h4><pre><code>@syscall
def sys_spawn(self, func: Callable, *args):
    &quot;&quot;&quot;Spawn a heap-sharing new thread executing func(args).&quot;&quot;&quot;
    def do_spawn():
        self._threads.append(
            Thread(
                context=func(*args),  # func() returns a new generator
                heap=self.current().heap,  # shared heap
            )
        )
    return &#123;&#39;spawn&#39;: (lambda: do_spawn())&#125;

@syscall
def sys_fork(self):
    &quot;&quot;&quot;Create a clone of the current thread with a copied heap.&quot;&quot;&quot;
    if all(not f.frame.f_locals[&#39;fork_child&#39;]
            for f in inspect.stack()
                if f.function == &#39;_step&#39;):  # this is parent; do fork
        # Deep-copying generators causes troubles--they are twined with
        # Python&#39;s runtime state. We use an (inefficient) hack here: replay 
        # the entire trace and override the last fork() to avoid infinite
        # recursion.
        os_clone = OperatingSystem(self._init)
        os_clone.replay(self._trace[:-1])
        os_clone._step(self._trace[-1], fork_child=True)

        # Now os_clone._current is the forked process. Cloned thread just 
        # yields a sys_fork and is pending for fork()&#39;s return value. It
        # is necessary to mark cloned threads (in self._newfork) and send
        # child&#39;s fork() return value when they are scheduled for the
        # first time.
        def do_fork():
            self._threads.append(os_clone.current())
            self._newfork.add((pid := len(self._threads)) - 1)
            return 1000 + pid  # returned pid starts from 1000

        return &#123;&#39;fork&#39;: (lambda: do_fork())&#125;
    else:
        return None  # overridden fork; this value is never used because
                     # os_clone is destroyed immediately after fork()

@syscall
def sys_sched(self):
    &quot;&quot;&quot;Return a non-deterministic context switch to a runnable thread.&quot;&quot;&quot;
    return &#123;
        f&#39;t&#123;i+1&#125;&#39;: (lambda i=i: self._switch_to(i))
            for i, th in enumerate(self._threads)
                if th.context.gi_frame is not None  # thread still alive?
    &#125;
</code></pre><h3 id="2-3-2-Virtual-character-device-byte-stream"><a href="#2-3-2-Virtual-character-device-byte-stream" class="headerlink" title="2.3.2 Virtual character device (byte stream)"></a>2.3.2 Virtual character device (byte stream)</h3><pre><code>@syscall
def sys_choose(self, choices):
    &quot;&quot;&quot;Return a non-deterministic value from choices.&quot;&quot;&quot;
    return &#123;f&#39;choose &#123;c&#125;&#39;: (lambda c=c: c) for c in choices&#125;

@syscall
def sys_write(self, *args):
    &quot;&quot;&quot;Write strings (space separated) to stdout.&quot;&quot;&quot;
    def do_write():
        self._stdout += &#39; &#39;.join(str(arg) for arg in args)
    return &#123;&#39;write&#39;: (lambda: do_write())&#125;
</code></pre><h3 id="2-3-3-Virtual-block-storage-device"><a href="#2-3-3-Virtual-block-storage-device" class="headerlink" title="2.3.3 Virtual block storage device"></a>2.3.3 Virtual block storage device</h3><pre><code>@syscall
def sys_bread(self, key):
    &quot;&quot;&quot;Return the specific key&#39;s associated value in block device.&quot;&quot;&quot;
    storage = self._storage
    return &#123;&#39;bread&#39;: (lambda:
        storage.buf.get(key,  # always try to read from buffer first
            storage.persist.get(key, None)  # and then persistent storage
        )
    )&#125;

@syscall
def sys_bwrite(self, key, value):
    &quot;&quot;&quot;Write (key, value) pair to block device&#39;s buffer.&quot;&quot;&quot;
    def do_bwrite():
        self._storage.buf[key] = value
    return &#123;&#39;bwrite&#39;: (lambda: do_bwrite())&#125;

@syscall
def sys_sync(self):
    &quot;&quot;&quot;Persist all buffered writes.&quot;&quot;&quot;
    def do_sync():
        store = self._storage
        self._storage = Storage(
            persist=store.persist | store.buf,  # write back
            buf=&#123;&#125;
        )
    return &#123;&#39;sync&#39;: (lambda: do_sync())&#125;

@syscall
def sys_crash(self):
    &quot;&quot;&quot;Simulate a system crash that non-deterministically persists
    outstanding writes in the buffer.
    &quot;&quot;&quot;
    persist = self._storage.persist
    btrace = self._storage.buf.items()  # block trace

    crash_sites = (
        lambda subset=subset:
            setattr(self, &#39;_storage&#39;,
                Storage(  # persist only writes in the subset
                    persist=persist | dict(compress(btrace, subset)),
                    buf=&#123;&#125;
                )
            ) for subset in  # Mosaic allows persisting any subset of
                product(     # pending blocks in the buffer
                    *([(0, 1)] * len(btrace))
                )
    )
    return dict(enumerate(crash_sites))
</code></pre><h3 id="2-4-Operating-system-as-a-state-machine"><a href="#2-4-Operating-system-as-a-state-machine" class="headerlink" title="2.4 Operating system as a state machine"></a>2.4 Operating system as a state machine</h3><pre><code>def replay(self, trace: list) -&gt; dict:
    &quot;&quot;&quot;Replay an execution trace and return the resulting state.&quot;&quot;&quot;
    for choice in trace:
        self._step(choice)
    return self.state_dump()

def _step(self, choice, fork_child=False):
    self._switch_to(self._current)
    self._trace.append(choice)  # keep all choices for replay-based fork()
    action = self._choices[choice]  # return value of sys_xxx: a lambda
    res = action()

    try:  # Execute current thread for one step
        func, args = self.current().context.send(res)
        assert func in SYSCALLS
        self._choices = getattr(self, func)(*args)
    except StopIteration:  # ... and thread terminates
        self._choices = self.sys_sched()

    # At this point, the operating system&#39;s state is
    #   (self._threads, self._current, self._stdout, self._storage)
    # and outgoing transitions are saved in self._choices.
</code></pre><h3 id="2-5-Misc-and-helper-functions"><a href="#2-5-Misc-and-helper-functions" class="headerlink" title="2.5 Misc and helper functions"></a>2.5 Misc and helper functions</h3><pre><code>def state_dump(self) -&gt; dict:
    &quot;&quot;&quot;Create a serializable Mosaic state dump with hash code.&quot;&quot;&quot;
    heaps = &#123;&#125;
    for th in self._threads:
        if (i := id(th.heap)) not in heaps:  # unique heaps
            heaps[i] = len(heaps) + 1

    os_state = &#123;
        &#39;current&#39;: self._current,
        &#39;choices&#39;: sorted(list(self._choices.keys())),
        &#39;contexts&#39;: [
            &#123;
                &#39;heap&#39;: heaps[id(th.heap)],  # the unique heap id
                &#39;pc&#39;: th.context.gi_frame.f_lineno,
                &#39;locals&#39;: th.context.gi_frame.f_locals,
            &#125; if th.context.gi_frame is not None else None
                for th in self._threads
        ],
        &#39;heaps&#39;: &#123;
            heaps[id(th.heap)]: th.heap.__dict__
                for th in self._threads
        &#125;,
        &#39;stdout&#39;: self._stdout,
        &#39;store_persist&#39;: self._storage.persist,
        &#39;store_buffer&#39;: self._storage.buf,
    &#125;

    h = hash(json.dumps(os_state, sort_keys=True)) + 2**63
    return (copy.deepcopy(os_state)  # freeze the runtime state
            | dict(hashcode=f&#39;&#123;h:016x&#125;&#39;))

def current(self) -&gt; Thread:
    &quot;&quot;&quot;Return the current running thread object.&quot;&quot;&quot;
    return self._threads[self._current]

def _switch_to(self, tid: int):
    self._current = tid
    globals()[&#39;os&#39;] = self
    globals()[&#39;heap&#39;] = self.current().heap
    if tid in self._newfork:
        self._newfork.remove(tid)  # tricky: forked process must receive 0
        return 0                   # to indicate a child
</code></pre><h2 id="3-The-Mosaic-runtime"><a href="#3-The-Mosaic-runtime" class="headerlink" title="3. The Mosaic runtime"></a>3. The Mosaic runtime</h2><p>class Mosaic:<br>    â€œâ€â€The operating system interpreter and model checker.</p>
<pre><code>The operating system model is a state transition system: os.replay()
maps any trace to a state (with its outgoing transitions). Based
on this model, two state space explorers are implemented:

- run:   Choose outgoing transitions uniformly at random, yielding a
         single execution trace.
- check: Exhaustively explore all reachable states by a breadth-
         first search. Duplicated states are not visited twice.

Both explorers produce the visited portion of the state space as a
serializable object containing:

- source:   The application source code
- vertices: A list of operating system state dumps. The first vertex
            in the list is the initial state. Each vertex has a
            unique &quot;hashcode&quot; id.
- edges:    A list of 3-tuples: (source, target, label) denoting an 
            explored source --[label]-&gt; target edge. Both source and
            target are state hashcode ids.
&quot;&quot;&quot;
</code></pre><h3 id="3-1-Model-interpreter-and-checker"><a href="#3-1-Model-interpreter-and-checker" class="headerlink" title="3.1 Model interpreter and checker"></a>3.1 Model interpreter and checker</h3><pre><code>def run(self) -&gt; dict:
    &quot;&quot;&quot;Interpret the model with non-deterministic choices.&quot;&quot;&quot;
    os = OperatingSystem(self.entry)
    V, E = [os.state_dump() | dict(depth=0)], []

    while (choices := V[-1][&#39;choices&#39;]):
        choice = random.choice(choices)  # uniformly at random
        V.append(os.replay([choice]) | dict(depth=len(V)))
        E.append((V[-2][&#39;hashcode&#39;], V[-1][&#39;hashcode&#39;], choice))

    return dict(source=self.src, vertices=V, edges=E)

def check(self) -&gt; dict:
    &quot;&quot;&quot;Exhaustively explore the state space.&quot;&quot;&quot;
    class State:
        entry = self.entry

        def __init__(self, trace):
            self.trace = trace
            self.state = OperatingSystem(State.entry).replay(trace)
            self.state |= dict(depth=0)
            self.hashcode = self.state[&#39;hashcode&#39;]

        def extend(self, c):
            st = State(self.trace + (c,))
            st.state = st.state | dict(depth=self.state[&#39;depth&#39;] + 1)
            return st

    st0 = State(tuple())  # initial state of empty trace
    queued, V, E = [st0], &#123;st0.hashcode: st0.state&#125;, []

    while queued:
        st = queued.pop(0)
        for choice in st.state[&#39;choices&#39;]:
            st1 = st.extend(choice)
            if st1.hashcode not in V:  # found an unexplored state
                V[st1.hashcode] = st1.state
                queued.append(st1)
            E.append((st.hashcode, st1.hashcode, choice))

    return dict(
        source=self.src,
        vertices=sorted(V.values(), key=lambda st: st[&#39;depth&#39;]),
        edges=E
    )
</code></pre><h3 id="3-1-Source-code-parsing-and-rewriting"><a href="#3-1-Source-code-parsing-and-rewriting" class="headerlink" title="3.1 Source code parsing and rewriting"></a>3.1 Source code parsing and rewriting</h3><pre><code>class Transformer(ast.NodeTransformer):
    def visit_Call(self, node):
        # Rewrite system calls as yields
        if (isinstance(node.func, ast.Name) and
                node.func.id in SYSCALLS):  # rewrite system calls
            return ast.Yield(ast.Tuple(     #   -&gt; yield (&#39;sys_xxx&#39;, args)
                elts=[
                    ast.Constant(value=node.func.id),
                    ast.Tuple(elts=node.args),
                ]
            ))
        else:
            return node

def __init__(self, src: str):
    tree = ast.parse(src)
    hacked_ast = self.Transformer().visit(tree)
    hacked_src = ast.unparse(hacked_ast)

    context = &#123;&#125;
    exec(hacked_src, globals(), context)
    globals().update(context)

    self.src = src
    self.entry = context[&#39;main&#39;]  # must have a main()
</code></pre><h2 id="4-Utilities"><a href="#4-Utilities" class="headerlink" title="4. Utilities"></a>4. Utilities</h2><p>if <strong>name</strong> == â€˜<strong>main</strong>â€˜:<br>    parser = argparse.ArgumentParser(<br>        description=â€™The modeled operating system and state explorer.â€™<br>    )<br>    parser.add_argument(<br>        â€˜sourceâ€™,<br>        help=â€™application code (.py) to be checked; must have a main()â€™<br>    )<br>    parser.add_argument(â€˜-râ€™, â€˜â€”runâ€™, action=â€™store_trueâ€™)<br>    parser.add_argument(â€˜-câ€™, â€˜â€”checkâ€™, action=â€™store_trueâ€™)<br>    args = parser.parse_args()</p>
<pre><code>src = Path(args.source).read_text()
mosaic = Mosaic(src)
if args.check:
    explored = mosaic.check()
else:
    explored = mosaic.run()  # run is the default option

# Serialize the explored states and write to stdout. This encourages piping
# the results to another tool following the UNIX philosophy. Examples:
#
#   mosaic --run foo.py | grep stdout | tail -n 1  # quick and dirty check
#   mosaic --check bar.py | fx  # or any other interactive visualizer
#
print(json.dumps(explored, ensure_ascii=False, indent=2))
</code></pre><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- hello.py</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>def hello(s):<br>    return fâ€™Hello, {s}\nâ€™</p>
<p>def main():<br>    sys_write(hello(â€˜OSâ€™))<br>    sys_write(hello(â€˜Worldâ€™))<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](../img/image-11-1024x408.png)è¿è¡Œç»“æœ</span><br><span class="line"></span><br><span class="line">è¾“å‡ºçš„jsonå†…å®¹å¦‚ä¸‹ï¼š</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>{<br>  â€œsourceâ€: â€œdef hello(s):\n    return fâ€™Hello, {s}\nâ€™\n\ndef main():\n    sys_write(hello(â€˜OSâ€™))\n    sys_write(hello(â€˜Worldâ€™))\nâ€,<br>  â€œverticesâ€: [<br>    {<br>      â€œcurrentâ€: 0,<br>      â€œchoicesâ€: [<br>        â€œmainâ€<br>      ],<br>      â€œcontextsâ€: [<br>        {<br>          â€œheapâ€: 1,<br>          â€œpcâ€: 4,<br>          â€œlocalsâ€: {}<br>        }<br>      ],<br>      â€œheapsâ€: {<br>        â€œ1â€: {}<br>      },<br>      â€œstdoutâ€: â€œâ€,<br>      â€œstore_persistâ€: {},<br>      â€œstore_bufferâ€: {},<br>      â€œhashcodeâ€: â€œ406bec4fbd4b5d4fâ€,<br>      â€œdepthâ€: 0<br>    },<br>    {<br>      â€œcurrentâ€: 0,<br>      â€œchoicesâ€: [<br>        â€œwriteâ€<br>      ],<br>      â€œcontextsâ€: [<br>        {<br>          â€œheapâ€: 1,<br>          â€œpcâ€: 5,<br>          â€œlocalsâ€: {}<br>        }<br>      ],<br>      â€œheapsâ€: {<br>        â€œ1â€: {}<br>      },<br>      â€œstdoutâ€: â€œâ€,<br>      â€œstore_persistâ€: {},<br>      â€œstore_bufferâ€: {},<br>      â€œhashcodeâ€: â€œ9e2e4498c1ff0567â€,<br>      â€œdepthâ€: 1<br>    },<br>    {<br>      â€œcurrentâ€: 0,<br>      â€œchoicesâ€: [<br>        â€œwriteâ€<br>      ],<br>      â€œcontextsâ€: [<br>        {<br>          â€œheapâ€: 1,<br>          â€œpcâ€: 6,<br>          â€œlocalsâ€: {}<br>        }<br>      ],<br>      â€œheapsâ€: {<br>        â€œ1â€: {}<br>      },<br>      â€œstdoutâ€: â€œHello, OS\nâ€,<br>      â€œstore_persistâ€: {},<br>      â€œstore_bufferâ€: {},<br>      â€œhashcodeâ€: â€œb2475d0bbff9b748â€,<br>      â€œdepthâ€: 2<br>    },<br>    {<br>      â€œcurrentâ€: 0,<br>      â€œchoicesâ€: [],<br>      â€œcontextsâ€: [<br>        null<br>      ],<br>      â€œheapsâ€: {<br>        â€œ1â€: {}<br>      },<br>      â€œstdoutâ€: â€œHello, OS\nHello, World\nâ€,<br>      â€œstore_persistâ€: {},<br>      â€œstore_bufferâ€: {},<br>      â€œhashcodeâ€: â€œ27f2e79cbd5a9d60â€,<br>      â€œdepthâ€: 3<br>    }<br>  ],<br>  â€œedgesâ€: [<br>    [<br>      â€œ406bec4fbd4b5d4fâ€,<br>      â€œ9e2e4498c1ff0567â€,<br>      â€œmainâ€<br>    ],<br>    [<br>      â€œ9e2e4498c1ff0567â€,<br>      â€œb2475d0bbff9b748â€,<br>      â€œwriteâ€<br>    ],<br>    [<br>      â€œb2475d0bbff9b748â€,<br>      â€œ27f2e79cbd5a9d60â€,<br>      â€œwriteâ€<br>    ]<br>  ]<br>}<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](../img/image-12-1024x592.png)å¯è§†åŒ–ç»“æœ</span><br><span class="line"></span><br><span class="line">![img](../img/image-13-1024x655.png)å¤šçº¿ç¨‹ç¨‹åºæœ€å°å€¼</span><br><span class="line"></span><br><span class="line"># å¹¶å‘1_å¤šå¤„ç†å™¨ç¼–ç¨‹_2023.3.7</span><br><span class="line"></span><br><span class="line">## å¤šå¤„ç†å™¨ç¼–ç¨‹å…¥é—¨</span><br><span class="line"></span><br><span class="line">æ“ä½œç³»ç»Ÿä½œä¸º â€œçŠ¶æ€æœºçš„ç®¡ç†è€…â€ï¼Œå¼•å…¥äº†å…±äº«çš„çŠ¶æ€</span><br><span class="line"></span><br><span class="line">- å¸¦æ¥äº†å¹¶å‘</span><br><span class="line">- (æ“ä½œç³»ç»Ÿæ˜¯æœ€æ—©çš„å¹¶å‘ç¨‹åº)</span><br><span class="line"></span><br><span class="line">å¯¹hello.pyï¼Œä¸åŒæ—¶é—´è¿è¡Œç»“æœä¸ä¸€è‡´</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>def Tprint(name):<br>  sys_write(fâ€™{name}â€™)</p>
<p>def main():<br>  for name in â€˜ABâ€™:<br>    sys_spawn(Tprint, name)<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](../img/image-145.png)è¿è¡Œç»“æœ</span><br><span class="line"></span><br><span class="line">### å¤šçº¿ç¨‹å…±äº«å†…å­˜å¹¶å‘</span><br><span class="line"></span><br><span class="line">çº¿ç¨‹ï¼šå…±äº«å†…å­˜çš„æ‰§è¡Œæµ</span><br><span class="line"></span><br><span class="line">- æ‰§è¡Œæµæ‹¥æœ‰ç‹¬ç«‹çš„å †æ ˆ/å¯„å­˜å™¨</span><br><span class="line"></span><br><span class="line">ç®€åŒ–çš„çº¿ç¨‹ API (thread.h)</span><br><span class="line"></span><br><span class="line">- ```</span><br><span class="line">  spawn(fn)</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>åˆ›å»ºä¸€ä¸ªå…¥å£å‡½æ•°æ˜¯ </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fn</span><br></pre></td></tr></table></figure>
<p> çš„çº¿ç¨‹ï¼Œå¹¶ç«‹å³å¼€å§‹æ‰§è¡Œ</p>
<ul>
<li><code>void fn(int tid) &#123; ... &#125;</code></li>
<li>å‚æ•° <code>tid</code> ä» 1 å¼€å§‹ç¼–å·</li>
</ul>
</li>
<li><p>è¡Œä¸ºï¼š<code>sys_spawn(fn, tid)</code></p>
</li>
</ul>
<ul>
<li>```<br>join()<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  - ç­‰å¾…æ‰€æœ‰è¿è¡Œçº¿ç¨‹çš„è¿”å› (ä¹Ÿå¯ä»¥ä¸è°ƒç”¨)</span><br><span class="line">  - è¡Œä¸ºï¼š`while (done != T) sys_sched()`</span><br><span class="line"></span><br><span class="line">hello.c</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="include-â€œthread-hâ€"><a href="#include-â€œthread-hâ€" class="headerlink" title="include â€œthread.hâ€"></a>include â€œthread.hâ€</h1></li>
</ul>
<p>void Thello(int id) {<br>  while (1) {<br>    printf(â€œ%câ€, â€œ_ABCDEFGHIJKLMNOPQRSTUVWXYZâ€[id]);<br>  }<br>}</p>
<p>int main() {<br>  for (int i = 0; i &lt; 10; i++) {<br>    create(Thello);<br>  }<br>}<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">thread.h</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h1 id="include-4"><a href="#include-4" class="headerlink" title="include "></a>include <stdlib.h></h1><h1 id="include-5"><a href="#include-5" class="headerlink" title="include "></a>include <stdio.h></h1><h1 id="include-6"><a href="#include-6" class="headerlink" title="include "></a>include <string.h></h1><h1 id="include-7"><a href="#include-7" class="headerlink" title="include "></a>include <stdatomic.h></h1><h1 id="include-8"><a href="#include-8" class="headerlink" title="include "></a>include <assert.h></h1><h1 id="include-9"><a href="#include-9" class="headerlink" title="include "></a>include <unistd.h></h1><h1 id="include-10"><a href="#include-10" class="headerlink" title="include "></a>include <pthread.h></h1><h1 id="define-NTHREAD-64"><a href="#define-NTHREAD-64" class="headerlink" title="define NTHREAD 64"></a>define NTHREAD 64</h1><p>enum { T_FREE = 0, T_LIVE, T_DEAD, };<br>struct thread {<br>  int id, status;<br>  pthread_t thread;<br>  void (*entry)(int);<br>};</p>
<p>struct thread tpool[NTHREAD], *tptr = tpool;</p>
<p>void <em>wrapper(void </em>arg) {<br>  struct thread <em>thread = (struct thread </em>)arg;<br>  thread-&gt;entry(thread-&gt;id);<br>  return NULL;<br>}</p>
<p>void create(void <em>fn) {<br>  assert(tptr - tpool &lt; NTHREAD);
  </em>tptr = (struct thread) {<br>    .id = tptr - tpool + 1,<br>    .status = T_LIVE,<br>    .entry = fn,<br>  };<br>  pthread_create(&amp;(tptr-&gt;thread), NULL, wrapper, tptr);<br>  ++tptr;<br>}</p>
<p>void join() {<br>  for (int i = 0; i &lt; NTHREAD; i++) {<br>    struct thread *t = &amp;tpool[i];<br>    if (t-&gt;status == T_LIVE) {<br>      pthread_join(t-&gt;thread, NULL);<br>      t-&gt;status = T_DEAD;<br>    }<br>  }<br>}</p>
<p><strong>attribute</strong>((destructor)) void cleanup() {<br>  join();<br>}<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](../img/image-146-1024x628.png)è¿è¡Œç»“æœ</span><br><span class="line"></span><br><span class="line">æŸ¥çœ‹cpuå‘ç°ï¼Œcpuå ç”¨è¾¾åˆ°800%ï¼Œè¯´æ˜å¯ä»¥ä½¿ç”¨å¤šå¤„ç†å™¨ã€‚</span><br><span class="line"></span><br><span class="line">![img](../img/image-147-1024x261.png)800%</span><br><span class="line"></span><br><span class="line">### å¤šçº¿ç¨‹å…±äº«å†…å­˜å¹¶å‘ï¼šå…¥é—¨</span><br><span class="line"></span><br><span class="line">å¤šå¤„ç†å™¨ç¼–ç¨‹ï¼šä¸€ä¸ª API æå®š</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h1 id="include-â€œthread-hâ€-1"><a href="#include-â€œthread-hâ€-1" class="headerlink" title="include â€œthread.hâ€"></a>include â€œthread.hâ€</h1><p>void Ta() { while (1) { printf(â€œaâ€); } }<br>void Tb() { while (1) { printf(â€œbâ€); } }</p>
<p>int main() {<br>  create(Ta);<br>  create(Tb);<br>}<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- è¿™ä¸ªç¨‹åºå¯ä»¥åˆ©ç”¨ç³»ç»Ÿä¸­çš„å¤šå¤„ç†å™¨</span><br><span class="line">  - æ“ä½œç³»ç»Ÿä¼šè‡ªåŠ¨æŠŠçº¿ç¨‹æ”¾ç½®åœ¨ä¸åŒçš„å¤„ç†å™¨ä¸Š</span><br><span class="line">  - CPU ä½¿ç”¨ç‡è¶…è¿‡äº† 100%</span><br><span class="line"></span><br><span class="line">### é—®å‡ºæ›´å¤šçš„é—®é¢˜</span><br><span class="line"></span><br><span class="line">`Ta` å’Œ `Tb` çœŸçš„å…±äº«å†…å­˜å—ï¼Ÿ</span><br><span class="line"></span><br><span class="line">- å¦‚ä½•è¯æ˜/å¦è¯è¿™ä»¶äº‹ï¼Ÿ</span><br><span class="line"></span><br><span class="line">å¦‚ä½•è¯æ˜çº¿ç¨‹å…·æœ‰ç‹¬ç«‹å †æ ˆ (ä»¥åŠç¡®å®šå †æ ˆçš„èŒƒå›´)ï¼Ÿ</span><br><span class="line"></span><br><span class="line">- è¾“å‡ºæ··ä¹±ï¼Œåº”è¯¥å¦‚ä½•å¤„ç†ï¼Ÿ</span><br><span class="line"></span><br><span class="line">æ›´å¤šçš„ â€œå¥½é—®é¢˜â€ å’Œè§£å†³</span><br><span class="line"></span><br><span class="line">- åˆ›å»ºçº¿ç¨‹ä½¿ç”¨çš„æ˜¯å“ªä¸ªç³»ç»Ÿè°ƒç”¨ï¼Ÿ</span><br><span class="line">- èƒ½ä¸èƒ½ç”¨ gdb è°ƒè¯•ï¼Ÿ</span><br><span class="line">  - åŸºæœ¬åŸåˆ™ï¼šæœ‰éœ€æ±‚ï¼Œå°±èƒ½åšåˆ° ([RTFM](https://sourceware.org/gdb/onlinedocs/gdb/Threads.html))</span><br><span class="line"></span><br><span class="line">stack-probe.c</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h1 id="include-â€œthread-hâ€-2"><a href="#include-â€œthread-hâ€-2" class="headerlink" title="include â€œthread.hâ€"></a>include â€œthread.hâ€</h1><h1 id="include-11"><a href="#include-11" class="headerlink" title="include "></a>include <stdint.h></h1><p>void <em> volatile low[64];<br>void </em> volatile high[64];</p>
<p>void update_range(int T, void *ptr) {<br>    if (ptr &lt; low[T]) low[T] = ptr;<br>    if (ptr &gt; high[T]) high[T] = ptr;<br>}</p>
<p>void probe(int T, int n) {<br>  update_range(T, &amp;n);<br>  long sz = (uintptr_t)high[T] - (uintptr_t)low[T];<br>  if (sz % 1024 &lt; 32) {<br>    printf(â€œStack(T%d) &gt;= %ld KB\nâ€, T, sz / 1024);<br>  }<br>  probe(T, n + 1);  // Infinite recursion<br>}</p>
<p>void Tprobe(int T) {<br>  low[T] = (void <em>)-1;<br>  high[T] = (void </em>)0;<br>  update_range(T, &amp;T);<br>  probe(T, 0);<br>}</p>
<p>int main() {<br>  setbuf(stdout, NULL);<br>  for (int i = 0; i &lt; 4; i++) {<br>    create(Tprobe);<br>  }<br>}<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](../img/image-148.png)ç»“æœ</span><br><span class="line"></span><br><span class="line">æœ€å¤š8192kbã€‚æ’åºåæœ€å¤§å¯ä»¥çœ‹åˆ°çš„æ˜¯8177ã€‚</span><br><span class="line"></span><br><span class="line">![img](../img/image-149.png)æ’åºåç»“æœ</span><br><span class="line"></span><br><span class="line">### `thread.h` èƒŒåï¼šPOSIX Threads</span><br><span class="line"></span><br><span class="line">æƒ³è¿›ä¸€æ­¥é…ç½®çº¿ç¨‹ï¼Ÿ</span><br><span class="line"></span><br><span class="line">- è®¾ç½®æ›´å¤§çš„çº¿ç¨‹æ ˆ</span><br><span class="line">- è®¾ç½® detach è¿è¡Œ (ä¸åœ¨è¿›ç¨‹ç»“æŸåè¢«æ€æ­»ï¼Œä¹Ÿä¸èƒ½ join)</span><br><span class="line">- â€¦â€¦</span><br><span class="line"></span><br><span class="line">POSIX ä¸ºæˆ‘ä»¬æä¾›äº†çº¿ç¨‹åº“ (pthreads)</span><br><span class="line"></span><br><span class="line">- `man 7 pthreads`</span><br><span class="line">- ç»ƒä¹ ï¼šæ”¹å†™ thread.hï¼Œä½¿å¾—çº¿ç¨‹æ‹¥æœ‰æ›´å¤§çš„æ ˆ</span><br><span class="line">  - å¯ä»¥ç”¨ stack probe çš„ç¨‹åºéªŒè¯</span><br><span class="line"></span><br><span class="line">## æ”¾å¼ƒ (1)ï¼šåŸå­æ€§</span><br><span class="line"></span><br><span class="line">### çŠ¶æ€æœºçš„éšå«å‡è®¾</span><br><span class="line"></span><br><span class="line">â€œä¸–ç•Œä¸Šåªæœ‰ä¸€ä¸ªçŠ¶æ€æœºâ€</span><br><span class="line"></span><br><span class="line">- æ²¡æœ‰å…¶ä»–ä»»ä½•äººèƒ½ â€œå¹²æ¶‰â€ ç¨‹åºçš„çŠ¶æ€</span><br><span class="line">- æ¨è®ºï¼šå¯¹å˜é‡çš„ load ä¸€å®šè¿”å›æœ¬çº¿ç¨‹æœ€åä¸€æ¬¡ store çš„å€¼</span><br><span class="line">  - è¿™ä¹Ÿæ˜¯ç¼–è¯‘ä¼˜åŒ–çš„åŸºæœ¬å‡è®¾</span><br><span class="line"></span><br><span class="line">ä½†å…±äº«å†…å­˜æ¨ç¿»äº†è¿™ä¸ªå‡è®¾</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>int Tworker() {<br>  printf(â€œ%d\nâ€, x);  // Global x<br>  printf(â€œ%d\nâ€, x);<br>}<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- å…¶ä»–çº¿ç¨‹éšæ—¶å¯ä»¥ä¿®æ”¹ </span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  x<br>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  - å¯¼è‡´ä¸¤æ¬¡å¯èƒ½è¯»åˆ°ä¸åŒçš„ `x`</span><br><span class="line"></span><br><span class="line">æ½˜å¤šæ‹‰çš„é­”ç›’å·²ç»æ‰“å¼€â€¦â€¦</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>unsigned int balance = 100;</p>
<p>int Talipay_withdraw(int amt) {<br>  if (balance &gt;= amt) {<br>    balance -= amt;<br>    return SUCCESS;<br>  } else {<br>    return FAIL;<br>  }<br>}<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ä¸¤ä¸ªçº¿ç¨‹å¹¶å‘æ”¯ä»˜ Â¥100 ä¼šå‘ç”Ÿä»€ä¹ˆ (ä»£ç æ¼”ç¤º)</span><br><span class="line"></span><br><span class="line">- è´¦æˆ·é‡Œä¼šå¤šå‡ºç”¨ä¸å®Œçš„é’±ï¼</span><br><span class="line">- Bug/æ¼æ´ä¸è·Ÿä½ å¼€ç©ç¬‘ï¼šMt. Gox Hack æŸå¤± 650,000 BTC</span><br><span class="line">  - æ—¶å€¼ ~$28,000,000,000</span><br><span class="line"></span><br><span class="line">alipay.c</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h1 id="include-â€œthread-hâ€-3"><a href="#include-â€œthread-hâ€-3" class="headerlink" title="include â€œthread.hâ€"></a>include â€œthread.hâ€</h1><p>unsigned long balance = 100;</p>
<p>void Alipay_withdraw(int amt) {<br>  if (balance &gt;= amt) {<br>    usleep(1);  // Unexpected delays<br>    balance -= amt;<br>  }<br>}</p>
<p>void Talipay(int id) {<br>  Alipay_withdraw(100);<br>}</p>
<p>int main() {<br>  create(Talipay);<br>  create(Talipay);<br>  join();<br>  printf(â€œbalance = %lu\nâ€, balance);<br>}<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](../img/image-150.png)è¿è¡Œç»“æœ</span><br><span class="line"></span><br><span class="line">### ä¾‹å­ï¼šDiablo I (1996)</span><br><span class="line"></span><br><span class="line">åœ¨æ¡èµ·è¦å¤åˆ¶ç‰©å“çš„ç¬é—´æ‹¿èµ· 1 å—é’±</span><br><span class="line"></span><br><span class="line">- 1 å—é’±ä¼šè¢« â€œè¦†ç›–â€ æˆæ¡èµ·çš„ç‰©å“</span><br><span class="line"></span><br><span class="line">&lt;video controls=&quot;&quot; src=&quot;https://jyywiki.cn/pages/OS/img/diablo-item-clone.mp4&quot;&gt;&lt;/video&gt;</span><br><span class="line"></span><br><span class="line">### ä¾‹å­ï¼šæ±‚å’Œ</span><br><span class="line"></span><br><span class="line">åˆ†ä¸¤ä¸ªçº¿ç¨‹ï¼Œè®¡ç®— 1+1+1+â€¦+11+1+1+â€¦+1 (å…±è®¡ 2*n* ä¸ª 1)</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h1 id="define-N-100000000"><a href="#define-N-100000000" class="headerlink" title="define N 100000000"></a>define N 100000000</h1><p>long sum = 0;</p>
<p>void Tsum() { for (int i = 0; i &lt; N; i++) sum++; }</p>
<p>int main() {<br>  create(Tsum);<br>  create(Tsum);<br>  join();<br>  printf(â€œsum = %ld\nâ€, sum);<br>}<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">å¯èƒ½çš„ç»“æœ</span><br><span class="line"></span><br><span class="line">- 119790390, 99872322 (ç»“æœå¯ä»¥æ¯” `N` è¿˜è¦å°), ...</span><br><span class="line">- ç›´æ¥ä½¿ç”¨æ±‡ç¼–æŒ‡ä»¤ä¹Ÿä¸è¡Œ</span><br><span class="line"></span><br><span class="line">![img](../img/image-151.png)ç»“æœ</span><br><span class="line"></span><br><span class="line">### æŒ‡ä»¤/ä»£ç æ‰§è¡ŒåŸå­æ€§å‡è®¾</span><br><span class="line"></span><br><span class="line">&gt; â€œå¤„ç†å™¨ä¸€æ¬¡æ‰§è¡Œä¸€æ¡æŒ‡ä»¤â€ çš„åŸºæœ¬å‡è®¾åœ¨ä»Šå¤©çš„è®¡ç®—æœºç³»ç»Ÿä¸Šä¸å†æˆç«‹ (æˆ‘ä»¬çš„æ¨¡å‹ä½œå‡ºäº†ç®€åŒ–çš„å‡è®¾)ã€‚</span><br><span class="line"></span><br><span class="line">å•å¤„ç†å™¨å¤šçº¿ç¨‹</span><br><span class="line"></span><br><span class="line">- çº¿ç¨‹åœ¨è¿è¡Œæ—¶å¯èƒ½è¢«ä¸­æ–­ï¼Œåˆ‡æ¢åˆ°å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ</span><br><span class="line"></span><br><span class="line">å¤šå¤„ç†å™¨å¤šçº¿ç¨‹</span><br><span class="line"></span><br><span class="line">- çº¿ç¨‹æ ¹æœ¬å°±æ˜¯å¹¶è¡Œæ‰§è¡Œçš„</span><br><span class="line"></span><br><span class="line">(å†å²) 1960sï¼Œå¤§å®¶äº‰å…ˆåœ¨å…±äº«å†…å­˜ä¸Šå®ç°åŸå­æ€§ (äº’æ–¥)</span><br><span class="line"></span><br><span class="line">- ä½†å‡ ä¹æ‰€æœ‰çš„å®ç°éƒ½æ˜¯é”™çš„ï¼Œç›´åˆ° [Dekker&#x27;s Algorithm](https://en.wikipedia.org/wiki/Dekker&#x27;s_algorithm)ï¼Œè¿˜åªèƒ½ä¿è¯ä¸¤ä¸ªçº¿ç¨‹çš„äº’æ–¥</span><br><span class="line"></span><br><span class="line">### æ”¾å¼ƒåŸå­æ€§å‡è®¾çš„åæœ</span><br><span class="line"></span><br><span class="line">`printf` è¿˜èƒ½åœ¨å¤šçº¿ç¨‹ç¨‹åºé‡Œè°ƒç”¨å—ï¼Ÿ</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>void thread1() { while (1) { printf(â€œaâ€); } }<br>void thread2() { while (1) { printf(â€œbâ€); } }<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">æˆ‘ä»¬éƒ½çŸ¥é“ printf æ˜¯æœ‰ç¼“å†²åŒºçš„ (ä¸ºä»€ä¹ˆï¼Ÿ)</span><br><span class="line"></span><br><span class="line">- å¦‚æœæ‰§è¡Œ `buf[pos++] = ch` (`pos` å…±äº«) ä¸å°± ğŸ’¥ äº†å—ï¼Ÿ</span><br><span class="line"></span><br><span class="line">## æ”¾å¼ƒ (2)ï¼šæ‰§è¡Œé¡ºåº</span><br><span class="line"></span><br><span class="line">åˆ†ä¸¤ä¸ªçº¿ç¨‹ï¼Œè®¡ç®— 1+1+1+â€¦+11+1+1+â€¦+1 (å…±è®¡ 2*n* ä¸ª 1)</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h1 id="define-N-100000000-1"><a href="#define-N-100000000-1" class="headerlink" title="define N 100000000"></a>define N 100000000</h1><p>long sum = 0;</p>
<p>void Tsum() { for (int i = 0; i &lt; N; i++) sum++; }</p>
<p>int main() {<br>  create(Tsum);<br>  create(Tsum);<br>  join();<br>  printf(â€œsum = %ld\nâ€, sum);<br>}<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">å¦‚æœæ·»åŠ ç¼–è¯‘ä¼˜åŒ–ï¼Ÿ</span><br><span class="line"></span><br><span class="line">- `-O1`: 100000000 ğŸ˜±ğŸ˜±</span><br><span class="line">- `-O2`: 200000000 ğŸ˜±ğŸ˜±ğŸ˜±</span><br><span class="line"></span><br><span class="line">![img](../img/image-152.png)ç»“æœ</span><br><span class="line"></span><br><span class="line">**ç¼–è¯‘å™¨ä»…å¯¹é¡ºåºæ‰§è¡Œçš„ç¨‹åºè´Ÿè´£ï¼**</span><br><span class="line"></span><br><span class="line">&gt; ç¼–è¯‘å™¨å¯¹å†…å­˜è®¿é—® â€œeventually consistentâ€ çš„å¤„ç†å¯¼è‡´å…±äº«å†…å­˜ä½œä¸ºçº¿ç¨‹åŒæ­¥å·¥å…·çš„å¤±æ•ˆã€‚</span><br><span class="line"></span><br><span class="line">åˆšæ‰çš„ä¾‹å­</span><br><span class="line"></span><br><span class="line">- `-O1`: `R[eax] = sum; R[eax] += N; sum = R[eax]`</span><br><span class="line">- `-O2`: `sum += N;`</span><br><span class="line">- (ä½ çš„ç¼–è¯‘å™¨ä¹Ÿè®¸æ˜¯ä¸åŒçš„ç»“æœ)</span><br><span class="line"></span><br><span class="line">å¦ä¸€ä¸ªä¾‹å­</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>while (!done);<br>// would be optimized to<br>if (!done) while (1);<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### ä¿è¯æ‰§è¡Œé¡ºåº</span><br><span class="line"></span><br><span class="line">å›å¿† â€œç¼–è¯‘æ­£ç¡®æ€§â€</span><br><span class="line"></span><br><span class="line">- C çŠ¶æ€å’Œæ±‡ç¼–çŠ¶æ€æœºçš„ â€œå¯è§‚æµ‹è¡Œä¸ºç­‰ä»·â€</span><br><span class="line"></span><br><span class="line">- æ–¹æ³• 1ï¼šæ’å…¥ â€œä¸å¯ä¼˜åŒ–â€ ä»£ç </span><br><span class="line"></span><br><span class="line">  - ```</span><br><span class="line">    asm volatile (&quot;&quot; ::: &quot;memory&quot;);</span><br></pre></td></tr></table></figure></p>
<pre><code>- â€œClobbers memoryâ€
</code></pre><ul>
<li><p>æ–¹æ³• 2ï¼šæ ‡è®°å˜é‡ load/store ä¸ºä¸å¯ä¼˜åŒ–</p>
<ul>
<li>ä½¿ç”¨ <code>volatile</code> å˜é‡</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">extern int volatile done;</span><br><span class="line"></span><br><span class="line">while (!done) ;</span><br></pre></td></tr></table></figure>
<h2 id="æ”¾å¼ƒ-3-ï¼šå¤„ç†å™¨é—´çš„å¯è§æ€§"><a href="#æ”¾å¼ƒ-3-ï¼šå¤„ç†å™¨é—´çš„å¯è§æ€§" class="headerlink" title="æ”¾å¼ƒ (3)ï¼šå¤„ç†å™¨é—´çš„å¯è§æ€§"></a>æ”¾å¼ƒ (3)ï¼šå¤„ç†å™¨é—´çš„å¯è§æ€§</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">int x = 0, y = 0;</span><br><span class="line"></span><br><span class="line">void T1() &#123;</span><br><span class="line">  x = 1;  // Store(x)</span><br><span class="line">  __sync_synchronize();</span><br><span class="line">  printf(&quot;%d&quot;, y);  // Load(y)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void T2() &#123;</span><br><span class="line">  y = 1;  // Store(y)</span><br><span class="line">  __sync_synchronize();</span><br><span class="line">  printf(&quot;%d&quot;, x); // Load(x)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>éå†æ¨¡å‹å‘Šè¯‰æˆ‘ä»¬ï¼š01, 10, 11</p>
<ul>
<li>æœºå™¨æ°¸è¿œæ˜¯å¯¹çš„</li>
<li>Model checker çš„ç»“æœå’Œå®é™…çš„ç»“æœä¸åŒ â†’ å‡è®¾é”™äº†</li>
</ul>
<p>store-load.c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;thread.h&quot;</span><br><span class="line">#include &lt;stdatomic.h&gt;</span><br><span class="line"></span><br><span class="line">int x = 0, y = 0;</span><br><span class="line"></span><br><span class="line">atomic_int flag;</span><br><span class="line">#define FLAG atomic_load(&amp;flag)</span><br><span class="line">#define FLAG_XOR(val) atomic_fetch_xor(&amp;flag, val)</span><br><span class="line">#define WAIT_FOR(cond) while (!(cond)) ;</span><br><span class="line"></span><br><span class="line"> __attribute__((noinline))</span><br><span class="line">void write_x_read_y() &#123;</span><br><span class="line">  int y_val;</span><br><span class="line">  asm volatile(</span><br><span class="line">    &quot;movl $1, %0;&quot; // x = 1</span><br><span class="line">    &quot;movl %2, %1;&quot; // y_val = y</span><br><span class="line">    : &quot;=m&quot;(x), &quot;=r&quot;(y_val) : &quot;m&quot;(y)</span><br><span class="line">  );</span><br><span class="line">  printf(&quot;%d &quot;, y_val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> __attribute__((noinline))</span><br><span class="line">void write_y_read_x() &#123;</span><br><span class="line">  int x_val;</span><br><span class="line">  asm volatile(</span><br><span class="line">    &quot;movl $1, %0;&quot; // y = 1</span><br><span class="line">    &quot;movl %2, %1;&quot; // x_val = x</span><br><span class="line">    : &quot;=m&quot;(y), &quot;=r&quot;(x_val) : &quot;m&quot;(x)</span><br><span class="line">  );</span><br><span class="line">  printf(&quot;%d &quot;, x_val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void T1(int id) &#123;</span><br><span class="line">  while (1) &#123;</span><br><span class="line">    WAIT_FOR((FLAG &amp; 1));</span><br><span class="line">    write_x_read_y();</span><br><span class="line">    FLAG_XOR(1);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void T2() &#123;</span><br><span class="line">  while (1) &#123;</span><br><span class="line">    WAIT_FOR((FLAG &amp; 2));</span><br><span class="line">    write_y_read_x();</span><br><span class="line">    FLAG_XOR(2);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void Tsync() &#123;</span><br><span class="line">  while (1) &#123;</span><br><span class="line">    x = y = 0;</span><br><span class="line">    __sync_synchronize(); // full barrier</span><br><span class="line">    usleep(1);            // + delay</span><br><span class="line">    assert(FLAG == 0);</span><br><span class="line">    FLAG_XOR(3);</span><br><span class="line">    // T1 and T2 clear 0/1-bit, respectively</span><br><span class="line">    WAIT_FOR(FLAG == 0);</span><br><span class="line">    printf(&quot;\n&quot;); fflush(stdout);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">  create(T1);</span><br><span class="line">  create(T2);</span><br><span class="line">  create(Tsync);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶è€Œå®é™…è¾“å‡ºå¦‚ä¸‹ï¼Œ11å‡ºç°å¾—æå°‘ã€‚<br>1 0<br>0 1<br>0 0</p>
<p>è§£é‡Šï¼šèµ‹å€¼æ“ä½œä¸æ˜¯åŸå­æ€§ï¼Œloadæ“ä½œå¾€å¾€æ¯”storeå¿«ã€‚ä½¿å¾—ä¸¤è¾¹åŒæ—¶loadåˆ°0ã€‚</p>
<h3 id="ç°ä»£å¤„ç†å™¨ä¹Ÿæ˜¯-åŠ¨æ€-ç¼–è¯‘å™¨ï¼"><a href="#ç°ä»£å¤„ç†å™¨ä¹Ÿæ˜¯-åŠ¨æ€-ç¼–è¯‘å™¨ï¼" class="headerlink" title="ç°ä»£å¤„ç†å™¨ä¹Ÿæ˜¯ (åŠ¨æ€) ç¼–è¯‘å™¨ï¼"></a>ç°ä»£å¤„ç†å™¨ä¹Ÿæ˜¯ (åŠ¨æ€) ç¼–è¯‘å™¨ï¼</h3><p>é”™è¯¯ (ç®€åŒ–) çš„å‡è®¾</p>
<ul>
<li>ä¸€ä¸ª CPU æ‰§è¡Œä¸€æ¡æŒ‡ä»¤åˆ°è¾¾ä¸‹ä¸€çŠ¶æ€</li>
</ul>
<p>å®é™…çš„å®ç°</p>
<ul>
<li><p>ç”µè·¯å°†è¿ç»­çš„æŒ‡ä»¤ â€œç¼–è¯‘â€ æˆæ›´å°çš„ </p>
<p>Î¼</p>
<p>ops</p>
<ul>
<li>RF[9] = load(RF[7] + 400)</li>
<li>store(RF[12], RF[13])</li>
<li>RF[3] = RF[4] + RF[5]</li>
</ul>
</li>
</ul>
<p>åœ¨ä»»ä½•æ—¶åˆ»ï¼Œå¤„ç†å™¨éƒ½ç»´æŠ¤ä¸€ä¸ª <em>Î¼</em>op çš„ â€œæ± å­â€</p>
<ul>
<li>ä¸ç¼–è¯‘å™¨ä¸€æ ·ï¼Œåš â€œé¡ºåºæ‰§è¡Œâ€ å‡è®¾ï¼šæ²¡æœ‰å…¶ä»–å¤„ç†å™¨ â€œå¹²æ‰°â€</li>
<li>æ¯ä¸€å‘¨æœŸæ‰§è¡Œå°½å¯èƒ½å¤šçš„ <em>Î¼</em>op - å¤šè·¯å‘å°„ã€ä¹±åºæ‰§è¡Œã€æŒ‰åºæäº¤</li>
</ul>
<blockquote>
<p>æ»¡è¶³å•å¤„ç†å™¨ eventual memory consistency çš„æ‰§è¡Œï¼Œåœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸Šå¯èƒ½æ— æ³•åºåˆ—åŒ–ï¼</p>
</blockquote>
<p><img src="../img/image-154-1024x240.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">     # &lt;-----------+</span><br><span class="line">movl $1, (x)   #   |</span><br><span class="line">movl (y), %eax # --+</span><br></pre></td></tr></table></figure>
<ul>
<li>åœ¨å¤šå¤„ç†å™¨ä¸Šçš„è¡¨ç°<ul>
<li>ä¸¤ä¸ªå¤„ç†å™¨åˆ†åˆ«çœ‹åˆ°y=0å’Œ<em>x</em>=0</li>
</ul>
</li>
</ul>
<h3 id="å®½æ¾å†…å­˜æ¨¡å‹-Relaxed-Weak-Memory-Model"><a href="#å®½æ¾å†…å­˜æ¨¡å‹-Relaxed-Weak-Memory-Model" class="headerlink" title="å®½æ¾å†…å­˜æ¨¡å‹ (Relaxed/Weak Memory Model)"></a>å®½æ¾å†…å­˜æ¨¡å‹ (Relaxed/Weak Memory Model)</h3><blockquote>
<p>å®½æ¾å†…å­˜æ¨¡å‹çš„ç›®çš„æ˜¯ä½¿å•å¤„ç†å™¨çš„æ‰§è¡Œæ›´é«˜æ•ˆã€‚</p>
</blockquote>
<p>x86 å·²ç»æ˜¯å¸‚é¢ä¸Šèƒ½ä¹°åˆ°çš„ â€œæœ€å¼ºâ€ çš„å†…å­˜æ¨¡å‹äº† ğŸ˜‚</p>
<ul>
<li>è¿™ä¹Ÿæ˜¯ Intel è‡ªå·±ç»™è‡ªå·±åŠ çš„åŒ…è¢±</li>
<li>çœ‹çœ‹ <a target="_blank" rel="noopener" href="https://research.swtch.com/mem-weak@2x.png">ARM/RISC-V</a> å§ï¼Œæ ¹æœ¬å°±æ˜¯ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿ</li>
</ul>
<p><img src="../img/image-155.png" alt="img">(x86-TSO in <a target="_blank" rel="noopener" href="https://research.swtch.com/hwmm">Hardware memory models</a> by Russ Cox)</p>
<p><img src="../img/image-156.png" alt="img"><a target="_blank" rel="noopener" href="https://research.swtch.com/mem-weak@2x.png">ARM/RISC-V</a></p>
<p>soï¼Œè€è€å®å®åœ°ç”¨lockå’Œunlockã€‚</p>
<h1 id="å¹¶å‘2-å¹¶å‘æ§åˆ¶åŸºç¡€-2023-3-9"><a href="#å¹¶å‘2-å¹¶å‘æ§åˆ¶åŸºç¡€-2023-3-9" class="headerlink" title="å¹¶å‘2_å¹¶å‘æ§åˆ¶åŸºç¡€_2023.3.9"></a>å¹¶å‘2_å¹¶å‘æ§åˆ¶åŸºç¡€_2023.3.9</h1><h2 id="äº’æ–¥é—®é¢˜"><a href="#äº’æ–¥é—®é¢˜" class="headerlink" title="äº’æ–¥é—®é¢˜"></a>äº’æ–¥é—®é¢˜</h2><h3 id="å¹¶å‘ç¼–ç¨‹ï¼šä»å…¥é—¨åˆ°æ”¾å¼ƒ"><a href="#å¹¶å‘ç¼–ç¨‹ï¼šä»å…¥é—¨åˆ°æ”¾å¼ƒ" class="headerlink" title="å¹¶å‘ç¼–ç¨‹ï¼šä»å…¥é—¨åˆ°æ”¾å¼ƒ"></a>å¹¶å‘ç¼–ç¨‹ï¼šä»å…¥é—¨åˆ°æ”¾å¼ƒ</h3><p>äººç±»æ˜¯ sequential creature</p>
<ul>
<li>ç¼–è¯‘ä¼˜åŒ– + weak memory model å¯¼è‡´éš¾ä»¥ç†è§£çš„å¹¶å‘æ‰§è¡Œ</li>
<li>æœ‰å¤šéš¾ç†è§£å‘¢ï¼Ÿ<ul>
<li><a target="_blank" rel="noopener" href="https://epubs.siam.org/doi/10.1137/S0097539794279614">Verifying sequential consistency æ˜¯ NP-å®Œå…¨é—®é¢˜</a></li>
</ul>
</li>
</ul>
<p>äººç±»æ˜¯ (ä¸è½»è¨€æ”¾å¼ƒçš„) sequential creature</p>
<ul>
<li>æœ‰é—®é¢˜ï¼Œå°±ä¼šè¯•ç€å»è§£å†³</li>
<li>æ‰‹æ®µï¼šâ€œå›é€€åˆ°â€ é¡ºåºæ‰§è¡Œ<ul>
<li>æ ‡è®°è‹¥å¹²å—ä»£ç ï¼Œä½¿å¾—è¿™äº›ä»£ç ä¸€å®šèƒ½æŒ‰æŸä¸ªé¡ºåºæ‰§è¡Œ</li>
<li>ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°åœ¨å—é‡Œè®°å½•æ‰§è¡Œçš„é¡ºåº</li>
</ul>
</li>
</ul>
<h3 id="å›é€€åˆ°é¡ºåºæ‰§è¡Œï¼šäº’æ–¥"><a href="#å›é€€åˆ°é¡ºåºæ‰§è¡Œï¼šäº’æ–¥" class="headerlink" title="å›é€€åˆ°é¡ºåºæ‰§è¡Œï¼šäº’æ–¥"></a>å›é€€åˆ°é¡ºåºæ‰§è¡Œï¼šäº’æ–¥</h3><p>æ’å…¥ â€œç¥ç§˜ä»£ç â€ï¼Œä½¿å¾—æ‰€æœ‰å…¶ä»– â€œç¥ç§˜ä»£ç â€ éƒ½ä¸èƒ½å¹¶å‘</p>
<ul>
<li>ç”± â€œç¥ç§˜ä»£ç â€ é¢†å¯¼ä¸ä¼šå¹¶å‘çš„ä»£ç  (ä¾‹å¦‚ pure functions) æ‰§è¡Œ</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">void Tsum() &#123;</span><br><span class="line">  stop_the_world();</span><br><span class="line">  // ä¸´ç•ŒåŒº critical section</span><br><span class="line">  sum++;</span><br><span class="line">  resume_the_world();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Stop the world çœŸçš„æ˜¯å¯èƒ½çš„</p>
<ul>
<li>Java æœ‰ â€œstop the world GCâ€</li>
<li>å•ä¸ªå¤„ç†å™¨å¯ä»¥å…³é—­ä¸­æ–­</li>
<li>å¤šä¸ªå¤„ç†å™¨ä¹Ÿå¯ä»¥å‘é€æ ¸é—´ä¸­æ–­</li>
</ul>
<h3 id="å¤±è´¥çš„å°è¯•"><a href="#å¤±è´¥çš„å°è¯•" class="headerlink" title="å¤±è´¥çš„å°è¯•"></a>å¤±è´¥çš„å°è¯•</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">int locked = UNLOCK;</span><br><span class="line"></span><br><span class="line">void critical_section() &#123;</span><br><span class="line">retry:</span><br><span class="line">  if (locked != UNLOCK) &#123;</span><br><span class="line">    goto retry;</span><br><span class="line">  &#125;</span><br><span class="line">  locked = LOCK;</span><br><span class="line"></span><br><span class="line">  // critical section</span><br><span class="line"></span><br><span class="line">  locked = UNLOCK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å’Œ â€œå±±å¯¨æ”¯ä»˜å®â€ å®Œå…¨ä¸€æ ·çš„é”™è¯¯</p>
<ul>
<li>å¹¶å‘ç¨‹åºä¸èƒ½ä¿è¯ load + store çš„åŸå­æ€§</li>
</ul>
<p><img src="../img/image-163.png" alt="img">å‡ºé”™</p>
<h3 id="æ›´ä¸¥è‚ƒåœ°å°è¯•ï¼šç¡®å®šå‡è®¾ã€è®¾è®¡ç®—æ³•"><a href="#æ›´ä¸¥è‚ƒåœ°å°è¯•ï¼šç¡®å®šå‡è®¾ã€è®¾è®¡ç®—æ³•" class="headerlink" title="æ›´ä¸¥è‚ƒåœ°å°è¯•ï¼šç¡®å®šå‡è®¾ã€è®¾è®¡ç®—æ³•"></a>æ›´ä¸¥è‚ƒåœ°å°è¯•ï¼šç¡®å®šå‡è®¾ã€è®¾è®¡ç®—æ³•</h3><p>å‡è®¾ï¼šå†…å­˜çš„è¯»/å†™å¯ä»¥ä¿è¯é¡ºåºã€åŸå­å®Œæˆ</p>
<ul>
<li><p>```<br>val = atomic_load(ptr)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  - å¯¹åº”å¾€æŸä¸ªåœ°æ–¹ â€œè´´ä¸€å¼ çº¸æ¡â€ (å¿…é¡»é—­çœ¼ç›²è´´)</span><br><span class="line">  - è´´å®Œä¸€ç¬é—´å°±å¯èƒ½è¢«åˆ«äººè¦†ç›–</span><br><span class="line"></span><br><span class="line">- ```</span><br><span class="line">  atomic_store(ptr, val)</span><br></pre></td></tr></table></figure>
<ul>
<li>çœ‹ä¸€çœ¼æŸä¸ªåœ°æ–¹çš„å­—æ¡ (åªèƒ½çœ‹åˆ°ç¬é—´çš„å­—)</li>
<li>åˆšçœ‹å®Œå°±å¯èƒ½è¢«æ”¹æ‰</li>
</ul>
</li>
</ul>
<p>å¯¹åº”äº model checker</p>
<ul>
<li>æ¯ä¸€è¡Œå¯ä»¥æ‰§è¡Œä¸€æ¬¡å…¨å±€å˜é‡è¯»æˆ–å†™</li>
<li>æ¯ä¸ªæ“ä½œæ‰§è¡Œä¹‹åéƒ½å‘ç”Ÿ <code>sys_sched()</code></li>
</ul>
<h3 id="æ­£ç¡®æ€§ä¸æ˜çš„å¥‡æ€ªå°è¯•-Peterson-ç®—æ³•"><a href="#æ­£ç¡®æ€§ä¸æ˜çš„å¥‡æ€ªå°è¯•-Peterson-ç®—æ³•" class="headerlink" title="æ­£ç¡®æ€§ä¸æ˜çš„å¥‡æ€ªå°è¯• (Peterson ç®—æ³•)"></a>æ­£ç¡®æ€§ä¸æ˜çš„å¥‡æ€ªå°è¯• (Peterson ç®—æ³•)</h3><p>A å’Œ B äº‰ç”¨å•æ‰€çš„åŒ…å¢</p>
<ul>
<li><p>æƒ³è¿›å…¥åŒ…å¢ä¹‹å‰ï¼ŒA/B éƒ½é¦–å…ˆä¸¾èµ·è‡ªå·±çš„æ——å­</p>
<ul>
<li>A å¾€å•æ‰€é—¨ä¸Šè´´ä¸Š â€œB æ­£åœ¨ä½¿ç”¨â€ çš„æ ‡ç­¾</li>
<li>B å¾€å•æ‰€é—¨ä¸Šè´´ä¸Š â€œA æ­£åœ¨ä½¿ç”¨â€ çš„æ ‡ç­¾</li>
</ul>
</li>
<li><p>ç„¶åï¼Œ</p>
<p>å¦‚æœå¯¹æ–¹ä¸¾ç€æ——ï¼Œä¸”é—¨ä¸Šçš„åå­—æ˜¯å¯¹æ–¹</p>
<p>ï¼Œç­‰å¾…</p>
<ul>
<li>å¦åˆ™å¯ä»¥è¿›å…¥åŒ…å¢</li>
</ul>
</li>
<li><p>å‡ºåŒ…å¢åï¼Œæ”¾ä¸‹è‡ªå·±çš„æ——å­ (å®Œå…¨ä¸ç®¡é—¨ä¸Šçš„æ ‡ç­¾)</p>
</li>
</ul>
<h3 id="ä¹ é¢˜ï¼šè¯æ˜-Peterson-ç®—æ³•æ­£ç¡®ï¼Œæˆ–ç»™å‡ºåä¾‹"><a href="#ä¹ é¢˜ï¼šè¯æ˜-Peterson-ç®—æ³•æ­£ç¡®ï¼Œæˆ–ç»™å‡ºåä¾‹" class="headerlink" title="ä¹ é¢˜ï¼šè¯æ˜ Peterson ç®—æ³•æ­£ç¡®ï¼Œæˆ–ç»™å‡ºåä¾‹"></a>ä¹ é¢˜ï¼šè¯æ˜ Peterson ç®—æ³•æ­£ç¡®ï¼Œæˆ–ç»™å‡ºåä¾‹</h3><p>è¿›å…¥ä¸´ç•ŒåŒºçš„æƒ…å†µ</p>
<ul>
<li>å¦‚æœåªæœ‰ä¸€ä¸ªäººä¸¾æ——ï¼Œä»–å°±å¯ä»¥ç›´æ¥è¿›å…¥</li>
<li>å¦‚æœä¸¤ä¸ªäººåŒæ—¶ä¸¾æ——ï¼Œç”±å•æ‰€é—¨ä¸Šçš„æ ‡ç­¾å†³å®šè°è¿›<ul>
<li>æ‰‹å¿« ğŸˆ¶ï¸ (è¢«å¦ä¸€ä¸ªäººçš„æ ‡ç­¾è¦†ç›–)ã€æ‰‹æ…¢ ğŸˆš</li>
</ul>
</li>
</ul>
<p>ä¸€äº›å…·ä½“çš„ç»†èŠ‚æƒ…å†µ</p>
<ul>
<li>A çœ‹åˆ° B æ²¡æœ‰ä¸¾æ——<ul>
<li>B ä¸€å®šä¸åœ¨ä¸´ç•ŒåŒº</li>
<li>æˆ–è€… B æƒ³è¿›ä½†è¿˜æ²¡æ¥å¾—åŠæŠŠ â€œA æ­£åœ¨ä½¿ç”¨â€ è´´åœ¨é—¨ä¸Š</li>
</ul>
</li>
<li>A çœ‹åˆ° B ä¸¾æ——å­<ul>
<li>A ä¸€å®šå·²ç»æŠŠæ——å­ä¸¾èµ·æ¥äº†</li>
<li>(<em>!@^#</em>&amp;!%^(&amp;^!@%#</li>
</ul>
</li>
</ul>
<h3 id="ç»•æ¥ç»•å»å¾ˆå®¹æ˜“æœ‰é”™æ¼çš„æƒ…å†µ"><a href="#ç»•æ¥ç»•å»å¾ˆå®¹æ˜“æœ‰é”™æ¼çš„æƒ…å†µ" class="headerlink" title="ç»•æ¥ç»•å»å¾ˆå®¹æ˜“æœ‰é”™æ¼çš„æƒ…å†µ"></a>ç»•æ¥ç»•å»å¾ˆå®¹æ˜“æœ‰é”™æ¼çš„æƒ…å†µ</h3><p>Prove by brute-force</p>
<ul>
<li>æšä¸¾çŠ¶æ€æœºçš„å…¨éƒ¨çŠ¶æ€(<em>P**C</em>1,<em>P**C</em>2,<em>x</em>,<em>y</em>,<em>t<strong>u</strong>r**n</em>)</li>
<li>ä½†æ‰‹å†™è¿˜æ˜¯å¾ˆå®¹æ˜“é”™å•Šâ€”â€”å¯æ‰§è¡Œçš„çŠ¶æ€æœºæ¨¡å‹æœ‰ç”¨äº†ï¼</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">void TA() &#123; while (1) &#123;</span><br><span class="line">/* â¶ */  x = 1;</span><br><span class="line">/* â· */  turn = B;</span><br><span class="line">/* â¸ */  while (y &amp;&amp; turn == B) ;</span><br><span class="line">/* â¹ */  x = 0; &#125; &#125;</span><br><span class="line"></span><br><span class="line">void TB() &#123; while (1) &#123;</span><br><span class="line">/* â‘  */  y = 1;</span><br><span class="line">/* â‘¡ */  turn = A;</span><br><span class="line">/* â‘¢ */  while (x &amp;&amp; turn == A) ;</span><br><span class="line">/* â‘£ */  y = 0; &#125; &#125;</span><br></pre></td></tr></table></figure>
<h2 id="æ¨¡å‹ã€æ¨¡å‹æ£€éªŒä¸ç°å®"><a href="#æ¨¡å‹ã€æ¨¡å‹æ£€éªŒä¸ç°å®" class="headerlink" title="æ¨¡å‹ã€æ¨¡å‹æ£€éªŒä¸ç°å®"></a>æ¨¡å‹ã€æ¨¡å‹æ£€éªŒä¸ç°å®</h2><h3 id="â€œPush-buttonâ€-Verification-ğŸ–"><a href="#â€œPush-buttonâ€-Verification-ğŸ–" class="headerlink" title="â€œPush-buttonâ€ Verification ğŸ–"></a>â€œPush-buttonâ€ Verification ğŸ–</h3><blockquote>
<p>æˆ‘ä»¬ (åœ¨å®Œå…¨ä¸ç†è§£ç®—æ³•çš„å‰æä¸‹) è¯æ˜äº† Sequential å†…å­˜æ¨¡å‹ä¸‹ Petersonâ€™s Protocol çš„ Safetyã€‚å®ƒèƒ½å¤Ÿå®ç°äº’æ–¥ã€‚</p>
</blockquote>
<p>å¹¶å‘ç¼–ç¨‹æ¯”å¤§å®¶æƒ³è±¡å¾—å›°éš¾</p>
<ul>
<li>æ„Ÿå—ä¸€ä¸‹ <a target="_blank" rel="noopener" href="https://series1.github.io/blog/dekkers-algorithm/">Dekkerâ€™s Algorithm</a></li>
<li>â€œ<a target="_blank" rel="noopener" href="https://zoo.cs.yale.edu/classes/cs323/doc/Peterson.pdf">Myths about the mutual exclusion problem</a>â€ (IPL, 1981)</li>
</ul>
<p><img src="../img/peterson-paper.png" alt="img"></p>
<h3 id="è‡ªåŠ¨éå†çŠ¶æ€ç©ºé—´çš„ä¹è¶£"><a href="#è‡ªåŠ¨éå†çŠ¶æ€ç©ºé—´çš„ä¹è¶£" class="headerlink" title="è‡ªåŠ¨éå†çŠ¶æ€ç©ºé—´çš„ä¹è¶£"></a>è‡ªåŠ¨éå†çŠ¶æ€ç©ºé—´çš„ä¹è¶£</h3><p>å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå›ç­”æ›´å¤šé—®é¢˜</p>
<ul>
<li>å¦‚æœç»“æŸåæŠŠé—¨ä¸Šçš„å­—æ¡æ’•æ‰ï¼Œç®—æ³•è¿˜æ­£ç¡®å—ï¼Ÿ<ul>
<li>åœ¨æ”¾ä¸‹æ——å­ä¹‹å‰æ’•</li>
<li>åœ¨æ”¾ä¸‹æ——å­ä¹‹åæ’•</li>
</ul>
</li>
<li>å¦‚æœå…ˆè´´æ ‡ç­¾å†ä¸¾æ——ï¼Œç®—æ³•è¿˜æ­£ç¡®å—ï¼Ÿ</li>
<li>æˆ‘ä»¬æœ‰ä¸¤ä¸ª â€œæŸ¥çœ‹â€ çš„æ“ä½œ<ul>
<li>çœ‹å¯¹æ–¹çš„æ——æœ‰æ²¡æœ‰ä¸¾èµ·æ¥</li>
<li>çœ‹é—¨ä¸Šçš„è´´çº¸æ˜¯ä¸æ˜¯è‡ªå·±</li>
<li>è¿™ä¸¤ä¸ªæ“ä½œçš„é¡ºåºå½±å“ç®—æ³•çš„æ­£ç¡®æ€§å—ï¼Ÿ</li>
</ul>
</li>
<li>æ˜¯å¦å­˜åœ¨ â€œä¸¤ä¸ªäººè°éƒ½æ— æ³•è¿›å…¥ä¸´ç•ŒåŒºâ€ (liveness)ã€â€œå¯¹æŸä¸€æ–¹ä¸å…¬å¹³â€ (fairness) ç­‰è¡Œä¸ºï¼Ÿ<ul>
<li>éƒ½è½¬æ¢æˆå›¾ (çŠ¶æ€ç©ºé—´) ä¸Šçš„éå†é—®é¢˜äº†ï¼</li>
</ul>
</li>
</ul>
<p>peterson.py</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">def T1():</span><br><span class="line">  while True:</span><br><span class="line">    heap.x = &#x27;ğŸ´&#x27;</span><br><span class="line">    sys_sched()</span><br><span class="line">    heap.turn = &#x27;â·&#x27;</span><br><span class="line">    sys_sched()</span><br><span class="line">    while True:</span><br><span class="line">      t = heap.turn</span><br><span class="line">      sys_sched()</span><br><span class="line">      y = heap.y != &#x27;&#x27;</span><br><span class="line">      sys_sched()</span><br><span class="line">      if not y or t == &#x27;â¶&#x27;:</span><br><span class="line">        break</span><br><span class="line">    sys_sched()</span><br><span class="line">    heap.cs += &#x27;â¶&#x27;</span><br><span class="line">    sys_sched()</span><br><span class="line">    heap.cs = heap.cs.replace(&#x27;â¶&#x27;, &#x27;&#x27;)</span><br><span class="line">    sys_sched()</span><br><span class="line">    heap.x = &#x27;&#x27;</span><br><span class="line">    sys_sched()</span><br><span class="line"> </span><br><span class="line">def T2():</span><br><span class="line">  while True:</span><br><span class="line">    heap.y = &#x27;ğŸ&#x27;</span><br><span class="line">    sys_sched()</span><br><span class="line">    heap.turn = &#x27;â¶&#x27;</span><br><span class="line">    sys_sched()</span><br><span class="line">    while True:</span><br><span class="line">      t = heap.turn</span><br><span class="line">      sys_sched()</span><br><span class="line">      x = heap.x</span><br><span class="line">      sys_sched()</span><br><span class="line">      if not x or t == &#x27;â·&#x27;:</span><br><span class="line">        break</span><br><span class="line">      sys_sched()</span><br><span class="line">    sys_sched()</span><br><span class="line">    heap.cs += &#x27;â·&#x27;</span><br><span class="line">    sys_sched()</span><br><span class="line">    heap.cs = heap.cs.replace(&#x27;â·&#x27;, &#x27;&#x27;)</span><br><span class="line">    sys_sched()</span><br><span class="line">    heap.y = &#x27;&#x27;</span><br><span class="line">    sys_sched()</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">  heap.x = &#x27;&#x27;</span><br><span class="line">  heap.y = &#x27;&#x27;</span><br><span class="line">  heap.turn = &#x27;&#x27;</span><br><span class="line">  heap.cs = &#x27;&#x27;</span><br><span class="line">  sys_spawn(T1)</span><br><span class="line">  sys_spawn(T2)</span><br></pre></td></tr></table></figure>
<p><img src="../img/image-164-1024x236.png" alt="img">éªŒè¯äº†æ­£ç¡®æ€§</p>
<h3 id="ä»æ¨¡å‹å›åˆ°ç°å®â€¦â€¦"><a href="#ä»æ¨¡å‹å›åˆ°ç°å®â€¦â€¦" class="headerlink" title="ä»æ¨¡å‹å›åˆ°ç°å®â€¦â€¦"></a>ä»æ¨¡å‹å›åˆ°ç°å®â€¦â€¦</h3><p>å›åˆ°æˆ‘ä»¬çš„å‡è®¾ (ä½“ç°åœ¨æ¨¡å‹)</p>
<ul>
<li>Atomic load &amp; store<ul>
<li>è¯»/å†™å•ä¸ªå…¨å±€å˜é‡æ˜¯ â€œåŸå­ä¸å¯åˆ†å‰²â€ çš„</li>
<li>ä½†è¿™ä¸ªå‡è®¾åœ¨ç°ä»£å¤šå¤„ç†å™¨ä¸Šå¹¶ä¸æˆç«‹</li>
</ul>
</li>
<li>æ‰€ä»¥å®é™…ä¸ŠæŒ‰ç…§æ¨¡å‹ç›´æ¥å†™ Peterson ç®—æ³•åº”è¯¥æ˜¯é”™çš„ï¼Ÿ</li>
</ul>
<p>â€œå®ç°æ­£ç¡®çš„ Peterson ç®—æ³•â€ æ˜¯åˆç†éœ€æ±‚ï¼Œå®ƒä¸€å®šèƒ½å®ç°</p>
<ul>
<li><p>Compiler barrier/volatile ä¿è¯ä¸è¢«ä¼˜åŒ–çš„å‰æä¸‹</p>
<ul>
<li><p>å¤„ç†å™¨æä¾›ç‰¹æ®ŠæŒ‡ä»¤ä¿è¯å¯è§æ€§</p>
</li>
<li><p>ç¼–è¯‘å™¨æä¾› </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__sync_synchronize()</span><br></pre></td></tr></table></figure>
<p> å‡½æ•°</p>
<ul>
<li>x86: <code>mfence</code>; ARM: <code>dmb ish</code>; RISC-V: <code>fence rw, rw</code></li>
<li>åŒæ—¶å«æœ‰ä¸€ä¸ª compiler barrier</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>peterson.c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;thread.h&quot;</span><br><span class="line"></span><br><span class="line">#define A 1</span><br><span class="line">#define B 2</span><br><span class="line"></span><br><span class="line">#define BARRIER __sync_synchronize()</span><br><span class="line"></span><br><span class="line">atomic_int nested;</span><br><span class="line">atomic_long count;</span><br><span class="line"></span><br><span class="line">void critical_section() &#123;</span><br><span class="line">  long cnt = atomic_fetch_add(&amp;count, 1);</span><br><span class="line">  int i = atomic_fetch_add(&amp;nested, 1) + 1;</span><br><span class="line">  if (i != 1) &#123;</span><br><span class="line">    printf(&quot;%d threads in the critical section @ count=%ld\n&quot;, i, cnt);</span><br><span class="line">    assert(0);</span><br><span class="line">  &#125;</span><br><span class="line">  atomic_fetch_add(&amp;nested, -1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int volatile x = 0, y = 0, turn;</span><br><span class="line"></span><br><span class="line">void TA() &#123;</span><br><span class="line">  while (1) &#123;</span><br><span class="line">    x = 1;                   BARRIER;</span><br><span class="line">    turn = B;                BARRIER; // &lt;- this is critcal for x86</span><br><span class="line">    while (1) &#123;</span><br><span class="line">      if (!y) break;         BARRIER;</span><br><span class="line">      if (turn != B) break;  BARRIER;</span><br><span class="line">    &#125;</span><br><span class="line">    critical_section();</span><br><span class="line">    x = 0;                   BARRIER;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void TB() &#123;</span><br><span class="line">  while (1) &#123;</span><br><span class="line">    y = 1;                   BARRIER;</span><br><span class="line">    turn = A;                BARRIER;</span><br><span class="line">    while (1) &#123;</span><br><span class="line">      if (!x) break;         BARRIER;</span><br><span class="line">      if (turn != A) break;  BARRIER;</span><br><span class="line">    &#125;</span><br><span class="line">    critical_section();</span><br><span class="line">    y = 0;                   BARRIER;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">  create(TA);</span><br><span class="line">  create(TB);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæŠŠç¬¬å…­è¡Œçš„<strong>BARRIER</strong>å®šä¹‰ä¸ºç©ºï¼Œåˆ™ä¼šå‡ºé”™</p>
<p><img src="../img/image-169.png" alt="img">å‡ºé”™</p>
<h2 id="åŸå­æŒ‡ä»¤"><a href="#åŸå­æŒ‡ä»¤" class="headerlink" title="åŸå­æŒ‡ä»¤"></a>åŸå­æŒ‡ä»¤</h2><h3 id="å¹¶å‘ç¼–ç¨‹å›°éš¾çš„è§£å†³"><a href="#å¹¶å‘ç¼–ç¨‹å›°éš¾çš„è§£å†³" class="headerlink" title="å¹¶å‘ç¼–ç¨‹å›°éš¾çš„è§£å†³"></a>å¹¶å‘ç¼–ç¨‹å›°éš¾çš„è§£å†³</h3><p>æ™®é€šçš„å˜é‡è¯»å†™åœ¨ç¼–è¯‘å™¨ + å¤„ç†å™¨çš„åŒé‡ä¼˜åŒ–ä¸‹è¡Œä¸ºå˜å¾—å¤æ‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">retry:</span><br><span class="line">  if (locked != UNLOCK) &#123;</span><br><span class="line">    goto retry;</span><br><span class="line">  &#125;</span><br><span class="line">  locked = LOCK;</span><br></pre></td></tr></table></figure>
<p>è§£å†³æ–¹æ³•ï¼šç¼–è¯‘å™¨å’Œç¡¬ä»¶å…±åŒæä¾›ä¸å¯ä¼˜åŒ–ã€ä¸å¯æ‰“æ–­çš„æŒ‡ä»¤</p>
<ul>
<li>â€œåŸå­æŒ‡ä»¤â€ + compiler barrier</li>
</ul>
<h3 id="å®ç°æ­£ç¡®çš„æ±‚å’Œ"><a href="#å®ç°æ­£ç¡®çš„æ±‚å’Œ" class="headerlink" title="å®ç°æ­£ç¡®çš„æ±‚å’Œ"></a>å®ç°æ­£ç¡®çš„æ±‚å’Œ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">for (int i = 0; i &lt; N; i++)</span><br><span class="line">  asm volatile(&quot;lock incq %0&quot; : &quot;+m&quot;(sum));</span><br></pre></td></tr></table></figure>
<p>â€œBus lockâ€â€”â€”ä» 80386 å¼€å§‹å¼•å…¥ (bus control signal)</p>
<p><img src="../img/image-171-1024x741.png" alt="img"></p>
<p>sum-atomic.c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;thread.h&quot;</span><br><span class="line"></span><br><span class="line">#define N 100000000</span><br><span class="line"></span><br><span class="line">long sum = 0;</span><br><span class="line"></span><br><span class="line">void atomic_inc(long *ptr) &#123;</span><br><span class="line">  asm volatile(</span><br><span class="line">    &quot;lock incq %0&quot;  // Atomic + memory fence</span><br><span class="line">    : &quot;+m&quot;(*ptr)</span><br><span class="line">    :</span><br><span class="line">    : &quot;memory&quot;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void Tsum() &#123;</span><br><span class="line">  for (int i = 0; i &lt; N; i++) &#123;</span><br><span class="line">    atomic_inc(&amp;sum);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">  create(Tsum);</span><br><span class="line">  create(Tsum);</span><br><span class="line">  join();</span><br><span class="line">  printf(&quot;sum = %ld\n&quot;, sum);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="../img/image-170.png" alt="img">æ­£ç¡®ç»“æœï¼Œä½†æ˜¯å¾ˆæ…¢</p>
<h3 id="ç¼–è¯‘å™¨å’Œç¡¬ä»¶çš„åä½œ"><a href="#ç¼–è¯‘å™¨å’Œç¡¬ä»¶çš„åä½œ" class="headerlink" title="ç¼–è¯‘å™¨å’Œç¡¬ä»¶çš„åä½œ"></a>ç¼–è¯‘å™¨å’Œç¡¬ä»¶çš„åä½œ</h3><p>Acquire/release semantics</p>
<ul>
<li><p>å¯¹äºä¸€å¯¹é…å¯¹çš„ release-acquire</p>
<ul>
<li>(é€»è¾‘ä¸Š) release ä¹‹å‰çš„ store éƒ½å¯¹ acquire ä¹‹åçš„ load å¯è§</li>
<li><a target="_blank" rel="noopener" href="https://davekilian.com/acquire-release.html">Making Sense of Acquire-Release Semantics</a></li>
</ul>
</li>
<li><p>std::atomic</p>
<ul>
<li><p>std::memory_order_acquire: guarantees that subsequent loads are not moved before the current load or any preceding loads.</p>
</li>
<li><p>std::memory_order_release: preceding stores are not moved past the current store or any subsequent stores.</p>
</li>
<li><p><code>x.load()</code>/<code>x.store()</code> ä¼šæ ¹æ® <a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/atomic/memory_order">memory order</a> æ’å…¥ fence</p>
</li>
<li><p><code>x.fetch_add()</code></p>
<p> å°†ä¼šä¿è¯ cst (sequentially consistent)</p>
<ul>
<li>å» <a target="_blank" rel="noopener" href="https://godbolt.org/">godbolt</a> ä¸Šè¯•ä¸€ä¸‹å§</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="å¹¶å‘3-å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥-2023-3-14"><a href="#å¹¶å‘3-å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥-2023-3-14" class="headerlink" title="å¹¶å‘3_å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥_2023.3.14"></a>å¹¶å‘3_å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥_2023.3.14</h1><h2 id="äº’æ–¥é—®é¢˜ï¼šå®šä¹‰ä¸å‡è®¾"><a href="#äº’æ–¥é—®é¢˜ï¼šå®šä¹‰ä¸å‡è®¾" class="headerlink" title="äº’æ–¥é—®é¢˜ï¼šå®šä¹‰ä¸å‡è®¾"></a>äº’æ–¥é—®é¢˜ï¼šå®šä¹‰ä¸å‡è®¾</h2><h3 id="äº’æ–¥é—®é¢˜ï¼šå®šä¹‰"><a href="#äº’æ–¥é—®é¢˜ï¼šå®šä¹‰" class="headerlink" title="äº’æ–¥é—®é¢˜ï¼šå®šä¹‰"></a>äº’æ–¥é—®é¢˜ï¼šå®šä¹‰</h3><p>äº’æ–¥ (mutual exclusion)ï¼Œâ€œäº’ç›¸æ’æ–¥â€</p>
<ul>
<li>å®ç° <code>lock_t</code> æ•°æ®ç»“æ„å’Œ <code>lock/unlock</code> API:</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  ...</span><br><span class="line">&#125; <span class="type">lock_t</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">lock</span><span class="params">(<span class="type">lock_t</span> *lk)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">unlock</span><span class="params">(<span class="type">lock_t</span> *lk)</span>;</span><br></pre></td></tr></table></figure>
<p>ä¸€æŠŠ â€œæ’ä»–æ€§â€ çš„é”â€”â€”å¯¹äºé”å¯¹è±¡ <code>lk</code></p>
<ul>
<li>å¦‚æœæŸä¸ªçº¿ç¨‹æŒæœ‰é”ï¼Œåˆ™å…¶ä»–çº¿ç¨‹çš„ <code>lock</code> ä¸èƒ½è¿”å› (Safety)</li>
<li>åœ¨å¤šä¸ªçº¿ç¨‹æ‰§è¡Œ <code>lock</code> æ—¶ï¼Œè‡³å°‘æœ‰ä¸€ä¸ªå¯ä»¥è¿”å› (Liveness)</li>
<li>èƒ½æ­£ç¡®å¤„ç†å¤„ç†å™¨ä¹±åºã€å®½æ¾å†…å­˜æ¨¡å‹å’Œç¼–è¯‘ä¼˜åŒ–</li>
</ul>
<h3 id="äº’æ–¥é—®é¢˜çš„ç»å…¸ç®—æ³•"><a href="#äº’æ–¥é—®é¢˜çš„ç»å…¸ç®—æ³•" class="headerlink" title="äº’æ–¥é—®é¢˜çš„ç»å…¸ç®—æ³•"></a>äº’æ–¥é—®é¢˜çš„ç»å…¸ç®—æ³•</h3><p>Peterson ç®—æ³•</p>
<ul>
<li>åŒ…é—´ã€æ——å­å’Œé—¨ä¸Šçš„å­—æ¡</li>
<li>å‡è®¾ atomic load/store<ul>
<li>å®ç°è¿™ä¸ªå‡è®¾ä¹Ÿä¸æ˜¯éå¸¸å®¹æ˜“çš„ (<a target="_blank" rel="noopener" href="https://jyywiki.cn/pages/OS/2023/c/peterson.c">peterson.c</a>)</li>
</ul>
</li>
</ul>
<p>å› æ­¤ï¼Œå‡è®¾å¾ˆé‡è¦</p>
<ul>
<li>ä¸èƒ½åŒæ—¶è¯»/å†™å…±äº«å†…å­˜ (1960s) ä¸æ˜¯ä¸€ä¸ªå¥½çš„å‡è®¾<ul>
<li>Load (ç¯é¡¾å››å‘¨) çš„æ—¶å€™ä¸èƒ½å†™ï¼Œâ€œçœ‹ä¸€çœ¼å°±æŠŠçœ¼ç›é—­ä¸Šâ€</li>
<li>Store (æ”¹å˜ç‰©ç†ä¸–ç•ŒçŠ¶æ€) çš„æ—¶å€™ä¸èƒ½è¯»ï¼Œâ€œé—­ç€çœ¼ç›åŠ¨æ‰‹â€</li>
<li>è¿™æ˜¯ã€Šæ“ä½œç³»ç»Ÿ&gt;è¯¾<ul>
<li>æ›´å–œæ¬¢ç›´è§‚ã€ç®€å•ã€ç²—æš´ (ç¨³å®š)ã€æœ‰æ•ˆçš„è§£å†³æ–¹æ³•</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="å®ç°äº’æ–¥çš„åŸºæœ¬å‡è®¾"><a href="#å®ç°äº’æ–¥çš„åŸºæœ¬å‡è®¾" class="headerlink" title="å®ç°äº’æ–¥çš„åŸºæœ¬å‡è®¾"></a>å®ç°äº’æ–¥çš„åŸºæœ¬å‡è®¾</h3><p>å…è®¸ä½¿ç”¨ä½¿æˆ‘ä»¬å¯ä»¥ä¸ç®¡ä¸€åˆ‡éº»çƒ¦äº‹çš„åŸå­æŒ‡ä»¤</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">void atomic_inc(long *ptr);</span><br><span class="line">int atomic_xchg(int val, int *ptr);</span><br></pre></td></tr></table></figure>
<p>çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªæ™®é€šçš„å‡½æ•°ï¼Œä½†å‡è®¾ï¼š</p>
<ul>
<li>åŒ…å«ä¸€ä¸ªåŸå­æŒ‡ä»¤<ul>
<li>æŒ‡ä»¤çš„æ‰§è¡Œä¸èƒ½è¢«æ‰“æ–­</li>
</ul>
</li>
<li>åŒ…å«ä¸€ä¸ª compiler barrier<ul>
<li>æ— è®ºä½•ç§ä¼˜åŒ–éƒ½ä¸å¯è¶Šè¿‡æ­¤å‡½æ•°</li>
</ul>
</li>
<li>åŒ…å«ä¸€ä¸ª memory fence<ul>
<li>ä¿è¯å¤„ç†å™¨åœ¨ stop-the-world å‰æ‰€æœ‰å¯¹å†…å­˜çš„ store éƒ½ â€œç”Ÿæ•ˆâ€</li>
<li>å³å¯¹ resume-the-world ä¹‹åçš„ load å¯è§</li>
</ul>
</li>
</ul>
<p>å¯¹æœªæ¥å¯è§ï¼šreleaseï¼›è¯»åˆ°è¿‡å»çš„å†…å®¹ï¼šacquireã€‚å…±åŒç»„æˆé”ã€‚</p>
<h3 id="Atomic-Exchange-å®ç°"><a href="#Atomic-Exchange-å®ç°" class="headerlink" title="Atomic Exchange å®ç°"></a>Atomic Exchange å®ç°</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">int xchg(int volatile *ptr, int newval) &#123;</span><br><span class="line">  int result;</span><br><span class="line">  asm volatile(</span><br><span class="line">    // æŒ‡ä»¤è‡ªå¸¦ memory barrier</span><br><span class="line">    &quot;lock xchgl %0, %1&quot;</span><br><span class="line">    : &quot;+m&quot;(*ptr), &quot;=a&quot;(result)</span><br><span class="line">    : &quot;1&quot;(newval)</span><br><span class="line">    // Compiler barrier</span><br><span class="line">    : &quot;memory&quot;</span><br><span class="line">  );</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="è‡ªæ—‹é”-Spin-Lock"><a href="#è‡ªæ—‹é”-Spin-Lock" class="headerlink" title="è‡ªæ—‹é” (Spin Lock)"></a>è‡ªæ—‹é” (Spin Lock)</h2><h3 id="è‡ªæ—‹é”-Spin-Lock-1"><a href="#è‡ªæ—‹é”-Spin-Lock-1" class="headerlink" title="è‡ªæ—‹é” (Spin Lock)"></a>è‡ªæ—‹é” (Spin Lock)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">void lock(lock_t *lk);</span><br><span class="line">void unlock(lock_t *lk);</span><br></pre></td></tr></table></figure>
<p>åšé¢˜å®¶ï¼šæ‹¿åˆ°é¢˜å°±å¼€å§‹æ’åˆ—ç»„åˆ</p>
<ul>
<li>ç†Ÿç»ƒå¾—è®©äººå¿ƒç–¼<ul>
<li>å¦‚æœé•¿ä¹…çš„è®­ç»ƒéƒ½æ˜¯ â€œå¿…é¡»åœ¨è§„å®šçš„æ—¶é—´å†…æ­£ç¡®è§£å‡ºé—®é¢˜â€ï¼Œé‚£ä¹ˆæµªè´¹æ—¶é—´çš„æ€è€ƒè‡ªç„¶å°±å°‘äº†</li>
</ul>
</li>
</ul>
<p>ç§‘å­¦å®¶ï¼šè€ƒè™‘æ›´å¤šæ›´æ ¹æœ¬çš„é—®é¢˜</p>
<ul>
<li>æˆ‘ä»¬å¯ä»¥è®¾è®¡å‡ºæ€æ ·çš„åŸå­æŒ‡ä»¤ï¼Ÿ<ul>
<li>å®ƒä»¬çš„è¡¨è¾¾èƒ½åŠ›å¦‚ä½•ï¼Ÿ</li>
</ul>
</li>
<li>è®¡ç®—æœºç¡¬ä»¶å¯ä»¥æä¾›æ¯” â€œä¸€æ¬¡ load/storeâ€ æ›´å¼ºçš„åŸå­æ€§å—ï¼Ÿ<ul>
<li>å¦‚æœç¡¬ä»¶å¾ˆå›°éš¾ï¼Œè½¯ä»¶/ç¼–è¯‘å™¨å¯ä»¥ä¹ˆï¼Ÿ</li>
</ul>
</li>
</ul>
<h3 id="è‡ªæ—‹é”ï¼šç”¨-xchg-å®ç°äº’æ–¥"><a href="#è‡ªæ—‹é”ï¼šç”¨-xchg-å®ç°äº’æ–¥" class="headerlink" title="è‡ªæ—‹é”ï¼šç”¨ xchg å®ç°äº’æ–¥"></a>è‡ªæ—‹é”ï¼šç”¨ <code>xchg</code> å®ç°äº’æ–¥</h3><p>åœ¨å•æ‰€é—¨å£æ”¾ä¸€ä¸ªæ¡Œå­ (å…±äº«å˜é‡)</p>
<ul>
<li>åˆå§‹æ—¶æ”¾ç€ ğŸ”‘</li>
</ul>
<p>è‡ªæ—‹é” (Spin Lock)</p>
<ul>
<li>æƒ³ä¸Šå•æ‰€çš„åŒå­¦ (ä¸€æ¡ xchg æŒ‡ä»¤)<ul>
<li>Stop the world</li>
<li>çœ‹ä¸€çœ¼æ¡Œå­ä¸Šæœ‰ä»€ä¹ˆ (ğŸ”‘ æˆ– ğŸ”)</li>
<li>æŠŠ ğŸ” æ”¾åˆ°æ¡Œä¸Š (è¦†ç›–ä¹‹å‰æœ‰çš„ä»»ä½•ä¸œè¥¿)</li>
<li>Resume the world</li>
<li>æœŸé—´çœ‹åˆ° ğŸ”‘ æ‰å¯ä»¥è¿›å•æ‰€ï¼Œå¦åˆ™é‡å¤</li>
</ul>
</li>
<li>å‡ºå•æ‰€çš„åŒå­¦<ul>
<li>æŠŠ ğŸ”‘ æ”¾åˆ°æ¡Œä¸Š</li>
</ul>
</li>
</ul>
<h3 id="å®ç°äº’æ–¥ï¼šè‡ªæ—‹é”"><a href="#å®ç°äº’æ–¥ï¼šè‡ªæ—‹é”" class="headerlink" title="å®ç°äº’æ–¥ï¼šè‡ªæ—‹é”"></a>å®ç°äº’æ–¥ï¼šè‡ªæ—‹é”</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">int table = YES;</span><br><span class="line"></span><br><span class="line">void lock() &#123;</span><br><span class="line">retry:</span><br><span class="line">  int got = xchg(&amp;table, NOPE);</span><br><span class="line">  if (got == NOPE)</span><br><span class="line">    goto retry;</span><br><span class="line">  assert(got == YES);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void unlock() &#123;</span><br><span class="line">  xchg(&amp;table, YES);  // ä¸ºä»€ä¹ˆä¸æ˜¯ table = YES; ?</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ xchg çš„å‡è®¾ä¸‹ç®€åŒ–å®ç°</p>
<ul>
<li>åŒ…å«ä¸€ä¸ªåŸå­æŒ‡ä»¤</li>
<li>åŒ…å«ä¸€ä¸ª compiler barrier</li>
<li>åŒ…å«ä¸€ä¸ª memory fence<ul>
<li>sum-spinlock demo</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">int locked = 0;</span><br><span class="line"></span><br><span class="line">void lock() &#123;</span><br><span class="line">  while (xchg(&amp;locked, 1));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void unlock() &#123;</span><br><span class="line">  xchg(&amp;locked, 0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>sum-spinlock.c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;thread.h&quot;</span><br><span class="line"></span><br><span class="line">#define N 100000000</span><br><span class="line">#define M 10</span><br><span class="line"></span><br><span class="line">long sum = 0;</span><br><span class="line"></span><br><span class="line">int xchg(int volatile *ptr, int newval) &#123;</span><br><span class="line">  int result;</span><br><span class="line">  asm volatile(</span><br><span class="line">    &quot;lock xchgl %0, %1&quot;</span><br><span class="line">    : &quot;+m&quot;(*ptr), &quot;=a&quot;(result)</span><br><span class="line">    : &quot;1&quot;(newval)</span><br><span class="line">    : &quot;memory&quot;</span><br><span class="line">  );</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int locked = 0;</span><br><span class="line"></span><br><span class="line">void lock() &#123;</span><br><span class="line">  while (xchg(&amp;locked, 1)) ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void unlock() &#123;</span><br><span class="line">  xchg(&amp;locked, 0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void Tsum() &#123;</span><br><span class="line">  long nround = N / M;</span><br><span class="line">  for (int i = 0; i &lt; nround; i++) &#123;</span><br><span class="line">    lock();</span><br><span class="line">    for (int j = 0; j &lt; M; j++) &#123;</span><br><span class="line">      sum++;  // Non-atomic; can optimize</span><br><span class="line">    &#125;</span><br><span class="line">    unlock();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">  assert(N % M == 0);</span><br><span class="line">  create(Tsum);</span><br><span class="line">  create(Tsum);</span><br><span class="line">  join();</span><br><span class="line">  printf(&quot;sum = %ld\n&quot;, sum);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»“æœsum = 200000000</p>
<h2 id="æ›´å¼ºå¤§çš„åŸå­æŒ‡ä»¤"><a href="#æ›´å¼ºå¤§çš„åŸå­æŒ‡ä»¤" class="headerlink" title="æ›´å¼ºå¤§çš„åŸå­æŒ‡ä»¤"></a>æ›´å¼ºå¤§çš„åŸå­æŒ‡ä»¤</h2><h3 id="æ›´å¼ºå¤§çš„åŸå­æŒ‡ä»¤-1"><a href="#æ›´å¼ºå¤§çš„åŸå­æŒ‡ä»¤-1" class="headerlink" title="æ›´å¼ºå¤§çš„åŸå­æŒ‡ä»¤"></a>æ›´å¼ºå¤§çš„åŸå­æŒ‡ä»¤</h3><p>Compare and exchange (â€œtest and setâ€)</p>
<p>Compare and exchange (â€œtest and setâ€)</p>
<ul>
<li>(lock) cmpxchg SRC, DEST</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">TEMP = DEST</span><br><span class="line">if accumulator == TEMP:</span><br><span class="line">    ZF = 1</span><br><span class="line">    DEST = SRC</span><br><span class="line">else:</span><br><span class="line">    ZF = 0</span><br><span class="line">    accumulator = TEMP</span><br></pre></td></tr></table></figure>
<ul>
<li>ğŸ¤” çœ‹èµ·æ¥æ²¡å¤æ‚å¤šå°‘ï¼Œå¥½åƒåˆå¤æ‚äº†å¾ˆå¤š<ul>
<li>å­¦ç¼–ç¨‹/æ“ä½œç³»ç»Ÿ â€œçº¸é¢ç†è§£â€ æ˜¯ä¸è¡Œçš„</li>
<li>ä¸€å®šè¦å†™ä»£ç åŠ æ·±å°è±¡<ul>
<li>å¯¹äºè¿™ä¸ªä¾‹å­ï¼šæˆ‘ä»¬å¯ä»¥åˆ—å‡º â€œçœŸå€¼è¡¨â€</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="åœ¨è‡ªæ—‹é”ä¸­ä»£æ›¿-xchg"><a href="#åœ¨è‡ªæ—‹é”ä¸­ä»£æ›¿-xchg" class="headerlink" title="åœ¨è‡ªæ—‹é”ä¸­ä»£æ›¿ xchg"></a>åœ¨è‡ªæ—‹é”ä¸­ä»£æ›¿ xchg</h3><p>åœ¨è‡ªæ—‹é”ä¸­ä»£æ›¿ xchg</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// cmpxchg(old=&#x27;ğŸ”‘&#x27;, new=&#x27;ğŸ”&#x27;, *ptr)</span><br><span class="line">int tmp = *ptr;</span><br><span class="line">if (tmp == &#x27;ğŸ”‘&#x27;) &#123;</span><br><span class="line">  *ptr = &#x27;ğŸ”&#x27;</span><br><span class="line">  assert(tmp == &#x27;ğŸ”‘&#x27;);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  assert(tmp == &#x27;ğŸ”&#x27;);</span><br><span class="line">&#125;</span><br><span class="line">return tmp;</span><br></pre></td></tr></table></figure>
<ul>
<li>è¿™ä¹ˆåšæœ‰ä»€ä¹ˆå¥½å¤„å—ï¼Ÿ<ul>
<li>æœ‰çš„ï¼Œåœ¨è‡ªæ—‹å¤±è´¥çš„æ—¶å€™å‡å°‘äº†ä¸€æ¬¡ store</li>
<li>å½“ç„¶ï¼Œç°ä»£å¤„ç†å™¨ä¹Ÿå¯ä»¥ä¼˜åŒ– xchg</li>
</ul>
</li>
</ul>
<h3 id="å¤šå‡ºçš„-Compare-ç”¨å¤„"><a href="#å¤šå‡ºçš„-Compare-ç”¨å¤„" class="headerlink" title="å¤šå‡ºçš„ Compare: ç”¨å¤„"></a>å¤šå‡ºçš„ Compare: ç”¨å¤„</h3><p>åŒæ—¶æ£€æŸ¥ä¸Šä¸€æ¬¡è·å¾—çš„å€¼æ˜¯å¦ä»ç„¶æœ‰æ•ˆ + ä¿®æ”¹ç”Ÿæ•ˆ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// Create a new node</span><br><span class="line">retry:</span><br><span class="line">  expected = head;</span><br><span class="line">  node-&gt;next = expected;</span><br><span class="line">  seen = cmpxchg(expected, node, &amp;head);</span><br><span class="line">  if (seen != expected)</span><br><span class="line">    goto retry;</span><br></pre></td></tr></table></figure>
<h2 id="åœ¨æ“ä½œç³»ç»Ÿä¸Šå®ç°äº’æ–¥"><a href="#åœ¨æ“ä½œç³»ç»Ÿä¸Šå®ç°äº’æ–¥" class="headerlink" title="åœ¨æ“ä½œç³»ç»Ÿä¸Šå®ç°äº’æ–¥"></a>åœ¨æ“ä½œç³»ç»Ÿä¸Šå®ç°äº’æ–¥</h2><h3 id="è‡ªæ—‹é”çš„ç¼ºé™·"><a href="#è‡ªæ—‹é”çš„ç¼ºé™·" class="headerlink" title="è‡ªæ—‹é”çš„ç¼ºé™·"></a>è‡ªæ—‹é”çš„ç¼ºé™·</h3><p>æ€§èƒ½é—®é¢˜ (1)</p>
<ul>
<li>é™¤äº†è¿›å…¥ä¸´ç•ŒåŒºçš„çº¿ç¨‹ï¼Œå…¶ä»–å¤„ç†å™¨ä¸Šçš„çº¿ç¨‹éƒ½åœ¨ç©ºè½¬</li>
<li>äº‰æŠ¢é”çš„å¤„ç†å™¨è¶Šå¤šï¼Œåˆ©ç”¨ç‡è¶Šä½<ul>
<li>4 ä¸ª CPU è¿è¡Œ 4 ä¸ª sum-spinlock å’Œ 1 ä¸ª OBS<ul>
<li>ä»»æ„æ—¶åˆ»éƒ½åªæœ‰ä¸€ä¸ª sum-atomic åœ¨æœ‰æ•ˆè®¡ç®—</li>
</ul>
</li>
<li>å‡åˆ† CPU, OBS å°±åˆ†ä¸åˆ° 100% çš„ CPU äº†</li>
</ul>
</li>
</ul>
<p>æ€§èƒ½é—®é¢˜ (2)</p>
<ul>
<li>æŒæœ‰è‡ªæ—‹é”çš„çº¿ç¨‹å¯èƒ½è¢«æ“ä½œç³»ç»Ÿåˆ‡æ¢å‡ºå»<ul>
<li>æ“ä½œç³»ç»Ÿä¸ â€œæ„ŸçŸ¥â€ çº¿ç¨‹åœ¨åšä»€ä¹ˆ</li>
<li>(ä½†ä¸ºä»€ä¹ˆä¸èƒ½å‘¢ï¼Ÿ)</li>
</ul>
</li>
<li>å®ç° 100% çš„èµ„æºæµªè´¹</li>
</ul>
<h3 id="Scalability-æ€§èƒ½çš„æ–°ç»´åº¦"><a href="#Scalability-æ€§èƒ½çš„æ–°ç»´åº¦" class="headerlink" title="Scalability: æ€§èƒ½çš„æ–°ç»´åº¦"></a>Scalability: æ€§èƒ½çš„æ–°ç»´åº¦</h3><blockquote>
<p>åŒä¸€ä»½è®¡ç®—ä»»åŠ¡ï¼Œæ—¶é—´ (CPU cycles) å’Œç©ºé—´ (mapped memory) ä¼šéšå¤„ç†å™¨æ•°é‡çš„å¢é•¿è€Œå˜åŒ–ã€‚</p>
</blockquote>
<p><img src="../img/spinlock-scalability.jpg" alt="img"></p>
<p>ç”¨è‡ªæ—‹é”å®ç° sum++ çš„æ€§èƒ½é—®é¢˜</p>
<ul>
<li>ä¸¥è°¨çš„ç»Ÿè®¡å¾ˆéš¾<ul>
<li>CPU åŠ¨æ€åŠŸè€—</li>
<li>ç³»ç»Ÿä¸­çš„å…¶ä»–è¿›ç¨‹</li>
<li>è¶…çº¿ç¨‹</li>
<li>NUMA</li>
<li>â€¦â€¦</li>
<li><a target="_blank" rel="noopener" href="https://www.cse.unsw.edu.au/~gernot/benchmarking-crimes.html">Benchmarking crimes</a></li>
</ul>
</li>
</ul>
<h3 id="è‡ªæ—‹é”çš„ä½¿ç”¨åœºæ™¯"><a href="#è‡ªæ—‹é”çš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="è‡ªæ—‹é”çš„ä½¿ç”¨åœºæ™¯"></a>è‡ªæ—‹é”çš„ä½¿ç”¨åœºæ™¯</h3><ol>
<li>ä¸´ç•ŒåŒºå‡ ä¹ä¸ â€œæ‹¥å µâ€</li>
<li>æŒæœ‰è‡ªæ—‹é”æ—¶ç¦æ­¢æ‰§è¡Œæµåˆ‡æ¢</li>
</ol>
<p>ä½¿ç”¨åœºæ™¯ï¼šæ“ä½œç³»ç»Ÿå†…æ ¸çš„å¹¶å‘æ•°æ®ç»“æ„ (çŸ­ä¸´ç•ŒåŒº)</p>
<ul>
<li>æ“ä½œç³»ç»Ÿå¯ä»¥å…³é—­ä¸­æ–­å’ŒæŠ¢å <ul>
<li>ä¿è¯é”çš„æŒæœ‰è€…åœ¨å¾ˆçŸ­çš„æ—¶é—´å†…å¯ä»¥é‡Šæ”¾é”</li>
</ul>
</li>
<li>(å¦‚æœæ˜¯è™šæ‹Ÿæœºå‘¢â€¦ğŸ˜‚)<ul>
<li>PAUSE æŒ‡ä»¤ä¼šè§¦å‘ VM Exit</li>
</ul>
</li>
<li>ä½†ä¾æ—§å¾ˆéš¾åšå¥½<ul>
<li><a target="_blank" rel="noopener" href="https://www.usenix.org/conference/osdi10/analysis-linux-scalability-many-cores">An analysis of Linux scalability to many cores</a> (OSDIâ€™10)</li>
</ul>
</li>
</ul>
<h3 id="å®ç°çº¿ç¨‹-é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥"><a href="#å®ç°çº¿ç¨‹-é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥" class="headerlink" title="å®ç°çº¿ç¨‹ + é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥"></a>å®ç°çº¿ç¨‹ + é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥</h3><p>â€œè®©â€ ä¸æ˜¯ C è¯­è¨€ä»£ç å¯ä»¥åšåˆ°çš„ (C ä»£ç åªèƒ½æ‰§è¡ŒæŒ‡ä»¤)</p>
<ul>
<li><p>ä½†æœ‰ä¸€ç§ç‰¹æ®Šçš„æŒ‡ä»¤ï¼šsyscall</p>
</li>
<li><p>æŠŠé”çš„å®ç°æ”¾åˆ°æ“ä½œç³»ç»Ÿé‡Œå°±å¥½å•¦</p>
<ul>
<li><p>```<br>syscall(SYSCALL_lock, &amp;lk);</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  - è¯•å›¾è·å¾— `lk`ï¼Œä½†å¦‚æœå¤±è´¥ï¼Œå°±åˆ‡æ¢åˆ°å…¶ä»–çº¿ç¨‹</span><br><span class="line"></span><br><span class="line">- ```</span><br><span class="line">  syscall(SYSCALL_unlock, &amp;lk);</span><br></pre></td></tr></table></figure>
<ul>
<li>é‡Šæ”¾ <code>lk</code>ï¼Œå¦‚æœæœ‰ç­‰å¾…é”çš„çº¿ç¨‹å°±å”¤é†’</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>æ“ä½œç³»ç»Ÿ = æ›´è¡£å®¤ç®¡ç†å‘˜</p>
<ul>
<li>å…ˆåˆ°çš„äºº (çº¿ç¨‹)<ul>
<li>æˆåŠŸè·å¾—æ‰‹ç¯ï¼Œè¿›å…¥æ¸¸æ³³é¦†</li>
<li><code>*lk = ğŸ”’</code>ï¼Œç³»ç»Ÿè°ƒç”¨ç›´æ¥è¿”å›</li>
</ul>
</li>
<li>ååˆ°çš„äºº (çº¿ç¨‹)<ul>
<li>ä¸èƒ½è¿›å…¥æ¸¸æ³³é¦†ï¼Œæ’é˜Ÿç­‰å¾…</li>
<li>çº¿ç¨‹æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œæ‰§è¡Œçº¿ç¨‹åˆ‡æ¢ (yield)</li>
</ul>
</li>
<li>æ´—å®Œæ¾¡å‡ºæ¥çš„äºº (çº¿ç¨‹)<ul>
<li>äº¤è¿˜æ‰‹ç¯ç»™ç®¡ç†å‘˜ï¼›ç®¡ç†å‘˜æŠŠæ‰‹ç¯å†äº¤ç»™æ’é˜Ÿçš„äºº</li>
<li>å¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸ç©ºï¼Œä»ç­‰å¾…é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªçº¿ç¨‹å…è®¸æ‰§è¡Œ</li>
<li>å¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºï¼Œ<code>*lk = âœ…</code></li>
</ul>
</li>
<li>ç®¡ç†å‘˜ (OS) ä½¿ç”¨è‡ªæ—‹é”ç¡®ä¿è‡ªå·±å¤„ç†æ‰‹ç¯çš„è¿‡ç¨‹æ˜¯åŸå­çš„</li>
</ul>
<h1 id="å¹¶å‘4-å¹¶å‘æ§åˆ¶ï¼šè°ƒè¯•ç†è®ºä¸å®è·µ-2023-3-16"><a href="#å¹¶å‘4-å¹¶å‘æ§åˆ¶ï¼šè°ƒè¯•ç†è®ºä¸å®è·µ-2023-3-16" class="headerlink" title="å¹¶å‘4_å¹¶å‘æ§åˆ¶ï¼šè°ƒè¯•ç†è®ºä¸å®è·µ_2023.3.16"></a>å¹¶å‘4_å¹¶å‘æ§åˆ¶ï¼šè°ƒè¯•ç†è®ºä¸å®è·µ_2023.3.16</h1><h2 id="è°ƒè¯•ç†è®º"><a href="#è°ƒè¯•ç†è®º" class="headerlink" title="è°ƒè¯•ç†è®º"></a>è°ƒè¯•ç†è®º</h2><p>è°ƒè¯•ç†è®ºï¼šå¦‚æœæˆ‘ä»¬èƒ½åˆ¤å®šä»»æ„ç¨‹åºçŠ¶æ€çš„æ­£ç¡®æ€§ï¼Œé‚£ä¹ˆç»™å®šä¸€ä¸ª failureï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡äºŒåˆ†æŸ¥æ‰¾å®šä½åˆ°ç¬¬ä¸€ä¸ª error çš„çŠ¶æ€ï¼Œæ­¤æ—¶çš„ä»£ç å°±æ˜¯ fault (bug)ã€‚</p>
<p>å®é™…ä¸­çš„è°ƒè¯•ï¼šè§‚å¯ŸçŠ¶æ€æœºæ‰§è¡Œ (trace) çš„æŸä¸ªä¾§é¢</p>
<ul>
<li>ç¼©å°é”™è¯¯çŠ¶æ€ (error) å¯èƒ½äº§ç”Ÿçš„ä½ç½®</li>
<li>ä½œå‡ºé€‚å½“çš„å‡è®¾</li>
<li>å†è¿›è¡Œç»†ç²’åº¦çš„å®šä½å’Œè¯Šæ–­</li>
</ul>
<p>æœ€é‡è¦çš„ä¸¤ä¸ªå·¥å…·</p>
<ul>
<li>printf â†’ è‡ªå®šä¹‰ log çš„ trace<ul>
<li>çµæ´»å¯æ§ã€èƒ½å¿«é€Ÿå®šä½é—®é¢˜å¤§æ¦‚ä½ç½®ã€é€‚ç”¨äºå¤§å‹è½¯ä»¶</li>
<li>æ— æ³•ç²¾ç¡®å®šä½ã€å¤§é‡çš„ logs ç®¡ç†èµ·æ¥æ¯”è¾ƒéº»çƒ¦</li>
</ul>
</li>
<li>gdb â†’ æŒ‡ä»¤/è¯­å¥çº§ trace<ul>
<li>ç²¾ç¡®ã€æŒ‡ä»¤çº§å®šä½ã€ä»»æ„æŸ¥çœ‹ç¨‹åºå†…éƒ¨çŠ¶æ€</li>
<li>è€—è´¹å¤§é‡æ—¶é—´</li>
</ul>
</li>
</ul>
<h2 id="ä½¿ç”¨-GDB-è°ƒè¯•ç¨‹åº"><a href="#ä½¿ç”¨-GDB-è°ƒè¯•ç¨‹åº" class="headerlink" title="ä½¿ç”¨ GDB è°ƒè¯•ç¨‹åº"></a>ä½¿ç”¨ GDB è°ƒè¯•ç¨‹åº</h2><h2 id="GDB-å…¥é—¨"><a href="#GDB-å…¥é—¨" class="headerlink" title="GDB: å…¥é—¨"></a>GDB: å…¥é—¨</h2><p>GDB: æœ€å¸¸ç”¨çš„å‘½ä»¤åœ¨ <a target="_blank" rel="noopener" href="https://jyywiki.cn/pages/OS/manuals/gdb-cheat-sheet.pdf">gdb cheat sheet</a></p>
<ul>
<li>æ‰“å°è´´åœ¨ç”µè„‘å‰ï¼Œè°ƒè¯•æ—¶å€™çœ‹ä¸€éï¼Œå¾ˆå¿«å°±å¤§è‡´è®°ä½äº†</li>
</ul>
<p>æƒ³è¦æ›´å¥½çš„ä½“éªŒï¼Ÿ</p>
<ul>
<li>GDB æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªç¼–ç¨‹è¯­è¨€<ul>
<li>å®ƒç”šè‡³æ”¯æŒ Python</li>
<li>æˆ‘ä»¬å¯ä»¥æ‰§è¡Œä¸€äº›åˆå§‹åŒ–ä»£ç  (-x)</li>
</ul>
</li>
<li>åº“å‡½æ•°ä¹Ÿæ˜¯ä»£ç <ul>
<li>directory å‘½ä»¤å¢åŠ æºç è·¯å¾„</li>
</ul>
</li>
<li>GDB æœ‰è®¸å¤šå‰ç«¯<ul>
<li>cgdb, pwndbg, vscode, â€¦</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://sourceware.org/gdb/current/onlinedocs/gdb.html/">RTFM</a> - M æ¯” ChatGPT å¥½ç”¨åœ¨äºå®ƒä¸éœ€è¦ prompt ä¸”å…¨é¢</li>
</ul>
<p><strong>musl</strong></p>
<h2 id="ğŸŒ¶ï¸-Futex-Fast-Userspace-muTexes-contâ€™d"><a href="#ğŸŒ¶ï¸-Futex-Fast-Userspace-muTexes-contâ€™d" class="headerlink" title="ğŸŒ¶ï¸ Futex: Fast Userspace muTexes (contâ€™d)"></a>ğŸŒ¶ï¸ Futex: Fast Userspace muTexes (contâ€™d)</h2><p>ä¸€ä¸ªç®€å•çš„è®¾è®¡ï¼šå…ˆåœ¨ç”¨æˆ·ç©ºé—´è‡ªæ—‹</p>
<ul>
<li>å¦‚æœè·å¾—é”ï¼Œç›´æ¥è¿›å…¥ (Fast Pathï¼Œæ— ç³»ç»Ÿè°ƒç”¨)</li>
<li>æœªèƒ½è·å¾—é”ï¼Œç³»ç»Ÿè°ƒç”¨ (Slow Path)</li>
<li>è§£é”åç”¨ç³»ç»Ÿè°ƒç”¨å”¤é†’æ½œåœ¨çš„ Slow Path çº¿ç¨‹<ul>
<li>æ›´å¥½çš„è®¾è®¡å¯ä»¥å½»åº•æ¶ˆé™¤ fast-path çš„ç³»ç»Ÿè°ƒç”¨</li>
</ul>
</li>
</ul>
<p>RTFM (åŠé€€)</p>
<ul>
<li>futex (7), futex (2)</li>
<li><a target="_blank" rel="noopener" href="https://lwn.net/Articles/360699/">A futex overview and update</a> (LWN)</li>
<li><a target="_blank" rel="noopener" href="https://jyywiki.cn/pages/OS/manuals/futexes-are-tricky.pdf">Futexes are tricky</a> (è®º model checker çš„é‡è¦æ€§)</li>
<li>(æˆ‘ä»¬ä¸è®²å¹¶å‘ç®—æ³•)<ul>
<li>ä½†æˆ‘ä»¬å¯ä»¥è°ƒè¯•å®ƒçš„å®ç°</li>
</ul>
</li>
</ul>
<h2 id="è°ƒè¯•ç†è®ºï¼šåº”ç”¨"><a href="#è°ƒè¯•ç†è®ºï¼šåº”ç”¨" class="headerlink" title="è°ƒè¯•ç†è®ºï¼šåº”ç”¨"></a>è°ƒè¯•ç†è®ºï¼šåº”ç”¨</h2><h2 id="è°ƒè¯•ç†è®ºï¼šåº”ç”¨-Again"><a href="#è°ƒè¯•ç†è®ºï¼šåº”ç”¨-Again" class="headerlink" title="è°ƒè¯•ç†è®ºï¼šåº”ç”¨ (Again)"></a>è°ƒè¯•ç†è®ºï¼šåº”ç”¨ (Again)</h2><p>éœ€æ±‚ â†’ è®¾è®¡ â†’ ä»£ç  â†’ Fault â†’ Error â†’ Failure</p>
<p>â€œTechnical Debtâ€</p>
<blockquote>
<p>æ¯å½“ä½ å†™å‡ºä¸å¥½ç»´æŠ¤çš„ä»£ç ï¼Œä½ éƒ½åœ¨ç»™ä½ æœªæ¥çš„è°ƒè¯•/éœ€æ±‚å˜æ›´æŒ–å‘ã€‚</p>
<p>ä¸­æªäº†ï¼Ÿ</p>
</blockquote>
<ul>
<li>ä¸ºäº†å¿«ç‚¹è·‘ç¨‹åºï¼Œéšä¾¿å†™çš„ klib</li>
<li>ä¸ºäº†èµ¶ç´§å®ç°æŒ‡ä»¤ï¼Œéšæ‰‹å†™çš„ä»£ç </li>
<li>ä¸ºäº†åº”ä»˜è€æ¿ï¼Œéšä¾¿å†™çš„ç³»ç»Ÿå®ç°<ul>
<li>jyy çš„ code review: <del>æ—¥å¸¸è¡€å‹å‡é«˜æ—¶é—´</del></li>
</ul>
</li>
</ul>
<h2 id="ç¼–ç¨‹åŸºæœ¬å‡†åˆ™ï¼šå›é¡¾"><a href="#ç¼–ç¨‹åŸºæœ¬å‡†åˆ™ï¼šå›é¡¾" class="headerlink" title="ç¼–ç¨‹åŸºæœ¬å‡†åˆ™ï¼šå›é¡¾"></a>ç¼–ç¨‹åŸºæœ¬å‡†åˆ™ï¼šå›é¡¾</h2><blockquote>
<p>Programs are meant to be read by humans (AIs) and only incidentally for computers to execute. â€” <em>D. E. Knuth</em></p>
<p>(ç¨‹åºé¦–å…ˆæ˜¯æ‹¿ç»™äººè¯»çš„ï¼Œå…¶æ¬¡æ‰æ˜¯è¢«æœºå™¨æ‰§è¡Œã€‚)</p>
</blockquote>
<p>å¥½çš„ç¨‹åº</p>
<ul>
<li><p>ä¸è¨€è‡ªæ˜ï¼šèƒ½çŸ¥é“æ˜¯åšä»€ä¹ˆçš„ (</p>
<p>specification</p>
<p>)</p>
<ul>
<li>å› æ­¤ä»£ç é£æ ¼å¾ˆé‡è¦</li>
</ul>
</li>
<li><p>ä¸è¨€è‡ªè¯ï¼šèƒ½ç¡®è®¤ä»£ç å’Œ specification ä¸€è‡´</p>
<ul>
<li>å› æ­¤ä»£ç ä¸­çš„é€»è¾‘æµå¾ˆé‡è¦</li>
</ul>
</li>
<li><p>äººç±»æ–°çºªå…ƒçš„è¯„åˆ¤æ ‡å‡†</p>
<ul>
<li>AI æ˜¯å¦èƒ½æ­£ç¡®ç†è§£/ç»´æŠ¤ä½ çš„ä»£ç </li>
</ul>
</li>
</ul>
<h2 id="è°ƒè¯•ç†è®ºçš„æœ€é‡è¦åº”ç”¨"><a href="#è°ƒè¯•ç†è®ºçš„æœ€é‡è¦åº”ç”¨" class="headerlink" title="è°ƒè¯•ç†è®ºçš„æœ€é‡è¦åº”ç”¨"></a>è°ƒè¯•ç†è®ºçš„æœ€é‡è¦åº”ç”¨</h2><blockquote>
<p>å†™å¥½è¯»ã€æ˜“éªŒè¯çš„ä»£ç </p>
<p>åœ¨ä»£ç ä¸­æ·»åŠ æ›´å¤šçš„æ–­è¨€ (assertions)</p>
</blockquote>
<p>æ–­è¨€çš„æ„ä¹‰</p>
<ul>
<li>æŠŠä»£ç ä¸­éšè—çš„ specification å†™å‡ºæ¥<ul>
<li>Fault â†’ Error (é æµ‹è¯•)</li>
<li>Error â†’ Failure (é æ–­è¨€)<ul>
<li>Error æš´éœ²çš„è¶Šæ™šï¼Œè¶Šéš¾è°ƒè¯•</li>
<li>è¿½æº¯å¯¼è‡´ assert failure çš„å˜é‡å€¼ (slice) é€šå¸¸å¯ä»¥å¿«é€Ÿå®šä½åˆ° bug</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="å¹¶å‘5-å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥-1-2023-3-21"><a href="#å¹¶å‘5-å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥-1-2023-3-21" class="headerlink" title="å¹¶å‘5_å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥ (1)_2023.3.21"></a>å¹¶å‘5_å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥ (1)_2023.3.21</h1><h2 id="åŒæ­¥é—®é¢˜"><a href="#åŒæ­¥é—®é¢˜" class="headerlink" title="åŒæ­¥é—®é¢˜"></a>åŒæ­¥é—®é¢˜</h2><h2 id="åŒæ­¥-Synchronization"><a href="#åŒæ­¥-Synchronization" class="headerlink" title="åŒæ­¥ (Synchronization)"></a>åŒæ­¥ (Synchronization)</h2><p><img src="../img/gearbox.gif" alt="img"></p>
<p>ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šéšæ—¶é—´å˜åŒ–çš„é‡åœ¨å˜åŒ–è¿‡ç¨‹ä¸­ä¿æŒä¸€å®šçš„ç›¸å¯¹å…³ç³»</p>
<ul>
<li>åŒæ­¥ç”µè·¯ (ä¸€ä¸ªæ—¶é’Ÿæ§åˆ¶æ‰€æœ‰è§¦å‘å™¨)</li>
<li>iPhone/iCloud åŒæ­¥ (æ‰‹æœº vs ç”µè„‘ vs äº‘ç«¯)</li>
<li>å˜é€Ÿç®±åŒæ­¥å™¨ (åˆå¹¶å¿«æ…¢é€Ÿé½¿è½®)</li>
<li>åŒæ­¥ç”µæœº (è½¬å­ä¸ç£åœºè½¬é€Ÿä¸€è‡´)</li>
<li>åŒæ­¥ç”µè·¯ (æ‰€æœ‰è§¦å‘å™¨åœ¨è¾¹æ²¿åŒæ—¶è§¦å‘)</li>
</ul>
<hr>
<p>å¼‚æ­¥ (Asynchronous) = ä¸éœ€è¦åŒæ­¥</p>
<ul>
<li>ä¸Šè¿°å¾ˆå¤šä¾‹å­éƒ½æœ‰å¼‚æ­¥ç‰ˆæœ¬ (å¼‚æ­¥ç”µæœºã€å¼‚æ­¥ç”µè·¯ã€å¼‚æ­¥çº¿ç¨‹)</li>
</ul>
<h2 id="ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ï¼šå­¦åºŸä½ å°±èµ¢äº†"><a href="#ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ï¼šå­¦åºŸä½ å°±èµ¢äº†" class="headerlink" title="ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ï¼šå­¦åºŸä½ å°±èµ¢äº†"></a>ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ï¼šå­¦åºŸä½ å°±èµ¢äº†</h2><blockquote>
<p>99% çš„å®é™…å¹¶å‘é—®é¢˜éƒ½å¯ä»¥ç”¨ç”Ÿäº§è€…-æ¶ˆè´¹è€…è§£å†³ã€‚</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">void Tproduce() &#123; while (1) printf(&quot;(&quot;); &#125;</span><br><span class="line">void Tconsume() &#123; while (1) printf(&quot;)&quot;); &#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>printf</code> å‰åå¢åŠ ä»£ç ï¼Œä½¿å¾—æ‰“å°çš„æ‹¬å·åºåˆ—æ»¡è¶³</p>
<ul>
<li><p>ä¸€å®šæ˜¯æŸä¸ªåˆæ³•æ‹¬å·åºåˆ—çš„å‰ç¼€</p>
</li>
<li><p>æ‹¬å·åµŒå¥—çš„æ·±åº¦ä¸è¶…è¿‡ </p>
<p>n</p>
<ul>
<li><em>n</em>=3, <code>((())())(((</code> åˆæ³•</li>
<li><em>n</em>=3, <code>(((())))</code>, <code>(()))</code> ä¸åˆæ³•</li>
</ul>
</li>
<li><p>ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ä¸­çš„åŒæ­¥</p>
<ul>
<li>Tproduce: ç­‰åˆ°æœ‰ç©ºä½æ—¶æ‰èƒ½æ‰“å°å·¦æ‹¬å·</li>
<li>Tconsume: ç­‰åˆ°æœ‰å¤šä½™çš„å·¦æ‹¬å·æ—¶æ‰èƒ½æ‰“å°å³æ‹¬å·</li>
</ul>
</li>
</ul>
<h2 id="è®¡ç®—å›¾ã€è°ƒåº¦å™¨å’Œç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜"><a href="#è®¡ç®—å›¾ã€è°ƒåº¦å™¨å’Œç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜" class="headerlink" title="è®¡ç®—å›¾ã€è°ƒåº¦å™¨å’Œç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜"></a>è®¡ç®—å›¾ã€è°ƒåº¦å™¨å’Œç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜</h2><p>ä¸ºä»€ä¹ˆå« â€œç”Ÿäº§è€…-æ¶ˆè´¹è€…â€ è€Œä¸æ˜¯ â€œæ‹¬å·é—®é¢˜â€ï¼Ÿ</p>
<ul>
<li>å·¦æ‹¬å·ï¼šç”Ÿäº§èµ„æº (ä»»åŠ¡)ã€æ”¾å…¥é˜Ÿåˆ—</li>
<li>å³æ‹¬å·ï¼šä»é˜Ÿåˆ—å–å‡ºèµ„æº (ä»»åŠ¡) æ‰§è¡Œ</li>
</ul>
<p>å¹¶è¡Œè®¡ç®—åŸºç¡€ï¼šè®¡ç®—å›¾</p>
<ul>
<li>è®¡ç®—ä»»åŠ¡æ„æˆæœ‰å‘æ— ç¯å›¾<ul>
<li>(<em>u</em>,<em>v</em>)âˆˆ<em>E</em> è¡¨ç¤º <em>v</em> è¦ç”¨åˆ°å‰<em>u</em> çš„å€¼</li>
</ul>
</li>
<li>åªè¦è°ƒåº¦å™¨ (ç”Ÿäº§è€…) åˆ†é…ä»»åŠ¡æ•ˆç‡å¤Ÿé«˜ï¼Œç®—æ³•å°±èƒ½å¹¶è¡Œ<ul>
<li>ç”Ÿäº§è€…æŠŠä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ä¸­</li>
<li>æ¶ˆè´¹è€… (workers) ä»é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡</li>
</ul>
</li>
</ul>
<h2 id="ç”Ÿäº§è€…-æ¶ˆè´¹è€…ï¼šå®ç°"><a href="#ç”Ÿäº§è€…-æ¶ˆè´¹è€…ï¼šå®ç°" class="headerlink" title="ç”Ÿäº§è€…-æ¶ˆè´¹è€…ï¼šå®ç°"></a>ç”Ÿäº§è€…-æ¶ˆè´¹è€…ï¼šå®ç°</h2><p>èƒ½å¦ç”¨äº’æ–¥é”å®ç°æ‹¬å·é—®é¢˜ï¼Ÿ</p>
<ul>
<li>å·¦æ‹¬å·ï¼šåµŒå¥—æ·±åº¦ (é˜Ÿåˆ—) ä¸è¶³ <em>n</em> æ—¶æ‰èƒ½æ‰“å°</li>
<li>å³æ‹¬å·ï¼šåµŒå¥—æ·±åº¦ (é˜Ÿåˆ—) &gt;1&gt;1 æ—¶æ‰èƒ½æ‰“å°<ul>
<li>å½“ç„¶æ˜¯ç­‰åˆ°æ»¡è¶³æ¡ä»¶æ—¶å†æ‰“å°äº† (ä»£ç æ¼”ç¤º)<ul>
<li>ç”¨äº’æ–¥é”ä¿æŒæ¡ä»¶æˆç«‹</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>å¹¶å‘ï¼šå°å¿ƒï¼</p>
<ul>
<li>å‹åŠ›æµ‹è¯• + è§‚å¯Ÿè¾“å‡ºç»“æœ</li>
<li>è‡ªåŠ¨è§‚å¯Ÿè¾“å‡ºç»“æœï¼š<a target="_blank" rel="noopener" href="https://jyywiki.cn/pages/OS/2023/c/pc-check.py">pc-check.py</a></li>
<li>æœªæ¥ï¼šcopilot è§‚å¯Ÿè¾“å‡ºç»“æœï¼Œå¹¶ç»™å‡ºä¿®å¤å»ºè®®</li>
<li><p>æ›´è¿œçš„æœªæ¥ï¼š<del>æˆ‘ä»¬éƒ½ä¸éœ€è¦ä¸å­˜åœ¨äº†</del></p>
<p>pc-mutex.c</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;thread.h&quot;</span><br><span class="line">#include &quot;thread-sync.h&quot;</span><br><span class="line"></span><br><span class="line">int n, count = 0;</span><br><span class="line">mutex_t lk = MUTEX_INIT();</span><br><span class="line"></span><br><span class="line">#define CAN_PRODUCE (count &lt; n)</span><br><span class="line">#define CAN_CONSUME (count &gt; 0)</span><br><span class="line"></span><br><span class="line">void Tproduce() &#123;</span><br><span class="line">  while (1) &#123;</span><br><span class="line">retry:</span><br><span class="line">    mutex_lock(&amp;lk);</span><br><span class="line">    if (!CAN_PRODUCE) &#123;</span><br><span class="line">      mutex_unlock(&amp;lk);</span><br><span class="line">      goto retry;</span><br><span class="line">    &#125;</span><br><span class="line">    count++;</span><br><span class="line">    printf(&quot;(&quot;);  // Push an element into buffer</span><br><span class="line">    mutex_unlock(&amp;lk);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void Tconsume() &#123;</span><br><span class="line">  while (1) &#123;</span><br><span class="line">retry:</span><br><span class="line">    mutex_lock(&amp;lk);</span><br><span class="line">    if (!CAN_CONSUME) &#123;</span><br><span class="line">      mutex_unlock(&amp;lk);</span><br><span class="line">      goto retry;</span><br><span class="line">    &#125;</span><br><span class="line">    count--;</span><br><span class="line">    printf(&quot;)&quot;);  // Pop an element from buffer</span><br><span class="line">    mutex_unlock(&amp;lk);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc, char *argv[]) &#123;</span><br><span class="line">  assert(argc == 2);</span><br><span class="line">  n = atoi(argv[1]);</span><br><span class="line">  setbuf(stdout, NULL);</span><br><span class="line">  for (int i = 0; i &lt; 8; i++) &#123;</span><br><span class="line">    create(Tproduce);</span><br><span class="line">    create(Tconsume);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>thread-sync.h</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;semaphore.h&gt;</span><br><span class="line"></span><br><span class="line">// Spinlock</span><br><span class="line">typedef int spinlock_t;</span><br><span class="line">#define SPIN_INIT() 0</span><br><span class="line"></span><br><span class="line">static inline int atomic_xchg(volatile int *addr, int newval) &#123;</span><br><span class="line">  int result;</span><br><span class="line">  asm volatile (&quot;lock xchg %0, %1&quot;:</span><br><span class="line">    &quot;+m&quot;(*addr), &quot;=a&quot;(result) : &quot;1&quot;(newval) : &quot;memory&quot;);</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void spin_lock(spinlock_t *lk) &#123;</span><br><span class="line">  while (1) &#123;</span><br><span class="line">    intptr_t value = atomic_xchg(lk, 1);</span><br><span class="line">    if (value == 0) &#123;</span><br><span class="line">      break;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">void spin_unlock(spinlock_t *lk) &#123;</span><br><span class="line">  atomic_xchg(lk, 0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Mutex</span><br><span class="line">typedef pthread_mutex_t mutex_t;</span><br><span class="line">#define MUTEX_INIT() PTHREAD_MUTEX_INITIALIZER</span><br><span class="line">void mutex_lock(mutex_t *lk)   &#123; pthread_mutex_lock(lk); &#125;</span><br><span class="line">void mutex_unlock(mutex_t *lk) &#123; pthread_mutex_unlock(lk); &#125;</span><br><span class="line"></span><br><span class="line">// Conditional Variable</span><br><span class="line">typedef pthread_cond_t cond_t;</span><br><span class="line">#define COND_INIT() PTHREAD_COND_INITIALIZER</span><br><span class="line">#define cond_wait pthread_cond_wait</span><br><span class="line">#define cond_broadcast pthread_cond_broadcast</span><br><span class="line">#define cond_signal pthread_cond_signal</span><br><span class="line"></span><br><span class="line">// Semaphore</span><br><span class="line">#define P sem_wait</span><br><span class="line">#define V sem_post</span><br><span class="line">#define SEM_INIT(sem, val) sem_init(sem, 0, val)</span><br></pre></td></tr></table></figure>
<h2 id="æ¡ä»¶å˜é‡"><a href="#æ¡ä»¶å˜é‡" class="headerlink" title="æ¡ä»¶å˜é‡"></a>æ¡ä»¶å˜é‡</h2><h2 id="åŒæ­¥é—®é¢˜ï¼šåˆ†æ"><a href="#åŒæ­¥é—®é¢˜ï¼šåˆ†æ" class="headerlink" title="åŒæ­¥é—®é¢˜ï¼šåˆ†æ"></a>åŒæ­¥é—®é¢˜ï¼šåˆ†æ</h2><blockquote>
<p>çº¿ç¨‹åŒæ­¥ç”±æ¡ä»¶ä¸æˆç«‹ç­‰å¾…å’ŒåŒæ­¥æ¡ä»¶è¾¾æˆç»§ç»­æ„æˆ</p>
</blockquote>
<p>çº¿ç¨‹ join</p>
<ul>
<li>Tmain åŒæ­¥æ¡ä»¶ï¼š<code>nexit == T</code></li>
<li>Tmain è¾¾æˆåŒæ­¥ï¼šæœ€åä¸€ä¸ªçº¿ç¨‹é€€å‡º <code>nexit++</code></li>
</ul>
<p>ç”Ÿäº§è€…/æ¶ˆè´¹è€…é—®é¢˜</p>
<ul>
<li>Tproduce åŒæ­¥æ¡ä»¶ï¼š<code>CAN_PRODUCE (count &lt; n)</code></li>
<li>Tproduce è¾¾æˆåŒæ­¥ï¼šTconsume <code>count--</code></li>
<li>Tconsume åŒæ­¥æ¡ä»¶ï¼š<code>CAN_CONSUME (count &gt; 0)</code></li>
<li>Tconsume è¾¾æˆåŒæ­¥ï¼šTproduce <code>count++</code></li>
</ul>
<h2 id="æ¡ä»¶å˜é‡ï¼šç†æƒ³ä¸å®ç°ä¹‹é—´çš„æŠ˜è¡·"><a href="#æ¡ä»¶å˜é‡ï¼šç†æƒ³ä¸å®ç°ä¹‹é—´çš„æŠ˜è¡·" class="headerlink" title="æ¡ä»¶å˜é‡ï¼šç†æƒ³ä¸å®ç°ä¹‹é—´çš„æŠ˜è¡·"></a>æ¡ä»¶å˜é‡ï¼šç†æƒ³ä¸å®ç°ä¹‹é—´çš„æŠ˜è¡·</h2><p>ä¸€æŠŠäº’æ–¥é” + ä¸€ä¸ª â€œæ¡ä»¶å˜é‡â€ + æ‰‹å·¥å”¤é†’</p>
<ul>
<li>wait(cv, mutex) ğŸ’¤<ul>
<li>è°ƒç”¨æ—¶å¿…é¡»ä¿è¯å·²ç»è·å¾— mutex</li>
<li>wait é‡Šæ”¾ mutexã€è¿›å…¥ç¡çœ çŠ¶æ€</li>
<li>è¢«å”¤é†’åéœ€è¦é‡æ–°æ‰§è¡Œ lock(mutex)</li>
</ul>
</li>
<li>signal/notify(cv) ğŸ’¬<ul>
<li>éšæœºç§ä¿¡ä¸€ä¸ªç­‰å¾…è€…ï¼šé†’é†’</li>
<li>å¦‚æœæœ‰çº¿ç¨‹æ­£åœ¨ç­‰å¾… cvï¼Œåˆ™å”¤é†’å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹</li>
</ul>
</li>
<li>broadcast/notifyAll(cv) ğŸ“£<ul>
<li>å«é†’æ‰€æœ‰äºº</li>
<li>å”¤é†’å…¨éƒ¨æ­£åœ¨ç­‰å¾… cv çš„çº¿ç¨‹</li>
</ul>
</li>
</ul>
<h2 id="æ¡ä»¶å˜é‡ï¼šåº”ç”¨"><a href="#æ¡ä»¶å˜é‡ï¼šåº”ç”¨" class="headerlink" title="æ¡ä»¶å˜é‡ï¼šåº”ç”¨"></a>æ¡ä»¶å˜é‡ï¼šåº”ç”¨</h2><h2 id="æ¡ä»¶å˜é‡ï¼šä¸‡èƒ½å¹¶è¡Œè®¡ç®—æ¡†æ¶-M2"><a href="#æ¡ä»¶å˜é‡ï¼šä¸‡èƒ½å¹¶è¡Œè®¡ç®—æ¡†æ¶-M2" class="headerlink" title="æ¡ä»¶å˜é‡ï¼šä¸‡èƒ½å¹¶è¡Œè®¡ç®—æ¡†æ¶ (M2)"></a>æ¡ä»¶å˜é‡ï¼šä¸‡èƒ½å¹¶è¡Œè®¡ç®—æ¡†æ¶ (M2)</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">struct work &#123;</span><br><span class="line">  void (*run)(void *arg);</span><br><span class="line">  void *arg;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void Tworker() &#123;</span><br><span class="line">  while (1) &#123;</span><br><span class="line">    struct work *work;</span><br><span class="line">    wait_until(has_new_work() || all_done) &#123;</span><br><span class="line">      work = get_work();</span><br><span class="line">    &#125;</span><br><span class="line">    if (!work) break;</span><br><span class="line">    else &#123;</span><br><span class="line">      work-&gt;run(work-&gt;arg); // å…è®¸ç”Ÿæˆæ–°çš„ work (æ³¨æ„äº’æ–¥)</span><br><span class="line">      release(work);  // æ³¨æ„å›æ”¶ work åˆ†é…çš„èµ„æº</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>fish.c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;thread.h&quot;</span><br><span class="line">#include &quot;thread-sync.h&quot;</span><br><span class="line"></span><br><span class="line">#define LENGTH(arr) (sizeof(arr) / sizeof(arr[0]))</span><br><span class="line"></span><br><span class="line">enum &#123; A = 1, B, C, D, E, F, &#125;;</span><br><span class="line"></span><br><span class="line">struct rule &#123;</span><br><span class="line">  int from, ch, to;</span><br><span class="line">&#125; rules[] = &#123;</span><br><span class="line">  &#123; A, &#x27;&lt;&#x27;, B &#125;,</span><br><span class="line">  &#123; B, &#x27;&gt;&#x27;, C &#125;,</span><br><span class="line">  &#123; C, &#x27;&lt;&#x27;, D &#125;,</span><br><span class="line">  &#123; A, &#x27;&gt;&#x27;, E &#125;,</span><br><span class="line">  &#123; E, &#x27;&lt;&#x27;, F &#125;,</span><br><span class="line">  &#123; F, &#x27;&gt;&#x27;, D &#125;,</span><br><span class="line">  &#123; D, &#x27;_&#x27;, A &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">int current = A, quota = 1;</span><br><span class="line"></span><br><span class="line">mutex_t lk = MUTEX_INIT();</span><br><span class="line">cond_t cv = COND_INIT();</span><br><span class="line"></span><br><span class="line">int next(char ch) &#123;</span><br><span class="line">  for (int i = 0; i &lt; LENGTH(rules); i++) &#123;</span><br><span class="line">    struct rule *rule = &amp;rules[i];</span><br><span class="line">    if (rule-&gt;from == current &amp;&amp; rule-&gt;ch == ch) &#123;</span><br><span class="line">      return rule-&gt;to;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static int can_print(char ch) &#123;</span><br><span class="line">    return next(ch) != 0 &amp;&amp; quota &gt; 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void fish_before(char ch) &#123;</span><br><span class="line">  mutex_lock(&amp;lk);</span><br><span class="line">  while (!can_print(ch)) &#123;</span><br><span class="line">    // can proceed only if (next(ch) &amp;&amp; quota)</span><br><span class="line">    cond_wait(&amp;cv, &amp;lk);</span><br><span class="line">  &#125;</span><br><span class="line">  quota--;</span><br><span class="line">  mutex_unlock(&amp;lk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void fish_after(char ch) &#123;</span><br><span class="line">  mutex_lock(&amp;lk);</span><br><span class="line">  quota++;</span><br><span class="line">  current = next(ch);</span><br><span class="line">  assert(current);</span><br><span class="line">  cond_broadcast(&amp;cv);</span><br><span class="line">  mutex_unlock(&amp;lk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const char roles[] = &quot;.&lt;&lt;&lt;&lt;&lt;&gt;&gt;&gt;&gt;___&quot;;</span><br><span class="line"></span><br><span class="line">void fish_thread(int id) &#123;</span><br><span class="line">  char role = roles[id];</span><br><span class="line">  while (1) &#123;</span><br><span class="line">    fish_before(role);</span><br><span class="line">    putchar(role);  // Not lock-protected</span><br><span class="line">    fish_after(role);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">  setbuf(stdout, NULL);</span><br><span class="line">  for (int i = 0; i &lt; strlen(roles); i++)</span><br><span class="line">    create(fish_thread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="https://blog.huii.top">HUII</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://blog.huii.top/Note/1c744868e51f.html">https://blog.huii.top/Note/1c744868e51f.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://blog.huii.top" target="_blank">HUII's Blog</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">æ“ä½œç³»ç»Ÿ</a><a class="post-meta__tags" href="/tags/OS/">OS</a></div><div class="post_share"><div class="social-share" data-image="/img/image-8.png" data-sites="qq,wechat,weibo,facebook,twitter"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/Coding/696b8b395e9f.html" title="Pythonå°tipsã€æŒç»­æ›´æ–°ã€‘"><img class="cover" src="/img/python.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">Pythonå°tipsã€æŒç»­æ›´æ–°ã€‘</div></div></a></div><div class="next-post pull-right"><a href="/MachineLearning/4543f3866cda.html" title="YOLO v1ç¬”è®°"><img class="cover" src="/img/machinelearning.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">YOLO v1ç¬”è®°</div></div></a></div></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%AA%E8%AE%BA1-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0-2023-2-14"><span class="toc-number">1.</span> <span class="toc-text">ç»ªè®º1_æ“ä½œç³»ç»Ÿæ¦‚è¿°_2023.2.14</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Why%E4%B8%BA%E4%BB%80%E4%B9%88%E5%AD%A6%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.1.</span> <span class="toc-text">Whyä¸ºä»€ä¹ˆå­¦æ“ä½œç³»ç»Ÿ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What%E4%BB%80%E4%B9%88%E6%98%AF%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.2.</span> <span class="toc-text">Whatä»€ä¹ˆæ˜¯æ“ä½œç³»ç»Ÿ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#How%E6%80%8E%E6%A0%B7%E5%AD%A6%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.3.</span> <span class="toc-text">Howæ€æ ·å­¦æ“ä½œç³»ç»Ÿ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E4%BB%A3%E7%A0%81"><span class="toc-number">1.4.</span> <span class="toc-text">è¯¾ç¨‹ä»£ç </span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E6%8B%9F%E6%95%B0%E5%AD%97%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.4.1.</span> <span class="toc-text">æ¨¡æ‹Ÿæ•°å­—ç³»ç»Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E6%8B%9F-RISC-V-%E6%8C%87%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="toc-number">1.4.2.</span> <span class="toc-text">æ¨¡æ‹Ÿ RISC-V æŒ‡ä»¤æ‰§è¡Œ</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%AA%E8%AE%BA2-%E5%BA%94%E7%94%A8%E8%A7%86%E8%A7%92%E7%9A%84%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-2023-2-16"><span class="toc-number">2.</span> <span class="toc-text">ç»ªè®º2_åº”ç”¨è§†è§’çš„æ“ä½œç³»ç»Ÿ_2023.2.16</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B1%87%E7%BC%96%E4%BB%A3%E7%A0%81%E5%92%8C%E6%9C%80%E5%B0%8F%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6"><span class="toc-number">2.1.</span> <span class="toc-text">æ±‡ç¼–ä»£ç å’Œæœ€å°å¯æ‰§è¡Œæ–‡ä»¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E6%9C%80%E5%B0%8F%E7%9A%84-Hello-World-%E2%80%9C%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E2%80%9D"><span class="toc-number">2.1.1.</span> <span class="toc-text">æ„é€ æœ€å°çš„ Hello, World â€œåº”ç”¨ç¨‹åºâ€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%BA%E8%A1%8C%E6%9E%84%E9%80%A0%E6%9C%80%E5%B0%8F%E7%9A%84-Hello-World%EF%BC%9F"><span class="toc-number">2.1.2.</span> <span class="toc-text">å¼ºè¡Œæ„é€ æœ€å°çš„ Hello, Worldï¼Ÿ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A-Segmentation-Fault%EF%BC%9F"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">ä¸ºä»€ä¹ˆä¼š Segmentation Faultï¼Ÿ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E5%BC%82%E5%B8%B8%E9%80%80%E5%87%BA"><span class="toc-number">2.1.3.</span> <span class="toc-text">è§£å†³å¼‚å¸¸é€€å‡º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E4%B8%80%E4%BA%9B%E7%BB%86%E8%8A%82%E7%9A%84%E8%A1%A5%E5%85%85%E8%A7%A3%E9%87%8A"><span class="toc-number">2.1.4.</span> <span class="toc-text">å¯¹ä¸€äº›ç»†èŠ‚çš„è¡¥å……è§£é‡Š</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B1%87%E7%BC%96%E4%BB%A3%E7%A0%81%E7%9A%84%E7%8A%B6%E6%80%81%E6%9C%BA%E6%A8%A1%E5%9E%8B"><span class="toc-number">2.1.5.</span> <span class="toc-text">æ±‡ç¼–ä»£ç çš„çŠ¶æ€æœºæ¨¡å‹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%90%86%E8%A7%A3%E9%AB%98%E7%BA%A7%E8%AF%AD%E8%A8%80%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.2.</span> <span class="toc-text">ç†è§£é«˜çº§è¯­è¨€ç¨‹åº</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9E%E9%80%92%E5%BD%92%E6%B1%89%E8%AF%BA%E5%A1%94%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.2.0.1.</span> <span class="toc-text">éé€’å½’æ±‰è¯ºå¡”å®ç°</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%90%86%E8%A7%A3%E7%BC%96%E8%AF%91%E5%99%A8"><span class="toc-number">2.3.</span> <span class="toc-text">ç†è§£ç¼–è¯‘å™¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%8A%E7%9A%84%E8%BD%AF%E4%BB%B6-%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.4.</span> <span class="toc-text">æ“ä½œç³»ç»Ÿä¸Šçš„è½¯ä»¶ (åº”ç”¨ç¨‹åº)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E4%BB%BB%E4%BD%95%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.4.1.</span> <span class="toc-text">æ“ä½œç³»ç»Ÿä¸­çš„ä»»ä½•ç¨‹åº</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#define-SECT-SIZE-512"><span class="toc-number">3.</span> <span class="toc-text">define SECT_SIZE  512</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kill-process-QEMU-on-gdb-exits"><span class="toc-number">4.</span> <span class="toc-text">Kill process (QEMU) on gdb exits</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Connect-to-remote"><span class="toc-number">5.</span> <span class="toc-text">Connect to remote</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#include"><span class="toc-number">6.</span> <span class="toc-text">include </span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#define-ESC-%E2%80%9C-033-%E2%80%9C"><span class="toc-number">7.</span> <span class="toc-text">define ESC â€œ\033[â€œ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#define-RED-ESC-%E2%80%9C01-31m%E2%80%9D"><span class="toc-number">8.</span> <span class="toc-text">define RED ESC â€œ01;31mâ€</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#define-CLR-ESC-%E2%80%9C0m%E2%80%9D"><span class="toc-number">9.</span> <span class="toc-text">define CLR ESC â€œ0mâ€</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#include-1"><span class="toc-number">10.</span> <span class="toc-text">include </span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#include-2"><span class="toc-number">11.</span> <span class="toc-text">include </span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#include-3"><span class="toc-number">12.</span> <span class="toc-text">include </span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#usr-bin-env-python3"><span class="toc-number">13.</span> <span class="toc-text">!&#x2F;usr&#x2F;bin&#x2F;env python3</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#usr-bin-env-python3-1"><span class="toc-number">14.</span> <span class="toc-text">!&#x2F;usr&#x2F;bin&#x2F;env python3</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Mosaic-Emulator-and-Checker"><span class="toc-number">15.</span> <span class="toc-text">Mosaic Emulator and Checker</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Mosaic-system-calls"><span class="toc-number">15.1.</span> <span class="toc-text">1. Mosaic system calls</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-Process-thread-and-context-switching"><span class="toc-number">15.1.1.</span> <span class="toc-text">1.1 Process, thread, and context switching</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-Virtual-character-device"><span class="toc-number">15.1.2.</span> <span class="toc-text">1.2 Virtual character device</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-Virtual-block-storage-device"><span class="toc-number">15.1.3.</span> <span class="toc-text">1.3 Virtual block storage device</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-System-call-helpers"><span class="toc-number">15.1.4.</span> <span class="toc-text">1.4 System call helpers</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Mosaic-operating-system-emulator"><span class="toc-number">15.2.</span> <span class="toc-text">2. Mosaic operating system emulator</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Data-structures"><span class="toc-number">15.2.1.</span> <span class="toc-text">2.1 Data structures</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-The-OperatingSystem-class"><span class="toc-number">15.2.2.</span> <span class="toc-text">2.2 The OperatingSystem class</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-System-call-implementation"><span class="toc-number">15.2.3.</span> <span class="toc-text">2.3 System call implementation</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1-Process-thread-and-context-switching"><span class="toc-number">15.2.3.1.</span> <span class="toc-text">2.3.1 Process, thread, and context switching</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2-Virtual-character-device-byte-stream"><span class="toc-number">15.2.4.</span> <span class="toc-text">2.3.2 Virtual character device (byte stream)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-3-Virtual-block-storage-device"><span class="toc-number">15.2.5.</span> <span class="toc-text">2.3.3 Virtual block storage device</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-Operating-system-as-a-state-machine"><span class="toc-number">15.2.6.</span> <span class="toc-text">2.4 Operating system as a state machine</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-Misc-and-helper-functions"><span class="toc-number">15.2.7.</span> <span class="toc-text">2.5 Misc and helper functions</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-The-Mosaic-runtime"><span class="toc-number">15.3.</span> <span class="toc-text">3. The Mosaic runtime</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Model-interpreter-and-checker"><span class="toc-number">15.3.1.</span> <span class="toc-text">3.1 Model interpreter and checker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Source-code-parsing-and-rewriting"><span class="toc-number">15.3.2.</span> <span class="toc-text">3.1 Source code parsing and rewriting</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Utilities"><span class="toc-number">15.4.</span> <span class="toc-text">4. Utilities</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#include-%E2%80%9Cthread-h%E2%80%9D"><span class="toc-number">16.</span> <span class="toc-text">include â€œthread.hâ€</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#include-4"><span class="toc-number">17.</span> <span class="toc-text">include </span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#include-5"><span class="toc-number">18.</span> <span class="toc-text">include </span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#include-6"><span class="toc-number">19.</span> <span class="toc-text">include </span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#include-7"><span class="toc-number">20.</span> <span class="toc-text">include </span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#include-8"><span class="toc-number">21.</span> <span class="toc-text">include </span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#include-9"><span class="toc-number">22.</span> <span class="toc-text">include </span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#include-10"><span class="toc-number">23.</span> <span class="toc-text">include </span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#define-NTHREAD-64"><span class="toc-number">24.</span> <span class="toc-text">define NTHREAD 64</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#include-%E2%80%9Cthread-h%E2%80%9D-1"><span class="toc-number">25.</span> <span class="toc-text">include â€œthread.hâ€</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#include-%E2%80%9Cthread-h%E2%80%9D-2"><span class="toc-number">26.</span> <span class="toc-text">include â€œthread.hâ€</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#include-11"><span class="toc-number">27.</span> <span class="toc-text">include </span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#include-%E2%80%9Cthread-h%E2%80%9D-3"><span class="toc-number">28.</span> <span class="toc-text">include â€œthread.hâ€</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#define-N-100000000"><span class="toc-number">29.</span> <span class="toc-text">define N 100000000</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#define-N-100000000-1"><span class="toc-number">30.</span> <span class="toc-text">define N 100000000</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BE%E5%BC%83-3-%EF%BC%9A%E5%A4%84%E7%90%86%E5%99%A8%E9%97%B4%E7%9A%84%E5%8F%AF%E8%A7%81%E6%80%A7"><span class="toc-number">30.1.</span> <span class="toc-text">æ”¾å¼ƒ (3)ï¼šå¤„ç†å™¨é—´çš„å¯è§æ€§</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%B0%E4%BB%A3%E5%A4%84%E7%90%86%E5%99%A8%E4%B9%9F%E6%98%AF-%E5%8A%A8%E6%80%81-%E7%BC%96%E8%AF%91%E5%99%A8%EF%BC%81"><span class="toc-number">30.1.1.</span> <span class="toc-text">ç°ä»£å¤„ç†å™¨ä¹Ÿæ˜¯ (åŠ¨æ€) ç¼–è¯‘å™¨ï¼</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%BD%E6%9D%BE%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B-Relaxed-Weak-Memory-Model"><span class="toc-number">30.1.2.</span> <span class="toc-text">å®½æ¾å†…å­˜æ¨¡å‹ (Relaxed&#x2F;Weak Memory Model)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B9%B6%E5%8F%912-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%E5%9F%BA%E7%A1%80-2023-3-9"><span class="toc-number">31.</span> <span class="toc-text">å¹¶å‘2_å¹¶å‘æ§åˆ¶åŸºç¡€_2023.3.9</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%92%E6%96%A5%E9%97%AE%E9%A2%98"><span class="toc-number">31.1.</span> <span class="toc-text">äº’æ–¥é—®é¢˜</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%9A%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83"><span class="toc-number">31.1.1.</span> <span class="toc-text">å¹¶å‘ç¼–ç¨‹ï¼šä»å…¥é—¨åˆ°æ”¾å¼ƒ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9E%E9%80%80%E5%88%B0%E9%A1%BA%E5%BA%8F%E6%89%A7%E8%A1%8C%EF%BC%9A%E4%BA%92%E6%96%A5"><span class="toc-number">31.1.2.</span> <span class="toc-text">å›é€€åˆ°é¡ºåºæ‰§è¡Œï¼šäº’æ–¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%B1%E8%B4%A5%E7%9A%84%E5%B0%9D%E8%AF%95"><span class="toc-number">31.1.3.</span> <span class="toc-text">å¤±è´¥çš„å°è¯•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E4%B8%A5%E8%82%83%E5%9C%B0%E5%B0%9D%E8%AF%95%EF%BC%9A%E7%A1%AE%E5%AE%9A%E5%81%87%E8%AE%BE%E3%80%81%E8%AE%BE%E8%AE%A1%E7%AE%97%E6%B3%95"><span class="toc-number">31.1.4.</span> <span class="toc-text">æ›´ä¸¥è‚ƒåœ°å°è¯•ï¼šç¡®å®šå‡è®¾ã€è®¾è®¡ç®—æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E7%A1%AE%E6%80%A7%E4%B8%8D%E6%98%8E%E7%9A%84%E5%A5%87%E6%80%AA%E5%B0%9D%E8%AF%95-Peterson-%E7%AE%97%E6%B3%95"><span class="toc-number">31.1.5.</span> <span class="toc-text">æ­£ç¡®æ€§ä¸æ˜çš„å¥‡æ€ªå°è¯• (Peterson ç®—æ³•)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B9%A0%E9%A2%98%EF%BC%9A%E8%AF%81%E6%98%8E-Peterson-%E7%AE%97%E6%B3%95%E6%AD%A3%E7%A1%AE%EF%BC%8C%E6%88%96%E7%BB%99%E5%87%BA%E5%8F%8D%E4%BE%8B"><span class="toc-number">31.1.6.</span> <span class="toc-text">ä¹ é¢˜ï¼šè¯æ˜ Peterson ç®—æ³•æ­£ç¡®ï¼Œæˆ–ç»™å‡ºåä¾‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E6%9D%A5%E7%BB%95%E5%8E%BB%E5%BE%88%E5%AE%B9%E6%98%93%E6%9C%89%E9%94%99%E6%BC%8F%E7%9A%84%E6%83%85%E5%86%B5"><span class="toc-number">31.1.7.</span> <span class="toc-text">ç»•æ¥ç»•å»å¾ˆå®¹æ˜“æœ‰é”™æ¼çš„æƒ…å†µ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E5%9E%8B%E3%80%81%E6%A8%A1%E5%9E%8B%E6%A3%80%E9%AA%8C%E4%B8%8E%E7%8E%B0%E5%AE%9E"><span class="toc-number">31.2.</span> <span class="toc-text">æ¨¡å‹ã€æ¨¡å‹æ£€éªŒä¸ç°å®</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%80%9CPush-button%E2%80%9D-Verification-%F0%9F%8E%96"><span class="toc-number">31.2.1.</span> <span class="toc-text">â€œPush-buttonâ€ Verification ğŸ–</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E9%81%8D%E5%8E%86%E7%8A%B6%E6%80%81%E7%A9%BA%E9%97%B4%E7%9A%84%E4%B9%90%E8%B6%A3"><span class="toc-number">31.2.2.</span> <span class="toc-text">è‡ªåŠ¨éå†çŠ¶æ€ç©ºé—´çš„ä¹è¶£</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E%E6%A8%A1%E5%9E%8B%E5%9B%9E%E5%88%B0%E7%8E%B0%E5%AE%9E%E2%80%A6%E2%80%A6"><span class="toc-number">31.2.3.</span> <span class="toc-text">ä»æ¨¡å‹å›åˆ°ç°å®â€¦â€¦</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E6%8C%87%E4%BB%A4"><span class="toc-number">31.3.</span> <span class="toc-text">åŸå­æŒ‡ä»¤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%9B%B0%E9%9A%BE%E7%9A%84%E8%A7%A3%E5%86%B3"><span class="toc-number">31.3.1.</span> <span class="toc-text">å¹¶å‘ç¼–ç¨‹å›°éš¾çš„è§£å†³</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%AD%A3%E7%A1%AE%E7%9A%84%E6%B1%82%E5%92%8C"><span class="toc-number">31.3.2.</span> <span class="toc-text">å®ç°æ­£ç¡®çš„æ±‚å’Œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%99%A8%E5%92%8C%E7%A1%AC%E4%BB%B6%E7%9A%84%E5%8D%8F%E4%BD%9C"><span class="toc-number">31.3.3.</span> <span class="toc-text">ç¼–è¯‘å™¨å’Œç¡¬ä»¶çš„åä½œ</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B9%B6%E5%8F%913-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%EF%BC%9A%E4%BA%92%E6%96%A5-2023-3-14"><span class="toc-number">32.</span> <span class="toc-text">å¹¶å‘3_å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥_2023.3.14</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%92%E6%96%A5%E9%97%AE%E9%A2%98%EF%BC%9A%E5%AE%9A%E4%B9%89%E4%B8%8E%E5%81%87%E8%AE%BE"><span class="toc-number">32.1.</span> <span class="toc-text">äº’æ–¥é—®é¢˜ï¼šå®šä¹‰ä¸å‡è®¾</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%92%E6%96%A5%E9%97%AE%E9%A2%98%EF%BC%9A%E5%AE%9A%E4%B9%89"><span class="toc-number">32.1.1.</span> <span class="toc-text">äº’æ–¥é—®é¢˜ï¼šå®šä¹‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%92%E6%96%A5%E9%97%AE%E9%A2%98%E7%9A%84%E7%BB%8F%E5%85%B8%E7%AE%97%E6%B3%95"><span class="toc-number">32.1.2.</span> <span class="toc-text">äº’æ–¥é—®é¢˜çš„ç»å…¸ç®—æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BA%92%E6%96%A5%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%81%87%E8%AE%BE"><span class="toc-number">32.1.3.</span> <span class="toc-text">å®ç°äº’æ–¥çš„åŸºæœ¬å‡è®¾</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Atomic-Exchange-%E5%AE%9E%E7%8E%B0"><span class="toc-number">32.1.4.</span> <span class="toc-text">Atomic Exchange å®ç°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E6%97%8B%E9%94%81-Spin-Lock"><span class="toc-number">32.2.</span> <span class="toc-text">è‡ªæ—‹é” (Spin Lock)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E6%97%8B%E9%94%81-Spin-Lock-1"><span class="toc-number">32.2.1.</span> <span class="toc-text">è‡ªæ—‹é” (Spin Lock)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E6%97%8B%E9%94%81%EF%BC%9A%E7%94%A8-xchg-%E5%AE%9E%E7%8E%B0%E4%BA%92%E6%96%A5"><span class="toc-number">32.2.2.</span> <span class="toc-text">è‡ªæ—‹é”ï¼šç”¨ xchg å®ç°äº’æ–¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BA%92%E6%96%A5%EF%BC%9A%E8%87%AA%E6%97%8B%E9%94%81"><span class="toc-number">32.2.3.</span> <span class="toc-text">å®ç°äº’æ–¥ï¼šè‡ªæ—‹é”</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E5%BC%BA%E5%A4%A7%E7%9A%84%E5%8E%9F%E5%AD%90%E6%8C%87%E4%BB%A4"><span class="toc-number">32.3.</span> <span class="toc-text">æ›´å¼ºå¤§çš„åŸå­æŒ‡ä»¤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E5%BC%BA%E5%A4%A7%E7%9A%84%E5%8E%9F%E5%AD%90%E6%8C%87%E4%BB%A4-1"><span class="toc-number">32.3.1.</span> <span class="toc-text">æ›´å¼ºå¤§çš„åŸå­æŒ‡ä»¤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E8%87%AA%E6%97%8B%E9%94%81%E4%B8%AD%E4%BB%A3%E6%9B%BF-xchg"><span class="toc-number">32.3.2.</span> <span class="toc-text">åœ¨è‡ªæ—‹é”ä¸­ä»£æ›¿ xchg</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E5%87%BA%E7%9A%84-Compare-%E7%94%A8%E5%A4%84"><span class="toc-number">32.3.3.</span> <span class="toc-text">å¤šå‡ºçš„ Compare: ç”¨å¤„</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%8A%E5%AE%9E%E7%8E%B0%E4%BA%92%E6%96%A5"><span class="toc-number">32.4.</span> <span class="toc-text">åœ¨æ“ä½œç³»ç»Ÿä¸Šå®ç°äº’æ–¥</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E6%97%8B%E9%94%81%E7%9A%84%E7%BC%BA%E9%99%B7"><span class="toc-number">32.4.1.</span> <span class="toc-text">è‡ªæ—‹é”çš„ç¼ºé™·</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Scalability-%E6%80%A7%E8%83%BD%E7%9A%84%E6%96%B0%E7%BB%B4%E5%BA%A6"><span class="toc-number">32.4.2.</span> <span class="toc-text">Scalability: æ€§èƒ½çš„æ–°ç»´åº¦</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E6%97%8B%E9%94%81%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">32.4.3.</span> <span class="toc-text">è‡ªæ—‹é”çš„ä½¿ç”¨åœºæ™¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%BA%BF%E7%A8%8B-%E9%95%BF%E4%B8%B4%E7%95%8C%E5%8C%BA%E7%9A%84%E4%BA%92%E6%96%A5"><span class="toc-number">32.4.4.</span> <span class="toc-text">å®ç°çº¿ç¨‹ + é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B9%B6%E5%8F%914-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%EF%BC%9A%E8%B0%83%E8%AF%95%E7%90%86%E8%AE%BA%E4%B8%8E%E5%AE%9E%E8%B7%B5-2023-3-16"><span class="toc-number">33.</span> <span class="toc-text">å¹¶å‘4_å¹¶å‘æ§åˆ¶ï¼šè°ƒè¯•ç†è®ºä¸å®è·µ_2023.3.16</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E7%90%86%E8%AE%BA"><span class="toc-number">33.1.</span> <span class="toc-text">è°ƒè¯•ç†è®º</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-GDB-%E8%B0%83%E8%AF%95%E7%A8%8B%E5%BA%8F"><span class="toc-number">33.2.</span> <span class="toc-text">ä½¿ç”¨ GDB è°ƒè¯•ç¨‹åº</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GDB-%E5%85%A5%E9%97%A8"><span class="toc-number">33.3.</span> <span class="toc-text">GDB: å…¥é—¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8C%B6%EF%B8%8F-Futex-Fast-Userspace-muTexes-cont%E2%80%99d"><span class="toc-number">33.4.</span> <span class="toc-text">ğŸŒ¶ï¸ Futex: Fast Userspace muTexes (contâ€™d)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E7%90%86%E8%AE%BA%EF%BC%9A%E5%BA%94%E7%94%A8"><span class="toc-number">33.5.</span> <span class="toc-text">è°ƒè¯•ç†è®ºï¼šåº”ç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E7%90%86%E8%AE%BA%EF%BC%9A%E5%BA%94%E7%94%A8-Again"><span class="toc-number">33.6.</span> <span class="toc-text">è°ƒè¯•ç†è®ºï¼šåº”ç”¨ (Again)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E7%A8%8B%E5%9F%BA%E6%9C%AC%E5%87%86%E5%88%99%EF%BC%9A%E5%9B%9E%E9%A1%BE"><span class="toc-number">33.7.</span> <span class="toc-text">ç¼–ç¨‹åŸºæœ¬å‡†åˆ™ï¼šå›é¡¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E7%90%86%E8%AE%BA%E7%9A%84%E6%9C%80%E9%87%8D%E8%A6%81%E5%BA%94%E7%94%A8"><span class="toc-number">33.8.</span> <span class="toc-text">è°ƒè¯•ç†è®ºçš„æœ€é‡è¦åº”ç”¨</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B9%B6%E5%8F%915-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%EF%BC%9A%E5%90%8C%E6%AD%A5-1-2023-3-21"><span class="toc-number">34.</span> <span class="toc-text">å¹¶å‘5_å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥ (1)_2023.3.21</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E9%97%AE%E9%A2%98"><span class="toc-number">34.1.</span> <span class="toc-text">åŒæ­¥é—®é¢˜</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5-Synchronization"><span class="toc-number">34.2.</span> <span class="toc-text">åŒæ­¥ (Synchronization)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85-%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%EF%BC%9A%E5%AD%A6%E5%BA%9F%E4%BD%A0%E5%B0%B1%E8%B5%A2%E4%BA%86"><span class="toc-number">34.3.</span> <span class="toc-text">ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ï¼šå­¦åºŸä½ å°±èµ¢äº†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E5%9B%BE%E3%80%81%E8%B0%83%E5%BA%A6%E5%99%A8%E5%92%8C%E7%94%9F%E4%BA%A7%E8%80%85-%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98"><span class="toc-number">34.4.</span> <span class="toc-text">è®¡ç®—å›¾ã€è°ƒåº¦å™¨å’Œç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85-%E6%B6%88%E8%B4%B9%E8%80%85%EF%BC%9A%E5%AE%9E%E7%8E%B0"><span class="toc-number">34.5.</span> <span class="toc-text">ç”Ÿäº§è€…-æ¶ˆè´¹è€…ï¼šå®ç°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F"><span class="toc-number">34.6.</span> <span class="toc-text">æ¡ä»¶å˜é‡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E9%97%AE%E9%A2%98%EF%BC%9A%E5%88%86%E6%9E%90"><span class="toc-number">34.7.</span> <span class="toc-text">åŒæ­¥é—®é¢˜ï¼šåˆ†æ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F%EF%BC%9A%E7%90%86%E6%83%B3%E4%B8%8E%E5%AE%9E%E7%8E%B0%E4%B9%8B%E9%97%B4%E7%9A%84%E6%8A%98%E8%A1%B7"><span class="toc-number">34.8.</span> <span class="toc-text">æ¡ä»¶å˜é‡ï¼šç†æƒ³ä¸å®ç°ä¹‹é—´çš„æŠ˜è¡·</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F%EF%BC%9A%E5%BA%94%E7%94%A8"><span class="toc-number">34.9.</span> <span class="toc-text">æ¡ä»¶å˜é‡ï¼šåº”ç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F%EF%BC%9A%E4%B8%87%E8%83%BD%E5%B9%B6%E8%A1%8C%E8%AE%A1%E7%AE%97%E6%A1%86%E6%9E%B6-M2"><span class="toc-number">34.10.</span> <span class="toc-text">æ¡ä»¶å˜é‡ï¼šä¸‡èƒ½å¹¶è¡Œè®¡ç®—æ¡†æ¶ (M2)</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('/img/image-8.png')"><div id="footer-wrap"><div class="copyright">&copy;2015 - 2025 By HUII</div><div class="footer_custom_text"><span>å¤‡æ¡ˆå·ï¼š<a href="https://beian.miit.gov.cn/" target="_blank">é—½ICPå¤‡18005042å·-2</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script><script>function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: 'ce436d2d4a3e549dad64',
      clientSecret: '9a40a66c694e77b58120d1b62b2dcee193963143',
      repo: 'huiiz.github.io',
      owner: 'huiiz',
      admin: ['huiiz'],
      id: '84764dc88b6ebb2feeddfa3f837119e3',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
    getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.textContent= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><div style="display:none;"><script type="text/javascript" src="https://v1.cnzz.com/z_stat.php?id=1279897347&web_id=1279897347"></script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>